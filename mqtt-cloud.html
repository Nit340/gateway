<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT / Cloud Integration - Univa Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        secondary: '#475569',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        surface: '#F8FAFC',
                        card: '#FFFFFF',
                        border: '#E2E8F0',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #1E293B; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 220px;
            background: white;
            border-right: 1px solid #E2E8F0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 16px;
            color: #2563EB;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 12px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748B;
            padding: 0 16px 6px;
            margin-bottom: 4px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 6px 16px;
            color: #475569;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #F8FAFC;
            color: #2563EB;
        }
        
        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            border-left-color: #2563EB;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 18px;
            margin-right: 10px;
            font-size: 13px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #E2E8F0;
            background: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #2563EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 220px;
            top: 16px;
            z-index: 100;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: none;
            border-radius: 0 4px 4px 0;
            padding: 8px 6px;
            cursor: pointer;
            color: #64748B;
            transition: all 0.3s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 14px;
        }
        
        .sidebar.collapsed {
            transform: translateX(-220px);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 220px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-220px);
                width: 220px;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 15px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
                font-size: 14px;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 220px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Compact Table Styles */
        .compact-table {
            font-size: 12px;
        }
        
        .compact-table th {
            padding: 8px 12px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .compact-table td {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 12px;
        }
        
        .status-indicator.online::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10B981;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.offline::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #EF4444;
            margin-right: 4px;
        }
        
        .status-indicator.warning::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #F59E0B;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Protocol Badges */
        .protocol-badge {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .protocol-badge.mqtt {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
        }
        
        .protocol-badge.http {
            background: #FEF3C7;
            color: #D97706;
            border: 1px solid #FDE68A;
        }
        
        .protocol-badge.aws {
            background: #F3E8FF;
            color: #7C3AED;
            border: 1px solid #E9D5FF;
        }
        
        .protocol-badge.azure {
            background: #DCFCE7;
            color: #166534;
            border: 1px solid #BBF7D0;
        }
        
        .protocol-badge.grafana {
            background: #FFE4CC;
            color: #EA580C;
            border: 1px solid #FFD9C2;
        }
        
        /* Card Styles */
        .config-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Smaller form controls */
        .compact-input {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
        }
        
        .compact-input:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .compact-select {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
        }
        
        .compact-select:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .compact-button {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CBD5E1;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10B981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        
        /* Tab Styles */
        .tab-button {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: #64748B;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: #2563EB;
            border-bottom-color: #E2E8F0;
        }
        
        .tab-button.active {
            color: #2563EB;
            border-bottom-color: #2563EB;
            font-weight: 600;
        }
        
        /* Tag selection table */
        .tag-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .tag-table tr:hover {
            background-color: #F8FAFC;
        }
        
        .tag-table th {
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .tag-table td {
            border-bottom: 1px solid #E2E8F0;
        }
        
        /* Connection Manager Styles */
        .connection-type-card {
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .connection-type-card:hover {
            border-color: #2563EB;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .connection-type-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
        }
        
        .form-section {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .form-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 12px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .key-value-list {
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .key-value-item {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #E2E8F0;
            align-items: center;
        }
        
        .key-value-item:last-child {
            border-bottom: none;
        }
        
        .key-value-item input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    
    <!-- Sidebar will be inserted here by JavaScript -->
    <div id="sidebar-container"></div>

    <!-- All existing modals remain -->
    <div id="addTagModal" class="modal">
        <!-- ... existing addTagModal content ... -->
    </div>
    
    <div id="uploadCertModal" class="modal">
        <!-- ... existing uploadCertModal content ... -->
    </div>

    <div id="testResultsModal" class="modal">
        <!-- ... existing testResultsModal content ... -->
    </div>

    <!-- NEW: Connection Manager Modal (for adding new connections) -->
    <div id="connectionManagerModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b border-slate-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-slate-900">Add New Connection</h3>
                    <button onclick="closeModal('connectionManagerModal')" class="text-slate-400 hover:text-slate-600 text-2xl">
                        &times;
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Connection Type Selection -->
                <div id="connectionTypeSelection">
                    <h4 class="text-sm font-semibold text-slate-900 mb-4">Select Connection Type</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="connectionTypesGrid"></div>
                </div>
                
                <!-- Connection Form -->
                <div id="connectionFormContainer" class="hidden">
                    <h4 id="formTitle" class="text-sm font-semibold text-slate-900 mb-6"></h4>
                    <div id="formContent" class="space-y-6 max-h-[50vh] overflow-y-auto pr-2"></div>
                    <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-slate-200">
                        <button onclick="cancelConnectionForm()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50">
                            Cancel
                        </button>
                        <button onclick="saveNewConnection()" class="compact-button bg-primary hover:bg-primaryHover text-white">
                            <i class="fa-solid fa-plus mr-1"></i> Add Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <!-- Header -->
        <header class="bg-white border-b border-border sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 h-14 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="hidden md:flex items-center text-xs text-slate-500">
                        <span><i class="fa-solid fa-cloud mr-1"></i>Protocols</span>
                        <i class="fa-solid fa-chevron-right text-xs mx-1"></i>
                        <span class="text-slate-900 font-medium">Cloud Connection Manager</span>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-xs px-2 py-1 rounded hover:bg-slate-100" onclick="cancelChanges()">
                        Cancel
                    </button>
                    <button class="bg-primary hover:bg-primaryHover text-white font-medium text-xs px-3 py-1 rounded shadow-sm flex items-center" onclick="saveAllConnections()">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6">
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-xl font-bold text-slate-900">Cloud Connection Manager</h1>
                            <p class="text-slate-500 text-xs mt-1">Configure and manage connections to various cloud services</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="showConnectionManager()" class="compact-button bg-primary hover:bg-primaryHover text-white flex items-center">
                                <i class="fa-solid fa-plus mr-1 text-xs"></i> Add Connection
                            </button>
                            <button onclick="showHelp()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 flex items-center">
                                <i class="fa-solid fa-circle-question mr-1 text-xs"></i> Help
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column: Connections List -->
                    <section class="lg:col-span-1">
                        <div class="config-card">
                            <div class="p-4 border-b border-border">
                                <h2 class="text-sm font-semibold text-slate-800 flex items-center">
                                    <i class="fa-solid fa-list mr-2 text-primary text-xs"></i> 
                                    Active Connections (<span id="connectionCount">0</span>)
                                </h2>
                            </div>
                            
                            <div class="p-3 space-y-3" id="connectionsList">
                                <!-- Connections will be dynamically loaded here -->
                                <div class="text-center py-8 text-slate-400">
                                    <i class="fa-solid fa-cloud text-3xl mb-3"></i>
                                    <p class="text-sm">No connections yet</p>
                                    <p class="text-xs mt-1">Click "Add Connection" to get started</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Right Column: Configuration -->
                    <section class="lg:col-span-2 space-y-4">
                        <!-- Connection Status Card -->
                        <div class="config-card p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-sm font-semibold text-slate-900" id="connectionName">Primary MQTT Broker</h3>
                                    <p class="text-xs text-slate-500" id="connectionDescription">Primary cloud connection for telemetry data</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-slate-700">Enabled</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked id="mqtt-enabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="grid grid-cols-4 gap-3 mb-4">
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Messages</div>
                                    <div class="text-sm font-bold text-slate-900" id="statMessages">14,593</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Errors</div>
                                    <div class="text-sm font-bold text-success" id="statErrors">0</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Last Sent</div>
                                    <div class="text-sm font-bold text-slate-900" id="statLastSent">2.3s ago</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Latency</div>
                                    <div class="text-sm font-bold text-slate-900" id="statLatency">124 ms</div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Tabs -->
                        <div class="config-card">
                            <!-- Tabs -->
                            <div class="flex border-b border-border">
                                <button onclick="switchTab('connection')" class="tab-button active" id="tab-connection">Connection</button>
                                <button onclick="switchTab('topics')" class="tab-button" id="tab-topics">Topics & Format</button>
                                <button onclick="switchTab('publishing')" class="tab-button" id="tab-publishing">Tag Publishing</button>
                                <button onclick="switchTab('advanced')" class="tab-button" id="tab-advanced">Advanced</button>
                            </div>
                            
                            <!-- Connection Settings (Tab 1) -->
                            <div id="tab-content-connection" class="p-4 space-y-6">
                                <!-- Server Configuration -->
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Broker Settings</h4>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Server URL</label>
                                                <input type="text" id="server-url" value="mqtt.example.com" class="w-full compact-input">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Port</label>
                                                <input type="number" id="server-port" value="8883" class="w-full compact-input">
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Client ID</label>
                                                <input type="text" id="client-id" value="AUTO-GENERATED" class="w-full compact-input">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Keep Alive</label>
                                                <input type="number" id="keep-alive" value="60" class="w-full compact-input">
                                                <span class="text-xs text-slate-500">seconds</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Authentication -->
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Authentication & Security</h4>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-slate-700">Use TLS/SSL</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="use-tls" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        <div class="p-3 bg-slate-50 rounded border border-slate-200 space-y-3" id="tls-settings">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-certificate text-green-600"></i>
                                                    <span class="text-xs font-medium">CA Certificate</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <button onclick="showUploadModal('uploadCertModal')" class="text-xs text-primary hover:text-primaryHover">
                                                        <i class="fa-solid fa-upload"></i> Upload
                                                    </button>
                                                    <span class="text-xs text-slate-500 px-2 py-1 bg-white rounded border">Uploaded</span>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-key text-blue-600"></i>
                                                    <span class="text-xs font-medium">Client Certificate</span>
                                                </div>
                                                <div class="flex items-center gap-1">
                                                    <button onclick="showUploadModal('uploadCertModal')" class="text-xs text-primary hover:text-primaryHover">
                                                        <i class="fa-solid fa-upload"></i> Upload
                                                    </button>
                                                    <button class="text-xs text-red-600 hover:text-red-700">
                                                        <i class="fa-solid fa-trash"></i> Remove
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <i class="fa-solid fa-lock text-purple-600"></i>
                                                    <span class="text-xs font-medium">Private Key</span>
                                                </div>
                                                <button onclick="showUploadModal('uploadCertModal')" class="text-xs text-primary hover:text-primaryHover">
                                                    <i class="fa-solid fa-upload"></i> Upload Key
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Username</label>
                                                <input type="text" id="username" value="admin" class="w-full compact-input">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Password</label>
                                                <input type="password" id="password" value="********" class="w-full compact-input">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- MQTT Options -->
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">MQTT Options</h4>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 mb-1">QoS Level</label>
                                            <div class="flex space-x-4">
                                                <label class="flex items-center">
                                                    <input type="radio" name="qos" value="0" class="mr-1">
                                                    <span class="text-xs">0</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="qos" value="1" checked class="mr-1">
                                                    <span class="text-xs">1</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="qos" value="2" class="mr-1">
                                                    <span class="text-xs">2</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 mb-1">Clean Session</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="clean-session" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="pt-4 border-t border-slate-200">
                                    <div class="flex space-x-2">
                                        <button onclick="testConnection()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 flex items-center">
                                            <i class="fa-solid fa-bolt mr-1"></i> Test Connection
                                        </button>
                                        <button onclick="saveBrokerSettings()" class="compact-button bg-primary hover:bg-primaryHover text-white flex items-center">
                                            <i class="fa-solid fa-save mr-1"></i> Save Broker Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Topics & Format (Tab 2) -->
                            <div id="tab-content-topics" class="p-4 space-y-6" style="display: none;">
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Topic Configuration</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 mb-1">Base Topic</label>
                                            <input type="text" id="base-topic" value="univa/crane/${DEVICE_ID}" class="w-full compact-input font-mono text-xs">
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Data Topic</label>
                                                <input type="text" id="data-topic" value="univa/crane/${DEVICE_ID}/data" class="w-full compact-input font-mono text-xs">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Status Topic</label>
                                                <input type="text" id="status-topic" value="univa/crane/${DEVICE_ID}/status" class="w-full compact-input font-mono text-xs">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Event Topic</label>
                                                <input type="text" id="event-topic" value="univa/crane/${DEVICE_ID}/event" class="w-full compact-input font-mono text-xs">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-1">Command Topic</label>
                                                <input type="text" id="command-topic" value="univa/crane/${DEVICE_ID}/cmd" class="w-full compact-input font-mono text-xs">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Payload Format -->
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Payload Format</h4>
                                    <div class="space-y-3">
                                        <div class="flex space-x-4 mb-3">
                                            <label class="flex items-center">
                                                <input type="radio" name="payload-format" value="json" checked class="mr-1">
                                                <span class="text-xs">JSON</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="payload-format" value="key-value" class="mr-1">
                                                <span class="text-xs">Key-Value Pairs</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="payload-format" value="raw" class="mr-1">
                                                <span class="text-xs">Raw Binary</span>
                                            </label>
                                        </div>
                                        
                                        <!-- JSON Preview -->
                                        <div class="bg-slate-900 rounded border border-slate-800 p-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-xs font-medium text-slate-300">Payload Preview</span>
                                                <span class="text-xs text-slate-500">JSON Format</span>
                                            </div>
                                            <pre class="text-xs text-slate-300 font-mono overflow-x-auto" id="json-preview">
{
  "device_id": "CRN001",
  "timestamp": 1736004933,
  "Hoist_Load": 18.5,
  "Boom_Angle": 45,
  "WindSpeed": 12
}</pre>
                                        </div>
                                        
                                        <div class="text-xs text-slate-500">
                                            <p class="font-medium mb-1">Available Variables:</p>
                                            <div class="flex flex-wrap gap-1">
                                                <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">${DEVICE_ID}</span>
                                                <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">${TIMESTAMP}</span>
                                                <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">${GATEWAY_ID}</span>
                                                <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">${TAG_NAME}</span>
                                                <span class="px-2 py-1 bg-slate-100 rounded border border-slate-200">${VALUE}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-slate-200">
                                    <button onclick="saveTopicSettings()" class="compact-button bg-primary hover:bg-primaryHover text-white">
                                        Save Topic Settings
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tag Publishing (Tab 3) -->
                            <div id="tab-content-publishing" class="p-4 space-y-6" style="display: none;">
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Tag Publishing Rules</h4>
                                    
                                    <div class="space-y-3 mb-4">
                                        <div class="flex items-center space-x-4">
                                            <label class="flex items-center">
                                                <input type="radio" name="publish-mode" value="all" class="mr-1">
                                                <span class="text-xs">Publish All Tags</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="publish-mode" value="selected" checked class="mr-1">
                                                <span class="text-xs">Publish Selected Tags</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="publish-mode" value="custom" class="mr-1">
                                                <span class="text-xs">Custom Tag Sets</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Tag Selection Table -->
                                    <div class="mb-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-xs font-medium text-slate-700">Selected Tags (4)</span>
                                            <div class="flex space-x-2">
                                                <button onclick="showAddTagModal()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 text-xs flex items-center">
                                                    <i class="fa-solid fa-plus mr-1"></i> Add Tags
                                                </button>
                                                <button onclick="removeSelectedTags()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 text-xs flex items-center">
                                                    <i class="fa-solid fa-trash mr-1"></i> Remove Selected
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="border border-slate-200 rounded overflow-hidden">
                                            <table class="tag-table w-full">
                                                <thead class="bg-slate-50">
                                                    <tr>
                                                        <th class="p-2 w-8">
                                                            <input type="checkbox">
                                                        </th>
                                                        <th class="p-2">Tag Name</th>
                                                        <th class="p-2">Group</th>
                                                        <th class="p-2">Publish</th>
                                                        <th class="p-2">Filter</th>
                                                        <th class="p-2">Poll Rate</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="p-2 text-center">
                                                            <input type="checkbox">
                                                        </td>
                                                        <td class="p-2 font-mono text-xs">Hoist_Load</td>
                                                        <td class="p-2">
                                                            <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">Load</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">Δ > 0.5</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">200ms</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="p-2 text-center">
                                                            <input type="checkbox">
                                                        </td>
                                                        <td class="p-2 font-mono text-xs">Boom_Angle</td>
                                                        <td class="p-2">
                                                            <span class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Angle</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">Δ > 0.2</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">100ms</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="p-2 text-center">
                                                            <input type="checkbox">
                                                        </td>
                                                        <td class="p-2 font-mono text-xs">WindSpeed</td>
                                                        <td class="p-2">
                                                            <span class="px-2 py-1 bg-yellow-50 text-yellow-700 rounded text-xs">Weather</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">Periodic 1s</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">1s</span>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="p-2 text-center">
                                                            <input type="checkbox">
                                                        </td>
                                                        <td class="p-2 font-mono text-xs">Motor_Temp</td>
                                                        <td class="p-2">
                                                            <span class="px-2 py-1 bg-red-50 text-red-700 rounded text-xs">Motor</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">Periodic 2s</span>
                                                        </td>
                                                        <td class="p-2">
                                                            <span class="text-xs">2s</span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <!-- Publishing Options -->
                                    <div>
                                        <h5 class="text-xs font-semibold text-slate-900 mb-3">Publishing Options</h5>
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-2">Publish Mode</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="radio" name="publish-trigger" value="on-change" checked class="mr-1">
                                                        <span class="text-xs">On Change</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" name="publish-trigger" value="periodic" class="mr-1">
                                                        <span class="text-xs">Periodic</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" name="publish-trigger" value="event-only" class="mr-1">
                                                        <span class="text-xs">Event Only</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-700 mb-2">Batching Options</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="checkbox" id="enable-batching" class="mr-1">
                                                        <span class="text-xs">Enable Batching</span>
                                                    </label>
                                                    <div class="ml-6">
                                                        <label class="block text-xs font-medium text-slate-700 mb-1">Batch Size</label>
                                                        <input type="number" id="batch-size" value="10" class="w-full compact-input" disabled>
                                                        <span class="text-xs text-slate-500">tags per message</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-slate-200">
                                    <button onclick="savePublishingRules()" class="compact-button bg-primary hover:bg-primaryHover text-white">
                                        Save Publishing Rules
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Advanced (Tab 4) -->
                            <div id="tab-content-advanced" class="p-4 space-y-6" style="display: none;">
                                <div>
                                    <h4 class="text-xs font-semibold text-slate-900 mb-3">Advanced Options</h4>
                                    
                                    <div class="space-y-4">
                                        <!-- Compression -->
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="text-xs font-medium text-slate-700">Compression (gzip)</span>
                                                <p class="text-xs text-slate-500">Compress payloads for low-bandwidth mode</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="compression-enabled">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        <!-- Timestamp Sync -->
                                        <div>
                                            <label class="block text-xs font-medium text-slate-700 mb-2">Timestamp Format</label>
                                            <div class="flex space-x-4">
                                                <label class="flex items-center">
                                                    <input type="radio" name="timestamp-format" value="utc" checked class="mr-1">
                                                    <span class="text-xs">UTC</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="timestamp-format" value="local" class="mr-1">
                                                    <span class="text-xs">Local Time</span>
                                                </label>
                                                <label class="flex items-center">
                                                    <input type="radio" name="timestamp-format" value="epoch" class="mr-1">
                                                    <span class="text-xs">Epoch Milliseconds</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- Offline Buffer -->
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <span class="text-xs font-medium text-slate-700">Offline Buffer (Store & Forward)</span>
                                                <p class="text-xs text-slate-500">Store messages when connection is lost</p>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="offline-buffer-enabled" checked>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        <!-- Buffer Settings -->
                                        <div class="ml-6 space-y-2" id="buffer-settings">
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-xs font-medium text-slate-700 mb-1">Queue Size</label>
                                                    <input type="number" id="queue-size" value="1000" class="w-full compact-input">
                                                    <span class="text-xs text-slate-500">messages</span>
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-slate-700 mb-1">Retention Period</label>
                                                    <input type="number" id="retention-period" value="24" class="w-full compact-input">
                                                    <span class="text-xs text-slate-500">hours</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Last Will & Testament -->
                                        <div class="pt-2">
                                            <h5 class="text-xs font-semibold text-slate-900 mb-3">Last Will & Testament</h5>
                                            <div class="space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs font-medium text-slate-700">Enable LWT</span>
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="lwt-enabled">
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                                
                                                <div class="ml-6 space-y-2" id="lwt-settings" style="display: none;">
                                                    <div>
                                                        <label class="block text-xs font-medium text-slate-700 mb-1">Will Topic</label>
                                                        <input type="text" id="will-topic" value="gateway/status" class="w-full compact-input">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-medium text-slate-700 mb-1">Will Message</label>
                                                        <input type="text" id="will-message" value='{"status": "offline"}' class="w-full compact-input">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t border-slate-200">
                                    <button onclick="saveAdvancedSettings()" class="compact-button bg-primary hover:bg-primaryHover text-white">
                                        Save Advanced Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Monitor -->
                        <div class="config-card p-4">
                            <h4 class="text-xs font-semibold text-slate-900 mb-3">Connection Diagnostics</h4>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <!-- Status Panel -->
                                <div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Status:</span>
                                            <span class="status-indicator online">Connected</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Last Message Published:</span>
                                            <span class="text-xs font-mono text-slate-900">2.3 sec ago</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Packets Sent:</span>
                                            <span class="text-xs font-mono text-slate-900">14,593</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Packets Received:</span>
                                            <span class="text-xs font-mono text-slate-900">129</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Last Error:</span>
                                            <span class="text-xs font-mono text-green-600">None</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Round-trip Latency:</span>
                                            <span class="text-xs font-mono text-slate-900">124 ms</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Downlink Commands -->
                                <div>
                                    <h5 class="text-xs font-medium text-slate-700 mb-2">Recent Downlink Commands</h5>
                                    <div class="border border-slate-200 rounded overflow-hidden">
                                        <table class="w-full text-xs">
                                            <thead class="bg-slate-50">
                                                <tr>
                                                    <th class="p-2 text-left">Timestamp</th>
                                                    <th class="p-2 text-left">Command</th>
                                                    <th class="p-2 text-left">Result</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:43:12</td>
                                                    <td class="p-2 font-mono">SetSpeed=12</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Accepted</span>
                                                    </td>
                                                </tr>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:41:04</td>
                                                    <td class="p-2 font-mono">ResetWarning</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-red-50 text-red-700 rounded text-xs">Failed</span>
                                                    </td>
                                                </tr>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:38:55</td>
                                                    <td class="p-2 font-mono">GetStatus</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Accepted</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div> <!-- End of main content container -->

    <script>
        // Load configuration from config.json
        const config = {
            "app": {
                "name": "Univa IoT Gateway",
                "version": "2.4.1",
                "maxConnections": 12
            },
            
            "connectionTypes": {
                "mqtt": {
                    "name": "MQTT Broker",
                    "description": "Standard IoT messaging protocol",
                    "icon": "fa-solid fa-cloud",
                    "color": "blue",
                    "defaultName": "MQTT Broker",
                    "form": {
                        "sections": [
                            {
                                "title": "Broker Configuration",
                                "fields": [
                                    {
                                        "type": "select",
                                        "id": "protocol",
                                        "label": "Protocol",
                                        "default": "mqtts://",
                                        "options": [
                                            {"value": "mqtt://", "label": "MQTT"},
                                            {"value": "mqtts://", "label": "MQTTS (SSL)"},
                                            {"value": "tcp://", "label": "TCP"},
                                            {"value": "ws://", "label": "WebSocket"},
                                            {"value": "wss://", "label": "WebSocket Secure"}
                                        ],
                                        "required": true
                                    },
                                    {
                                        "type": "text",
                                        "id": "host",
                                        "label": "Broker Hostname",
                                        "default": "broker.company.com",
                                        "required": true
                                    },
                                    {
                                        "type": "number",
                                        "id": "port",
                                        "label": "Port",
                                        "default": 8883,
                                        "required": true
                                    }
                                ]
                            }
                        ]
                    }
                },
                
                "http": {
                    "name": "HTTP Endpoint",
                    "description": "REST API endpoints",
                    "icon": "fa-solid fa-globe",
                    "color": "yellow",
                    "defaultName": "HTTP API"
                },
                
                "aws": {
                    "name": "AWS IoT Core",
                    "description": "Amazon Web Services IoT",
                    "icon": "fa-brands fa-aws",
                    "color": "purple",
                    "defaultName": "AWS IoT"
                },
                
                "azure": {
                    "name": "Azure IoT Hub",
                    "description": "Microsoft Azure IoT",
                    "icon": "fa-brands fa-microsoft",
                    "color": "blue",
                    "defaultName": "Azure IoT Hub"
                },
                
                "grafana": {
                    "name": "Grafana Cloud",
                    "description": "Monitoring & Dashboards",
                    "icon": "fa-solid fa-chart-line",
                    "color": "orange",
                    "defaultName": "Grafana Cloud"
                }
            },
            
            "defaultStats": {
                "messages": 0,
                "errors": 0,
                "latency": 0,
                "uptime": "0h 0m",
                "lastActive": "Never",
                "bandwidth": "0 MB",
                "successRate": "0%"
            },
            
            "defaultConnections": {
                "mqtt": {
                    "id": "mqtt-primary",
                    "type": "mqtt",
                    "name": "Production MQTT Broker",
                    "enabled": true,
                    "config": {
                        "protocol": "mqtts://",
                        "host": "broker.company.com",
                        "port": 8883
                    },
                    "stats": {
                        "messages": 8953,
                        "errors": 0,
                        "latency": 95,
                        "uptime": "8h 12m",
                        "lastActive": "2.3s ago",
                        "bandwidth": "2.4 MB",
                        "successRate": "99.8%"
                    }
                },
                "http": {
                    "id": "http-analytics",
                    "type": "http",
                    "name": "Analytics API",
                    "enabled": true,
                    "config": {
                        "url": "https://api.company.com/v1/data"
                    },
                    "stats": {
                        "messages": 3245,
                        "errors": 12,
                        "latency": 210,
                        "uptime": "1h 45m",
                        "lastActive": "5 min ago",
                        "bandwidth": "1.2 MB",
                        "successRate": "99.6%"
                    }
                },
                "aws": {
                    "id": "aws-iot",
                    "type": "aws",
                    "name": "AWS IoT Core",
                    "enabled": true,
                    "config": {
                        "endpoint": "a3qj7x...iot.us-east-1.amazonaws.com"
                    },
                    "stats": {
                        "messages": 1523,
                        "errors": 3,
                        "latency": 145,
                        "uptime": "3h 22m",
                        "lastActive": "1.2s ago",
                        "bandwidth": "0.8 MB",
                        "successRate": "99.8%"
                    }
                }
            }
        };

        // Global state
        let connections = {};
        let selectedConnectionId = null;
        let selectedConnectionType = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load sidebar first
            loadSidebar();
            
            // Initialize app functions
            initializeApp();
            loadConnections();
            renderConnectionTypes();
            
            // Select the first connection by default
            if (Object.keys(connections).length > 0) {
                const firstId = Object.keys(connections)[0];
                selectConnection(firstId);
            }
        });

        // Fetch and insert sidebar from sidebar.html
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) {
                    throw new Error(`Failed to load sidebar: ${response.status}`);
                }
                
                const html = await response.text();
                
                // Insert the entire HTML content
                document.getElementById('sidebar-container').innerHTML = html;
                
                // Update the active page to MQTT / Cloud
                updateActivePage();
                
                // Initialize sidebar functionality
                initializeSidebar();
                
            } catch (error) {
                console.error('Error loading sidebar:', error);
                // Fallback: create a basic sidebar if fetch fails
                createFallbackSidebar();
            }
        }

        // Create fallback sidebar if fetch fails
        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-satellite-dish mr-2"></i> Univa IoT
                        </div>
                    </div>
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i>
                                General
                            </a>
                            <a href="device-management.html" class="nav-item">
                                <i class="fa-solid fa-microchip"></i>
                                Devices
                            </a>
                        </div>
                        
                        <div class="nav-section">
                            <div class="section-title">Protocols</div>
                            <a href="protocol-mapping.html" class="nav-item">
                                <i class="fa-solid fa-plug"></i>
                                Protocol Mapping
                            </a>
                            <a href="mqtt-cloud.html" class="nav-item active">
                                <i class="fa-solid fa-cloud"></i>
                                MQTT / Cloud
                            </a>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4 class="text-sm font-medium text-slate-900">Admin User</h4>
                                <p class="text-xs text-slate-500">System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }

        // Update active page in sidebar
        function updateActivePage() {
            // Remove active class from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to MQTT / Cloud
            const mqttLink = Array.from(navItems).find(item => 
                item.textContent.includes('MQTT / Cloud') || 
                item.textContent.includes('Cloud Connection')
            );
            
            if (mqttLink) {
                mqttLink.classList.add('active');
            }
        }

        // Initialize sidebar functionality
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (!sidebar || !sidebarToggle) return;
            
            // Toggle sidebar
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                
                // Toggle icon
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.className = 'fa-solid fa-times';
                } else {
                    icon.className = 'fa-solid fa-bars';
                }
            });
            
            // Handle mobile menu
            if (window.innerWidth <= 1024) {
                sidebar.classList.add('active');
                sidebarToggle.style.left = '220px';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-times';
            }
            
            // Update on resize
            window.addEventListener('resize', handleResponsive);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', handleSidebarClickOutside);
        }

        // Close sidebar when clicking outside on mobile
        function handleSidebarClickOutside(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile && sidebar.classList.contains('active')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                    sidebarToggle.style.left = '0';
                }
            }
        }

        // Handle responsive behavior
        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '220px';
            }
        }

        function initializeApp() {
            // Setup event listeners
            setupEventListeners();
            setupToggles();
            
            // Initialize tab states
            updatePayloadPreview();
        }

        function setupEventListeners() {
            // TLS toggle
            document.getElementById('use-tls').addEventListener('change', function() {
                const tlsSettings = document.getElementById('tls-settings');
                if (this.checked) {
                    tlsSettings.style.display = 'block';
                } else {
                    tlsSettings.style.display = 'none';
                }
            });
            
            // Batching toggle
            document.getElementById('enable-batching').addEventListener('change', function() {
                const batchSize = document.getElementById('batch-size');
                batchSize.disabled = !this.checked;
            });
            
            // Offline buffer toggle
            document.getElementById('offline-buffer-enabled').addEventListener('change', function() {
                const bufferSettings = document.getElementById('buffer-settings');
                if (this.checked) {
                    bufferSettings.style.display = 'block';
                } else {
                    bufferSettings.style.display = 'none';
                }
            });
            
            // LWT toggle
            document.getElementById('lwt-enabled').addEventListener('change', function() {
                const lwtSettings = document.getElementById('lwt-settings');
                if (this.checked) {
                    lwtSettings.style.display = 'block';
                } else {
                    lwtSettings.style.display = 'none';
                }
            });
            
            // Payload format change
            document.querySelectorAll('input[name="payload-format"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePayloadPreview();
                });
            });
        }
        
        function setupToggles() {
            // Setup all toggle switches
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const label = this.nextElementSibling;
                    if (this.checked) {
                        label.style.backgroundColor = '#10B981';
                    } else {
                        label.style.backgroundColor = '#CBD5E1';
                    }
                });
            });
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Connection Manager Functions (for left panel only)
        function showConnectionManager() {
            showModal('connectionManagerModal');
            showConnectionTypeSelection();
        }

        function showConnectionTypeSelection() {
            document.getElementById('connectionTypeSelection').classList.remove('hidden');
            document.getElementById('connectionFormContainer').classList.add('hidden');
            selectedConnectionType = null;
        }

        function renderConnectionTypes() {
            const grid = document.getElementById('connectionTypesGrid');
            grid.innerHTML = '';
            
            Object.entries(config.connectionTypes).forEach(([type, connectionConfig]) => {
                const card = document.createElement('div');
                card.className = 'connection-type-card';
                card.onclick = () => selectConnectionType(type);
                
                const colorMap = {
                    blue: '#3B82F6',
                    yellow: '#F59E0B',
                    purple: '#8B5CF6',
                    orange: '#F97316'
                };
                
                const color = colorMap[connectionConfig.color] || '#3B82F6';
                
                card.innerHTML = `
                    <div class="connection-type-icon" style="background-color: ${color}20; color: ${color};">
                        <i class="${connectionConfig.icon}"></i>
                    </div>
                    <h4 class="font-semibold text-slate-900 text-sm mb-2">${connectionConfig.name}</h4>
                    <p class="text-xs text-slate-600">${connectionConfig.description}</p>
                `;
                
                grid.appendChild(card);
            });
        }

        function selectConnectionType(type) {
            selectedConnectionType = type;
            const connectionConfig = config.connectionTypes[type];
            
            document.getElementById('formTitle').textContent = `Configure ${connectionConfig.name}`;
            document.getElementById('connectionTypeSelection').classList.add('hidden');
            document.getElementById('connectionFormContainer').classList.remove('hidden');
            
            renderConnectionForm(type);
        }

        function renderConnectionForm(type) {
            const formContent = document.getElementById('formContent');
            const connectionConfig = config.connectionTypes[type];
            
            if (!connectionConfig.form) {
                formContent.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i class="fa-solid fa-cogs text-3xl mb-3"></i>
                        <p>Configuration form for ${connectionConfig.name} coming soon</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            connectionConfig.form.sections.forEach((section) => {
                html += `
                    <div class="form-section">
                        <h5 class="form-section-title">${section.title}</h5>
                        <div class="space-y-4">
                `;
                
                section.fields.forEach(field => {
                    html += renderFormField(field);
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            formContent.innerHTML = html;
        }

        function renderFormField(field) {
            const fieldId = `field-${field.id}`;
            const required = field.required ? 'required' : '';
            const placeholder = field.placeholder || '';
            
            // Process default value
            let defaultValue = field.default || '';
            if (typeof defaultValue === 'string' && defaultValue.includes('${randomId}')) {
                defaultValue = defaultValue.replace('${randomId}', generateRandomId(6));
            }
            
            switch(field.type) {
                case 'text':
                    return `
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">${field.label}</label>
                            <input type="text" id="${fieldId}" 
                                   class="w-full compact-input"
                                   value="${defaultValue}"
                                   placeholder="${placeholder}"
                                   ${required}>
                            ${field.help ? `<p class="text-xs text-slate-500 mt-1">${field.help}</p>` : ''}
                        </div>
                    `;
                    
                case 'password':
                    return `
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">${field.label}</label>
                            <input type="password" id="${fieldId}"
                                   class="w-full compact-input"
                                   value="${defaultValue}"
                                   placeholder="${placeholder}"
                                   ${required}>
                            ${field.help ? `<p class="text-xs text-slate-500 mt-1">${field.help}</p>` : ''}
                        </div>
                    `;
                    
                case 'number':
                    return `
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">${field.label}</label>
                            <input type="number" id="${fieldId}"
                                   class="w-full compact-input"
                                   value="${defaultValue}"
                                   min="${field.min || ''}"
                                   max="${field.max || ''}"
                                   ${required}>
                            ${field.help ? `<p class="text-xs text-slate-500 mt-1">${field.help}</p>` : ''}
                        </div>
                    `;
                    
                case 'select':
                    const options = field.options.map(opt => {
                        const isSelected = String(opt.value) === String(defaultValue) ? 'selected' : '';
                        const label = typeof opt === 'object' ? opt.label : opt;
                        const value = typeof opt === 'object' ? opt.value : opt;
                        return `<option value="${value}" ${isSelected}>${label}</option>`;
                    }).join('');
                    
                    return `
                        <div>
                            <label class="block text-xs font-medium text-slate-700 mb-1">${field.label}</label>
                            <select id="${fieldId}"
                                    class="w-full compact-select"
                                    ${required}>
                                ${options}
                            </select>
                            ${field.help ? `<p class="text-xs text-slate-500 mt-1">${field.help}</p>` : ''}
                        </div>
                    `;
                    
                default:
                    return `<div class="text-slate-500 text-xs">Field type "${field.type}" not supported</div>`;
            }
        }

        function cancelConnectionForm() {
            showConnectionTypeSelection();
        }

        function saveNewConnection() {
            if (!selectedConnectionType) return;
            
            const connectionConfig = config.connectionTypes[selectedConnectionType];
            const formData = collectFormData();
            
            // Create connection ID
            const connectionId = `${selectedConnectionType}-${Date.now()}`;
            
            // Create connection object
            connections[connectionId] = {
                id: connectionId,
                type: selectedConnectionType,
                name: connectionConfig.defaultName,
                enabled: true,
                config: formData,
                stats: {...config.defaultStats}
            };
            
            // Add to UI
            addConnectionToList(connectionId, connections[connectionId]);
            
            // Close modal
            closeModal('connectionManagerModal');
            
            // Show notification
            showNotification(`${connectionConfig.name} added successfully`, 'success');
            
            // Select the new connection
            selectConnection(connectionId);
        }

        function collectFormData() {
            const formData = {};
            const connectionConfig = config.connectionTypes[selectedConnectionType];
            
            if (!connectionConfig.form) return formData;
            
            connectionConfig.form.sections.forEach(section => {
                section.fields.forEach(field => {
                    const element = document.getElementById(`field-${field.id}`);
                    if (element) {
                        formData[field.id] = element.value;
                    }
                });
            });
            
            return formData;
        }

        function loadConnections() {
            // Load default connections
            Object.values(config.defaultConnections).forEach(conn => {
                connections[conn.id] = conn;
                addConnectionToList(conn.id, conn);
            });
            
            updateConnectionCount();
        }

        function addConnectionToList(id, conn) {
            const list = document.getElementById('connectionsList');
            const connectionConfig = config.connectionTypes[conn.type];
            
            // Check if already exists
            if (document.querySelector(`[data-connection-id="${id}"]`)) {
                updateConnectionItem(id, conn);
                return;
            }
            
            // Remove placeholder if exists
            const placeholder = list.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const colorMap = {
                blue: 'border-blue-500 text-blue-600',
                yellow: 'border-yellow-500 text-yellow-600',
                purple: 'border-purple-500 text-purple-600',
                orange: 'border-orange-500 text-orange-600'
            };
            
            const colorClass = colorMap[connectionConfig.color] || 'border-blue-500 text-blue-600';
            
            const html = `
                <div data-connection-id="${id}" class="border-l-4 ${colorClass.split(' ')[0]} p-3 bg-white border ${selectedConnectionId === id ? 'border-blue-200 bg-blue-50' : 'border-slate-200'} rounded-lg cursor-pointer hover:border-blue-200 transition-colors" onclick="selectConnection('${id}')">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="${connectionConfig.icon} ${colorClass.split(' ')[1]}"></i>
                            <span class="font-medium text-slate-900 text-sm">${conn.name}</span>
                        </div>
                        <span class="text-xs text-slate-500">${conn.stats.lastActive}</span>
                    </div>
                    <div class="text-xs text-slate-600 truncate mb-2">${getConnectionSummary(conn)}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-2 py-1 rounded ${conn.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${conn.enabled ? 'Active' : 'Inactive'}
                        </span>
                        <span class="text-xs font-medium">${conn.stats.messages.toLocaleString()} msgs</span>
                    </div>
                </div>
            `;
            
            list.insertAdjacentHTML('afterbegin', html);
            updateConnectionCount();
        }

        function updateConnectionItem(id, conn) {
            const item = document.querySelector(`[data-connection-id="${id}"]`);
            if (!item) return;
            
            const connectionConfig = config.connectionTypes[conn.type];
            const colorMap = {
                blue: 'text-blue-600',
                yellow: 'text-yellow-600',
                purple: 'text-purple-600',
                orange: 'text-orange-600'
            };
            
            const iconClass = colorMap[connectionConfig.color] || 'text-blue-600';
            
            item.querySelector('i').className = `${connectionConfig.icon} ${iconClass}`;
            item.querySelector('.font-medium').textContent = conn.name;
            item.querySelector('.text-xs.text-slate-500').textContent = conn.stats.lastActive;
            item.querySelector('.text-slate-600').textContent = getConnectionSummary(conn);
            item.querySelector('.bg-green-100, .bg-gray-100').className = conn.enabled ? 'text-xs px-2 py-1 rounded bg-green-100 text-green-800' : 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-800';
            item.querySelector('.bg-green-100, .bg-gray-100').textContent = conn.enabled ? 'Active' : 'Inactive';
            item.querySelector('.font-medium:last-child').textContent = `${conn.stats.messages.toLocaleString()} msgs`;
        }

        function getConnectionSummary(conn) {
            if (conn.type === 'mqtt' && conn.config.host) {
                const protocol = conn.config.protocol || 'mqtt://';
                const port = conn.config.port || (protocol.includes('mqtts') ? 8883 : 1883);
                return `${protocol}${conn.config.host}:${port}`;
            }
            if (conn.config.url) return conn.config.url;
            if (conn.config.endpoint) return conn.config.endpoint;
            if (conn.config.hostname) return conn.config.hostname;
            return `${config.connectionTypes[conn.type]?.name} Connection`;
        }

        function selectConnection(id) {
            selectedConnectionId = id;
            const conn = connections[id];
            
            if (!conn) return;
            
            // Update UI in left panel
            document.querySelectorAll('[data-connection-id]').forEach(el => {
                el.classList.remove('border-blue-200', 'bg-blue-50');
                el.classList.add('border-slate-200');
            });
            
            const selectedEl = document.querySelector(`[data-connection-id="${id}"]`);
            if (selectedEl) {
                selectedEl.classList.add('border-blue-200', 'bg-blue-50');
                selectedEl.classList.remove('border-slate-200');
            }
            
            // Update main configuration area based on connection type
            updateConfigurationForConnection(conn);
        }

        function updateConfigurationForConnection(conn) {
            const connectionConfig = config.connectionTypes[conn.type];
            
            // Update header information
            document.getElementById('connectionName').textContent = conn.name;
            document.getElementById('connectionDescription').textContent = `${connectionConfig.name} - ${connectionConfig.description}`;
            
            // Update stats
            document.getElementById('statMessages').textContent = conn.stats.messages.toLocaleString();
            document.getElementById('statErrors').textContent = conn.stats.errors;
            document.getElementById('statLastSent').textContent = conn.stats.lastActive;
            document.getElementById('statLatency').textContent = conn.stats.latency + ' ms';
            
            // For MQTT connections, update form fields with saved config
            if (conn.type === 'mqtt' && conn.config) {
                if (conn.config.host) {
                    document.getElementById('server-url').value = conn.config.host;
                }
                if (conn.config.port) {
                    document.getElementById('server-port').value = conn.config.port;
                }
                if (conn.config.protocol && conn.config.protocol.includes('mqtts')) {
                    document.getElementById('use-tls').checked = true;
                }
            }
            
            // Show/hide tabs based on connection type
            // MQTT gets all tabs, others get limited tabs
            if (conn.type === 'mqtt') {
                document.querySelectorAll('.tab-button').forEach(tab => {
                    tab.style.display = 'block';
                });
                // Switch to connection tab by default
                switchTab('connection');
            } else {
                // For non-MQTT connections, only show connection tab
                document.querySelectorAll('.tab-button').forEach(tab => {
                    if (tab.id === 'tab-connection') {
                        tab.style.display = 'block';
                        tab.classList.add('active');
                    } else {
                        tab.style.display = 'none';
                        tab.classList.remove('active');
                    }
                });
                // Hide all tab contents except connection
                document.querySelectorAll('[id^="tab-content-"]').forEach(tab => {
                    if (tab.id === 'tab-content-connection') {
                        tab.style.display = 'block';
                    } else {
                        tab.style.display = 'none';
                    }
                });
            }
        }

        function updateConnectionCount() {
            const count = Object.keys(connections).length;
            document.getElementById('connectionCount').textContent = count;
            
            if (count === 0) {
                document.getElementById('connectionsList').innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <i class="fa-solid fa-cloud text-3xl mb-3"></i>
                        <p class="text-sm">No connections yet</p>
                        <p class="text-xs mt-1">Click "Add Connection" to get started</p>
                    </div>
                `;
            }
        }

        // Helper functions
        function generateRandomId(length = 6) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 border-green-200 text-green-800',
                error: 'bg-red-100 border-red-200 text-red-800',
                info: 'bg-blue-100 border-blue-200 text-blue-800',
                warning: 'bg-yellow-100 border-yellow-200 text-yellow-800'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border ${colors[type]} shadow-lg z-50 text-sm`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // KEEP ALL EXISTING FUNCTIONS FROM ORIGINAL MQTT PAGE
        function showAddTagModal() {
            document.getElementById('addTagModal').classList.add('active');
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('[id^="tab-content-"]').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function addSelectedTags() {
            // In a real app, this would add the selected tags to the table
            const modal = document.getElementById('addTagModal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxes.length > 0) {
                alert(`${checkboxes.length} tags added successfully!`);
                closeModal('addTagModal');
                
                // Reset checkboxes
                modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            } else {
                alert('Please select at least one tag to add.');
            }
        }
        
        function removeSelectedTags() {
            const selected = document.querySelectorAll('.tag-table input[type="checkbox"]:checked');
            
            if (selected.length > 0) {
                if (confirm(`Remove ${selected.length} selected tags?`)) {
                    // In a real app, this would remove the selected rows
                    alert(`${selected.length} tags removed successfully!`);
                    
                    // Uncheck all checkboxes
                    document.querySelectorAll('.tag-table input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                }
            } else {
                alert('Please select tags to remove.');
            }
        }
        
        function saveBrokerSettings() {
            const currentConn = connections[selectedConnectionId];
            if (currentConn && currentConn.type === 'mqtt') {
                // Update connection config with form values
                currentConn.config.host = document.getElementById('server-url').value;
                currentConn.config.port = document.getElementById('server-port').value;
                
                showNotification('Broker settings saved successfully!', 'success');
                updateConnectionItem(selectedConnectionId, currentConn);
            } else {
                showNotification('Settings saved!', 'success');
            }
        }
        
        function saveTopicSettings() {
            showNotification('Topic settings saved successfully!', 'success');
        }
        
        function savePublishingRules() {
            showNotification('Publishing rules saved successfully!', 'success');
        }
        
        function saveAdvancedSettings() {
            showNotification('Advanced settings saved successfully!', 'success');
        }
        
        function saveConfiguration() {
            showNotification('All configuration saved successfully!', 'success');
        }
        
        function saveAllConnections() {
            showNotification('All connections saved successfully!', 'success');
        }
        
        function testConnection() {
            const currentConn = connections[selectedConnectionId];
            if (!currentConn) {
                showNotification('Please select a connection first', 'warning');
                return;
            }
            
            showNotification(`Testing ${currentConn.name} connection...`, 'info');
            
            setTimeout(() => {
                // Update stats
                currentConn.stats.messages += Math.floor(Math.random() * 100);
                currentConn.stats.lastActive = 'Just now';
                currentConn.stats.latency = Math.floor(Math.random() * 200);
                currentConn.stats.successRate = `${98 + Math.floor(Math.random() * 2)}%`;
                
                updateConnectionItem(selectedConnectionId, currentConn);
                updateConfigurationForConnection(currentConn);
                
                showNotification(`Connection test for ${currentConn.name} successful!`, 'success');
            }, 1500);
        }
        
        function viewLogs() {
            alert('Opening connection logs...');
        }
        
        function resetToDefaults() {
            if (confirm('Reset all settings to default values?')) {
                location.reload();
            }
        }
        
        function cancelChanges() {
            if (confirm('Discard all unsaved changes?')) {
                location.reload();
            }
        }
        
        function showHelp() {
            alert('Cloud Connection Manager Help:\n\n1. Click "Add Connection" to create new cloud connections\n2. Select a connection type (MQTT, HTTP, AWS, Azure, Grafana)\n3. Configure the connection settings\n4. Test the connection before saving\n5. Manage multiple connections from the list\n\nMaximum connections: ' + config.app.maxConnections);
        }
        
        function showUploadModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function uploadCertificate() {
            alert('Certificate upload functionality would be implemented here.');
            closeModal('uploadCertModal');
        }
        
        function updatePayloadPreview() {
            const format = document.querySelector('input[name="payload-format"]:checked').value;
            const preview = document.getElementById('json-preview');
            
            switch(format) {
                case 'json':
                    preview.textContent = `{
  "device_id": "CRN001",
  "timestamp": 1736004933,
  "Hoist_Load": 18.5,
  "Boom_Angle": 45,
  "WindSpeed": 12
}`;
                    break;
                case 'key-value':
                    preview.textContent = `device_id=CRN001
timestamp=1736004933
Hoist_Load=18.5
Boom_Angle=45
WindSpeed=12`;
                    break;
                case 'raw':
                    preview.textContent = 'Raw binary data preview not available';
                    break;
            }
        }
    </script>
</body>
</html>