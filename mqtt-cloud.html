<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT / Cloud Integration - Univa Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        secondary: '#475569',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        surface: '#F8FAFC',
                        card: '#FFFFFF',
                        border: '#E2E8F0',
                        green: {
                            500: '#10B981',
                            600: '#059669',
                            700: '#047857'
                        },
                        orange: {
                            500: '#F97316',
                            600: '#EA580C',
                            700: '#C2410C'
                        },
                        purple: {
                            500: '#8B5CF6',
                            600: '#7C3AED',
                            700: '#6D28D9'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #1E293B; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Sidebar Styles - Same as your General Configuration page */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #E2E8F0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            color: #2563EB;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748B;
            padding: 0 20px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #F8FAFC;
            color: #2563EB;
        }
        
        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            border-left-color: #2563EB;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #E2E8F0;
            background: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #2563EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 260px;
            top: 20px;
            z-index: 100;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 8px;
            cursor: pointer;
            color: #64748B;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed {
            transform: translateX(-260px);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 260px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-260px);
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 260px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Compact Table Styles */
        .compact-table {
            font-size: 12px;
        }
        
        .compact-table th {
            padding: 8px 12px;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .compact-table td {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            font-size: 12px;
        }
        
        .status-indicator.online::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10B981;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.offline::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #EF4444;
            margin-right: 4px;
        }
        
        .status-indicator.warning::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #F59E0B;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Protocol Badges */
        .protocol-badge {
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .protocol-badge.mqtt {
            background: #EFF6FF;
            color: #2563EB;
            border: 1px solid #BFDBFE;
        }
        
        .protocol-badge.http {
            background: #FEF3C7;
            color: #D97706;
            border: 1px solid #FDE68A;
        }
        
        .protocol-badge.aws {
            background: #F3E8FF;
            color: #7C3AED;
            border: 1px solid #E9D5FF;
        }
        
        .protocol-badge.azure {
            background: #DCFCE7;
            color: #166534;
            border: 1px solid #BBF7D0;
        }
        
        .protocol-badge.grafana {
            background: #FFE4CC;
            color: #EA580C;
            border: 1px solid #FFD9C2;
        }
        
        .protocol-badge.websocket {
            background: #DCFCE7;
            color: #059669;
            border: 1px solid #BBF7D0;
        }
        
        .protocol-badge.ftp {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #FDE68A;
        }
        
        .protocol-badge.udp {
            background: #F3E8FF;
            color: #6D28D9;
            border: 1px solid #E9D5FF;
        }
        
        /* Card Styles */
        .config-card {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Form Styles */
        .compact-input {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
        }
        
        .compact-input:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .compact-select {
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
            border: 1px solid #E2E8F0;
            transition: all 0.2s;
        }
        
        .compact-select:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .compact-button {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CBD5E1;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #10B981;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
        
        /* Tab Styles */
        .tab-button {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            color: #64748B;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: #2563EB;
            border-bottom-color: #E2E8F0;
        }
        
        .tab-button.active {
            color: #2563EB;
            border-bottom-color: #2563EB;
            font-weight: 600;
        }
        
        /* Tag selection table */
        .tag-table {
            border-collapse: collapse;
            width: 100%;
        }
        
        .tag-table tr:hover {
            background-color: #F8FAFC;
        }
        
        .tag-table th {
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .tag-table td {
            border-bottom: 1px solid #E2E8F0;
        }
        
        /* Connection Manager Styles */
        .connection-type-card {
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .connection-type-card:hover {
            border-color: #2563EB;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }
        
        .connection-type-icon {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
        }
        
        .form-section {
            background: #F8FAFC;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .form-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 12px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .key-value-list {
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .key-value-item {
            display: flex;
            gap: 8px;
            padding: 8px;
            border-bottom: 1px solid #E2E8F0;
            align-items: center;
        }
        
        .key-value-item:last-child {
            border-bottom: none;
        }
        
        .key-value-item input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #E2E8F0;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* Enhanced Publishing Options Styles */
        .publishing-option-card {
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s;
        }
        
        .publishing-option-card:hover {
            border-color: #BFDBFE;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.05);
        }
        
        .publishing-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .publishing-option-content {
            padding-left: 24px;
        }
        
        /* File upload styles */
        .file-upload {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-name {
            font-size: 12px;
            color: #64748B;
        }
        
        /* Form input groups */
        .form-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .form-input-group .compact-input {
            flex: 1;
        }
        
        /* Help text */
        .help-text {
            font-size: 11px;
            color: #64748B;
            margin-top: 2px;
            line-height: 1.4;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    
    <!-- Sidebar will be inserted here by JavaScript -->
    <div id="sidebar-container"></div>

    <!-- Existing Modals -->
    <div id="addTagModal" class="modal">
        <!-- ... existing modal content ... -->
    </div>
    
    <div id="uploadCertModal" class="modal">
        <!-- ... existing modal content ... -->
    </div>

    <div id="testResultsModal" class="modal">
        <!-- ... existing modal content ... -->
    </div>

    <!-- NEW: Connection Manager Modal (for adding new connections) -->
    <div id="connectionManagerModal" class="modal">
        <!-- ... existing modal content ... -->
    </div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <!-- Header -->
        <header class="bg-white border-b border-border sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 h-14 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="hidden md:flex items-center text-xs text-slate-500">
                        <span><i class="fa-solid fa-cloud mr-1"></i>Protocols</span>
                        <i class="fa-solid fa-chevron-right text-xs mx-1"></i>
                        <span class="text-slate-900 font-medium">Cloud Connection Manager</span>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-xs px-2 py-1 rounded hover:bg-slate-100" onclick="cancelChanges()">
                        Cancel
                    </button>
                    <button class="bg-primary hover:bg-primaryHover text-white font-medium text-xs px-3 py-1 rounded shadow-sm flex items-center" onclick="saveAllConnections()">
                        <i class="fa-solid fa-floppy-disk mr-1"></i> Save
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 py-6">
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-xl font-bold text-slate-900">Cloud Connection Manager</h1>
                            <p class="text-slate-500 text-xs mt-1">Configure and manage connections to various cloud services</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="showConnectionManager()" class="compact-button bg-primary hover:bg-primaryHover text-white flex items-center">
                                <i class="fa-solid fa-plus mr-1 text-xs"></i> Add Connection
                            </button>
                            <button onclick="showHelp()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 flex items-center">
                                <i class="fa-solid fa-circle-question mr-1 text-xs"></i> Help
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column: Connections List -->
                    <section class="lg:col-span-1">
                        <div class="config-card">
                            <div class="p-4 border-b border-border">
                                <h2 class="text-sm font-semibold text-slate-800 flex items-center">
                                    <i class="fa-solid fa-list mr-2 text-primary text-xs"></i> 
                                    Active Connections (<span id="connectionCount">5</span>)
                                </h2>
                            </div>
                            
                            <div class="p-3 space-y-3" id="connectionsList">
                                <!-- Connections will be dynamically loaded here -->
                            </div>
                        </div>
                    </section>

                    <!-- Right Column: Configuration -->
                    <section class="lg:col-span-2 space-y-4">
                        <!-- Connection Status Card -->
                        <div class="config-card p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-sm font-semibold text-slate-900" id="connectionName">Primary MQTT Broker</h3>
                                    <p class="text-xs text-slate-500" id="connectionDescription">Primary cloud connection for telemetry data</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium text-slate-700">Enabled</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked id="mqtt-enabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="grid grid-cols-4 gap-3 mb-4">
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Messages</div>
                                    <div class="text-sm font-bold text-slate-900" id="statMessages">14,593</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Errors</div>
                                    <div class="text-sm font-bold text-success" id="statErrors">0</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Last Sent</div>
                                    <div class="text-sm font-bold text-slate-900" id="statLastSent">2.3s ago</div>
                                </div>
                                <div class="bg-slate-50 p-2 rounded text-center">
                                    <div class="text-xs text-slate-500">Latency</div>
                                    <div class="text-sm font-bold text-slate-900" id="statLatency">124 ms</div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Tabs -->
                        <div class="config-card">
                            <!-- Tabs -->
                            <div class="flex border-b border-border">
                                <button onclick="switchTab('connection')" class="tab-button active" id="tab-connection">Connection</button>
                                <button onclick="switchTab('topics')" class="tab-button" id="tab-topics">Topics & Format</button>
                                <button onclick="switchTab('publishing')" class="tab-button" id="tab-publishing">Tag Publishing</button>
                                <button onclick="switchTab('advanced')" class="tab-button" id="tab-advanced">Advanced</button>
                            </div>
                            
                            <!-- Connection Settings (Tab 1) -->
                            <div id="tab-content-connection" class="p-4 space-y-6">
                                <!-- This will be dynamically populated based on selected connection -->
                            </div>
                            
                            <!-- Topics & Format (Tab 2) - MQTT Specific -->
                            <div id="tab-content-topics" class="p-4 space-y-6" style="display: none;">
                                <!-- This content is only shown for MQTT connections -->
                            </div>
                            
                            <!-- Tag Publishing (Tab 3) - MQTT Specific -->
                            <div id="tab-content-publishing" class="p-4 space-y-6" style="display: none;">
                                <!-- This content is only shown for MQTT connections -->
                            </div>
                            
                            <!-- Advanced (Tab 4) - MQTT Specific -->
                            <div id="tab-content-advanced" class="p-4 space-y-6" style="display: none;">
                                <!-- This content is only shown for MQTT connections -->
                            </div>
                        </div>
                        
                        <!-- Connection Monitor -->
                        <div class="config-card p-4">
                            <h4 class="text-xs font-semibold text-slate-900 mb-3">Connection Diagnostics</h4>
                            
                            <div class="grid grid-cols-2 gap-6">
                                <!-- Status Panel -->
                                <div>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Status:</span>
                                            <span class="status-indicator online">Connected</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Last Message Published:</span>
                                            <span class="text-xs font-mono text-slate-900">2.3 sec ago</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Packets Sent:</span>
                                            <span class="text-xs font-mono text-slate-900">14,593</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Packets Received:</span>
                                            <span class="text-xs font-mono text-slate-900">129</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Last Error:</span>
                                            <span class="text-xs font-mono text-green-600">None</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-600">Round-trip Latency:</span>
                                            <span class="text-xs font-mono text-slate-900">124 ms</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Downlink Commands -->
                                <div>
                                    <h5 class="text-xs font-medium text-slate-700 mb-2">Recent Downlink Commands</h5>
                                    <div class="border border-slate-200 rounded overflow-hidden">
                                        <table class="w-full text-xs">
                                            <thead class="bg-slate-50">
                                                <tr>
                                                    <th class="p-2 text-left">Timestamp</th>
                                                    <th class="p-2 text-left">Command</th>
                                                    <th class="p-2 text-left">Result</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:43:12</td>
                                                    <td class="p-2 font-mono">SetSpeed=12</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Accepted</span>
                                                    </td>
                                                </tr>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:41:04</td>
                                                    <td class="p-2 font-mono">ResetWarning</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-red-50 text-red-700 rounded text-xs">Failed</span>
                                                    </td>
                                                </tr>
                                                <tr class="border-t border-slate-100">
                                                    <td class="p-2">10:38:55</td>
                                                    <td class="p-2 font-mono">GetStatus</td>
                                                    <td class="p-2">
                                                        <span class="px-2 py-1 bg-green-50 text-green-700 rounded text-xs">Accepted</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Fetch and insert sidebar from sidebar.html
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) {
                    throw new Error(`Failed to load sidebar: ${response.status}`);
                }
                
                const html = await response.text();
                
                // Insert the entire HTML content
                document.getElementById('sidebar-container').innerHTML = html;
                
                // Update the active page to MQTT / Cloud Integration
                updateActivePage();
                
                // Initialize sidebar functionality
                initializeSidebar();
                
            } catch (error) {
                console.error('Error loading sidebar:', error);
                // Fallback: create a basic sidebar if fetch fails
                createFallbackSidebar();
            }
        }

        // Create fallback sidebar if fetch fails
        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-satellite-dish mr-2"></i> Univa IoT
                        </div>
                    </div>
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i> General
                            </a>
                            <a href="device-management.html" class="nav-item">
                                <i class="fa-solid fa-microchip"></i> Devices
                            </a>
                        </div>
                        
                        <div class="nav-section">
                            <div class="section-title">Protocols</div>
                            <a href="protocol-mapping.html" class="nav-item">
                                <i class="fa-solid fa-plug"></i> Protocol Mapping
                            </a>
                            <a href="mqtt-cloud.html" class="nav-item active">
                                <i class="fa-solid fa-cloud"></i> MQTT / Cloud
                            </a>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4>Admin User</h4>
                                <p>System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }

        // Update active page in sidebar
        function updateActivePage() {
            // Remove active class from all nav items
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to MQTT / Cloud Integration
            const mqttCloudLink = Array.from(navItems).find(item => 
                item.textContent.includes('MQTT / Cloud') || 
                item.textContent.includes('MQTT / Cloud') ||
                item.textContent.includes('Cloud Connection Manager')
            );
            
            if (mqttCloudLink) {
                mqttCloudLink.classList.add('active');
            }
        }

        // Initialize sidebar functionality
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (!sidebar || !sidebarToggle) return;
            
            // Toggle sidebar
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                
                // Toggle icon
                const icon = this.querySelector('i');
                if (sidebar.classList.contains('active')) {
                    icon.className = 'fa-solid fa-times';
                } else {
                    icon.className = 'fa-solid fa-bars';
                }
            });
            
            // Handle mobile menu
            if (window.innerWidth <= 1024) {
                sidebar.classList.add('active');
                sidebarToggle.style.left = '260px';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-times';
            }
            
            // Update on resize
            window.addEventListener('resize', handleResponsive);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', handleSidebarClickOutside);
        }

        // Handle responsive behavior
        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '260px';
            }
        }

        // Close sidebar when clicking outside on mobile
        function handleSidebarClickOutside(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile && sidebar.classList.contains('active')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                    sidebarToggle.style.left = '0';
                }
            }
        }

        // Load configuration from the JSON you provided (with additions)
        const config = {
            "app": {
                "name": "Univa IoT Gateway",
                "version": "2.4.1",
                "maxConnections": 12
            },
            
            "connectionTypes": {
                "mqtt": {
                    "name": "MQTT Broker",
                    "description": "Standard IoT messaging protocol",
                    "icon": "fa-solid fa-cloud",
                    "color": "blue",
                    "defaultName": "MQTT Broker",
                    "formFile": "connection-forms/mqtt-form.html"
                },
                
                "http": {
                    "name": "HTTP Endpoint",
                    "description": "REST API endpoints",
                    "icon": "fa-solid fa-globe",
                    "color": "yellow",
                    "defaultName": "HTTP API",
                    "formFile": "connection-forms/http-form.html"
                },
                
                "aws": {
                    "name": "AWS IoT Core",
                    "description": "Amazon Web Services IoT",
                    "icon": "fa-brands fa-aws",
                    "color": "purple",
                    "defaultName": "AWS IoT",
                    "formFile": "connection-forms/aws-form.html"
                },
                
                "azure": {
                    "name": "Azure IoT Hub",
                    "description": "Microsoft Azure IoT",
                    "icon": "fa-brands fa-microsoft",
                    "color": "blue",
                    "defaultName": "Azure IoT Hub",
                    "formFile": "connection-forms/azure-form.html"
                },
                
                "grafana": {
                    "name": "Grafana Cloud",
                    "description": "Monitoring & Dashboards",
                    "icon": "fa-solid fa-chart-line",
                    "color": "orange",
                    "defaultName": "Grafana Cloud",
                    "formFile": "connection-forms/grafana-form.html"
                },
                
                "websocket": {
                    "name": "WebSocket Server",
                    "description": "Real-time bidirectional communication",
                    "icon": "fa-solid fa-bolt",
                    "color": "green",
                    "defaultName": "WebSocket Server",
                    "formFile": "connection-forms/websocket-form.html"
                },
                
                "ftp": {
                    "name": "FTP Server",
                    "description": "File transfer for data logs",
                    "icon": "fa-solid fa-folder",
                    "color": "orange",
                    "defaultName": "FTP Server",
                    "formFile": "connection-forms/ftp-form.html"
                },
                
                "udp": {
                    "name": "UDP Stream",
                    "description": "Low-latency unidirectional streaming",
                    "icon": "fa-solid fa-wave-square",
                    "color": "purple",
                    "defaultName": "UDP Stream",
                    "formFile": "connection-forms/udp-form.html"
                }
            },
            
            "defaultStats": {
                "messages": 0,
                "errors": 0,
                "latency": 0,
                "uptime": "0h 0m",
                "lastActive": "Never",
                "bandwidth": "0 MB",
                "successRate": "0%"
            },
            
            "defaultConnections": {
                "mqtt": {
                    "id": "mqtt-primary",
                    "type": "mqtt",
                    "name": "Production MQTT Broker",
                    "enabled": true,
                    "config": {
                        "server": "mqtts://broker.company.com:8883",
                        "clientId": "univa-gw-01",
                        "qos": 1,
                        "username": "admin",
                        "tls": true,
                        "keepAlive": 60,
                        "cleanSession": true
                    },
                    "stats": {
                        "messages": 8953,
                        "errors": 0,
                        "latency": 95,
                        "uptime": "8h 12m",
                        "lastActive": "2.3s ago",
                        "bandwidth": "2.4 MB",
                        "successRate": "99.8%"
                    }
                },
                "http": {
                    "id": "http-analytics",
                    "type": "http",
                    "name": "Analytics API",
                    "enabled": true,
                    "config": {
                        "url": "https://api.company.com/v1/data",
                        "method": "POST",
                        "interval": 300,
                        "batchSize": 100,
                        "contentType": "application/json"
                    },
                    "stats": {
                        "messages": 3245,
                        "errors": 12,
                        "latency": 210,
                        "uptime": "1h 45m",
                        "lastActive": "5 min ago",
                        "bandwidth": "1.2 MB",
                        "successRate": "99.6%"
                    }
                },
                "websocket": {
                    "id": "ws-realtime",
                    "type": "websocket",
                    "name": "Real-time Dashboard",
                    "enabled": true,
                    "config": {
                        "server": "wss://dashboard.company.com:443/ws",
                        "pingInterval": 30,
                        "reconnectDelay": 5,
                        "autoReconnect": true,
                        "messageFormat": "json",
                        "maxMessageSize": 65536,
                        "path": "/realtime",
                        "subprotocols": "json, mqtt"
                    },
                    "stats": {
                        "messages": 45789,
                        "errors": 5,
                        "latency": 35,
                        "uptime": "12h 45m",
                        "lastActive": "0.1s ago",
                        "bandwidth": "15.2 MB",
                        "successRate": "99.9%"
                    }
                },
                "ftp": {
                    "id": "ftp-logs",
                    "type": "ftp",
                    "name": "Log File Archive",
                    "enabled": false,
                    "config": {
                        "host": "archive.company.com",
                        "port": 21,
                        "protocol": "ftp",
                        "username": "logs_user",
                        "remotePath": "/uploads/crane-logs/",
                        "mode": "passive",
                        "uploadInterval": 300,
                        "appendMode": true,
                        "fileFormat": "csv"
                    },
                    "stats": {
                        "messages": 124,
                        "errors": 2,
                        "latency": 1200,
                        "uptime": "2h 10m",
                        "lastActive": "15 min ago",
                        "bandwidth": "45 MB",
                        "successRate": "98.4%"
                    }
                },
                "udp": {
                    "id": "udp-telemetry",
                    "type": "udp",
                    "name": "Telemetry Stream",
                    "enabled": true,
                    "config": {
                        "remoteHost": "192.168.1.200",
                        "remotePort": 6000,
                        "localPort": 54321,
                        "packetSize": 1400,
                        "sendRate": 100,
                        "messageFormat": "binary",
                        "includeTimestamp": true,
                        "includeSequence": true
                    },
                    "stats": {
                        "messages": 89245,
                        "errors": 128,
                        "latency": 8,
                        "uptime": "5h 22m",
                        "lastActive": "0.0s ago",
                        "bandwidth": "142 MB",
                        "successRate": "99.8%"
                    }
                }
            }
        };

        // Global state
        let connections = {};
        let selectedConnectionId = null;
        let selectedConnectionType = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Load sidebar first
            loadSidebar();
            
            // Initialize app functions
            initializeApp();
            loadConnections();
            renderConnectionTypes();
            
            // Set up initial empty state
            if (Object.keys(connections).length > 0) {
                const firstId = Object.keys(connections)[0];
                selectConnection(firstId);
            } else {
                // Show empty state in the configuration area
                document.getElementById('tab-content-connection').innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i class="fa-solid fa-plug text-3xl mb-3"></i>
                        <p class="text-sm">Select a connection to configure</p>
                        <p class="text-xs mt-1">or click "Add Connection" to create a new one</p>
                    </div>
                `;
            }
        });

        function initializeApp() {
            // Setup event listeners
            setupEventListeners();
            setupToggles();
            
            // Initialize tab states
            updatePayloadPreview();
        }

        function setupEventListeners() {
            // Enhanced publishing options listeners
            document.querySelectorAll('input[name="publish-trigger"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const intervalSettings = document.getElementById('interval-settings');
                    if (this.value === 'periodic') {
                        if (intervalSettings) intervalSettings.style.display = 'block';
                    } else {
                        if (intervalSettings) intervalSettings.style.display = 'none';
                    }
                });
            });
            
            // Payload format change
            document.querySelectorAll('input[name="payload-format"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updatePayloadPreview();
                });
            });
        }
        
        function setupToggles() {
            // Setup all toggle switches
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const label = this.nextElementSibling;
                    if (this.checked) {
                        label.style.backgroundColor = '#10B981';
                    } else {
                        label.style.backgroundColor = '#CBD5E1';
                    }
                });
            });
        }

        // Modal Functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Connection Manager Functions (for left panel only)
        function showConnectionManager() {
            showModal('connectionManagerModal');
            showConnectionTypeSelection();
        }

        function showConnectionTypeSelection() {
            document.getElementById('connectionTypeSelection').classList.remove('hidden');
            document.getElementById('connectionFormContainer').classList.add('hidden');
            selectedConnectionType = null;
        }

        function renderConnectionTypes() {
            const grid = document.getElementById('connectionTypesGrid');
            grid.innerHTML = '';
            
            Object.entries(config.connectionTypes).forEach(([type, connectionConfig]) => {
                const card = document.createElement('div');
                card.className = 'connection-type-card';
                card.onclick = () => selectConnectionType(type);
                
                const colorMap = {
                    blue: '#3B82F6',
                    yellow: '#F59E0B',
                    purple: '#8B5CF6',
                    orange: '#F97316',
                    green: '#10B981'
                };
                
                const color = colorMap[connectionConfig.color] || '#3B82F6';
                
                card.innerHTML = `
                    <div class="connection-type-icon" style="background-color: ${color}20; color: ${color};">
                        <i class="${connectionConfig.icon}"></i>
                    </div>
                    <h4 class="font-semibold text-slate-900 text-sm mb-2">${connectionConfig.name}</h4>
                    <p class="text-xs text-slate-600">${connectionConfig.description}</p>
                `;
                
                grid.appendChild(card);
            });
        }

        async function selectConnectionType(type) {
            selectedConnectionType = type;
            const connectionConfig = config.connectionTypes[type];
            
            document.getElementById('formTitle').textContent = `Configure ${connectionConfig.name}`;
            document.getElementById('connectionTypeSelection').classList.add('hidden');
            document.getElementById('connectionFormContainer').classList.remove('hidden');
            
            // Load form from external file
            await renderConnectionForm(type);
        }

        async function renderConnectionForm(type) {
            const formContent = document.getElementById('formContent');
            const connectionConfig = config.connectionTypes[type];
            
            try {
                // Load form from external file
                const response = await fetch(connectionConfig.formFile);
                if (!response.ok) throw new Error(`Failed to load form: ${response.status}`);
                
                const html = await response.text();
                formContent.innerHTML = html;
                
                // Initialize dynamic elements in the loaded form
                initializeTemplateFields();
            } catch (error) {
                console.error('Error loading form:', error);
                formContent.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i class="fa-solid fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>Unable to load configuration form</p>
                        <p class="text-xs mt-1">${error.message}</p>
                        <button onclick="showConnectionTypeSelection()" class="mt-4 compact-button border border-slate-300 text-slate-700 hover:bg-slate-50">
                            <i class="fa-solid fa-arrow-left mr-1"></i> Back to Connection Types
                        </button>
                    </div>
                `;
            }
        }

        function initializeTemplateFields() {
            // Setup toggle switches in loaded template
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const label = this.nextElementSibling;
                    label.style.backgroundColor = this.checked ? '#10B981' : '#CBD5E1';
                });
                
                // Set initial color
                const label = toggle.nextElementSibling;
                label.style.backgroundColor = toggle.checked ? '#10B981' : '#CBD5E1';
            });
            
            // Setup key-value item listeners
            document.querySelectorAll('.key-value-list').forEach(list => {
                const addButton = list.querySelector('button');
                if (addButton) {
                    addButton.onclick = function() {
                        addKeyValueItem(this);
                    };
                }
                
                // Setup delete buttons
                list.querySelectorAll('.key-value-item button').forEach(btn => {
                    btn.onclick = function() {
                        removeKeyValueItem(this);
                    };
                });
            });
            
            // Setup file upload handlers
            document.querySelectorAll('.file-upload input[type="file"]').forEach(input => {
                input.onchange = function() {
                    const fieldId = this.id;
                    const fileName = this.files[0]?.name || 'No file selected';
                    const nameSpan = document.getElementById(`${fieldId}-name`);
                    if (nameSpan) {
                        nameSpan.textContent = fileName;
                    }
                };
            });
            
            // Setup generate password buttons
            document.querySelectorAll('button[onclick^="generatePassword"]').forEach(btn => {
                const match = btn.getAttribute('onclick').match(/generatePassword\('([^']+)'\)/);
                if (match) {
                    const fieldId = match[1];
                    btn.onclick = function() {
                        generatePassword(fieldId);
                    };
                }
            });
        }

        function cancelConnectionForm() {
            showConnectionTypeSelection();
        }

        function saveNewConnection() {
            if (!selectedConnectionType) return;
            
            const connectionConfig = config.connectionTypes[selectedConnectionType];
            const formData = collectFormDataFromTemplate();
            
            // Create connection ID
            const connectionId = `${selectedConnectionType}-${Date.now()}`;
            
            // Create connection object
            connections[connectionId] = {
                id: connectionId,
                type: selectedConnectionType,
                name: connectionConfig.defaultName,
                enabled: true,
                config: formData,
                stats: {...config.defaultStats}
            };
            
            // Add to UI
            addConnectionToList(connectionId, connections[connectionId]);
            
            // Close modal
            closeModal('connectionManagerModal');
            
            // Show notification
            showNotification(`${connectionConfig.name} added successfully`, 'success');
            
            // Select the new connection
            selectConnection(connectionId);
        }

        function collectFormDataFromTemplate() {
            const formData = {};
            
            // Collect all input fields from the template
            const formContent = document.getElementById('formContent');
            
            // Text inputs
            formContent.querySelectorAll('input[type="text"], input[type="number"], input[type="password"]').forEach(input => {
                const id = input.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = input.value;
                }
            });
            
            // Selects
            formContent.querySelectorAll('select').forEach(select => {
                const id = select.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = select.value;
                }
            });
            
            // Checkboxes (toggles)
            formContent.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(checkbox => {
                const id = checkbox.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = checkbox.checked;
                }
            });
            
            // Radio buttons
            formContent.querySelectorAll('input[type="radio"]').forEach(radio => {
                const name = radio.name;
                if (name.startsWith('field-')) {
                    const fieldName = name.replace('field-', '');
                    if (radio.checked) {
                        formData[fieldName] = radio.value;
                    }
                }
            });
            
            // Collect key-value pairs
            const keyValueData = {};
            formContent.querySelectorAll('.key-value-item').forEach(item => {
                const inputs = item.querySelectorAll('input[type="text"]');
                if (inputs.length >= 2) {
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        keyValueData[key] = value;
                    }
                }
            });
            
            // Add key-value data if exists
            if (Object.keys(keyValueData).length > 0) {
                formData.headers = keyValueData;
            }
            
            return formData;
        }

        function loadConnections() {
            // Load default connections
            Object.values(config.defaultConnections).forEach(conn => {
                connections[conn.id] = conn;
                addConnectionToList(conn.id, conn);
            });
            
            updateConnectionCount();
        }

        function addConnectionToList(id, conn) {
            const list = document.getElementById('connectionsList');
            const connectionConfig = config.connectionTypes[conn.type];
            
            // Check if already exists
            if (document.querySelector(`[data-connection-id="${id}"]`)) {
                updateConnectionItem(id, conn);
                return;
            }
            
            // Remove placeholder if exists
            const placeholder = list.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const colorMap = {
                blue: 'border-blue-500 text-blue-600',
                yellow: 'border-yellow-500 text-yellow-600',
                purple: 'border-purple-500 text-purple-600',
                orange: 'border-orange-500 text-orange-600',
                green: 'border-green-500 text-green-600'
            };
            
            const colorClass = colorMap[connectionConfig.color] || 'border-blue-500 text-blue-600';
            
            const html = `
                <div data-connection-id="${id}" class="border-l-4 ${colorClass.split(' ')[0]} p-3 bg-white border ${selectedConnectionId === id ? 'border-blue-200 bg-blue-50' : 'border-slate-200'} rounded-lg cursor-pointer hover:border-blue-200 transition-colors" onclick="selectConnection('${id}')">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="${connectionConfig.icon} ${colorClass.split(' ')[1]}"></i>
                            <span class="font-medium text-slate-900 text-sm">${conn.name}</span>
                        </div>
                        <span class="text-xs text-slate-500">${conn.stats.lastActive}</span>
                    </div>
                    <div class="text-xs text-slate-600 truncate mb-2">${getConnectionSummary(conn)}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs px-2 py-1 rounded ${conn.enabled ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${conn.enabled ? 'Active' : 'Inactive'}
                        </span>
                        <span class="text-xs font-medium">${conn.stats.messages.toLocaleString()} msgs</span>
                    </div>
                </div>
            `;
            
            list.insertAdjacentHTML('afterbegin', html);
            updateConnectionCount();
        }

        function updateConnectionItem(id, conn) {
            const item = document.querySelector(`[data-connection-id="${id}"]`);
            if (!item) return;
            
            const connectionConfig = config.connectionTypes[conn.type];
            const colorMap = {
                blue: 'text-blue-600',
                yellow: 'text-yellow-600',
                purple: 'text-purple-600',
                orange: 'text-orange-600',
                green: 'text-green-600'
            };
            
            const iconClass = colorMap[connectionConfig.color] || 'text-blue-600';
            
            item.querySelector('i').className = `${connectionConfig.icon} ${iconClass}`;
            item.querySelector('.font-medium').textContent = conn.name;
            item.querySelector('.text-xs.text-slate-500').textContent = conn.stats.lastActive;
            item.querySelector('.text-slate-600').textContent = getConnectionSummary(conn);
            item.querySelector('.bg-green-100, .bg-gray-100').className = conn.enabled ? 'text-xs px-2 py-1 rounded bg-green-100 text-green-800' : 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-800';
            item.querySelector('.bg-green-100, .bg-gray-100').textContent = conn.enabled ? 'Active' : 'Inactive';
            item.querySelector('.font-medium:last-child').textContent = `${conn.stats.messages.toLocaleString()} msgs`;
        }

        function getConnectionSummary(conn) {
            if (conn.type === 'mqtt' && conn.config.host) {
                const protocol = conn.config.protocol || 'mqtt://';
                const port = conn.config.port || (protocol.includes('mqtts') ? 8883 : 1883);
                return `${protocol}${conn.config.host}:${port}`;
            }
            if (conn.type === 'websocket' && conn.config.host) {
                const protocol = conn.config.protocol || 'ws://';
                const port = conn.config.port || (protocol.includes('wss') ? 443 : 80);
                return `${protocol}${conn.config.host}:${port}${conn.config.path || ''}`;
            }
            if (conn.type === 'ftp' && conn.config.host) {
                return `ftp://${conn.config.host}:${conn.config.port || 21}`;
            }
            if (conn.type === 'udp' && conn.config.remoteHost) {
                return `udp://${conn.config.remoteHost}:${conn.config.remotePort}`;
            }
            if (conn.config.url) return conn.config.url;
            if (conn.config.endpoint) return conn.config.endpoint;
            if (conn.config.hostname) return conn.config.hostname;
            return `${config.connectionTypes[conn.type]?.name} Connection`;
        }

        // Enhanced Connection Selection Function
        function selectConnection(id) {
            selectedConnectionId = id;
            const conn = connections[id];
            
            if (!conn) return;
            
            // Update UI in left panel
            document.querySelectorAll('[data-connection-id]').forEach(el => {
                el.classList.remove('border-blue-200', 'bg-blue-50');
                el.classList.add('border-slate-200');
            });
            
            const selectedEl = document.querySelector(`[data-connection-id="${id}"]`);
            if (selectedEl) {
                selectedEl.classList.add('border-blue-200', 'bg-blue-50');
                selectedEl.classList.remove('border-slate-200');
            }
            
            // Update main configuration area with the ACTUAL connection form
            updateConfigurationForConnection(conn);
        }

        // Enhanced Connection Configuration Function
        async function updateConfigurationForConnection(conn) {
            const connectionConfig = config.connectionTypes[conn.type];
            
            // Update header information
            document.getElementById('connectionName').textContent = conn.name;
            document.getElementById('connectionDescription').textContent = `${connectionConfig.name} - ${connectionConfig.description}`;
            
            // Update stats
            document.getElementById('statMessages').textContent = conn.stats.messages.toLocaleString();
            document.getElementById('statErrors').textContent = conn.stats.errors;
            document.getElementById('statLastSent').textContent = conn.stats.lastActive;
            document.getElementById('statLatency').textContent = conn.stats.latency + ' ms';
            
            // Clear the tab contents
            const tabContent = document.getElementById('tab-content-connection');
            tabContent.innerHTML = '<div class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-primary text-xl"></i><p class="text-xs text-slate-500 mt-2">Loading configuration...</p></div>';
            
            // Hide other tabs initially
            document.getElementById('tab-content-topics').style.display = 'none';
            document.getElementById('tab-content-publishing').style.display = 'none';
            document.getElementById('tab-content-advanced').style.display = 'none';
            
            // Update tab buttons based on connection type
            document.querySelectorAll('.tab-button').forEach(tab => {
                if (tab.id === 'tab-connection') {
                    tab.style.display = 'block';
                    tab.classList.add('active');
                } else {
                    tab.style.display = 'none';
                    tab.classList.remove('active');
                }
            });
            
            // Load the specific connection form for editing
            await loadConnectionEditForm(conn);
        }

        // Enhanced Connection Edit Form Loading
        async function loadConnectionEditForm(conn) {
            const connectionConfig = config.connectionTypes[conn.type];
            const tabContent = document.getElementById('tab-content-connection');
            
            try {
                // Load form from external file
                const response = await fetch(connectionConfig.formFile);
                if (!response.ok) throw new Error(`Failed to load form: ${response.status}`);
                
                const html = await response.text();
                
                // Create the edit form container
                tabContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-sm font-semibold text-slate-900">${connectionConfig.name} Configuration</h4>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-700">Enabled</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="connection-enabled" ${conn.enabled ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Connection Name -->
                        <div class="form-section">
                            <h5 class="form-section-title">Connection Information</h5>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">Connection Name</label>
                                    <input type="text" id="edit-connection-name" 
                                           class="w-full compact-input"
                                           value="${conn.name}"
                                           placeholder="Enter connection name">
                                </div>
                            </div>
                        </div>
                        
                        <!-- The actual connection form -->
                        <div id="edit-form-content">
                            ${html}
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="pt-4 border-t border-slate-200">
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-2">
                                    <button onclick="testConnection()" class="compact-button border border-slate-300 text-slate-700 hover:bg-slate-50 flex items-center">
                                        <i class="fa-solid fa-bolt mr-1"></i> Test Connection
                                    </button>
                                    <button onclick="deleteConnection('${conn.id}')" class="compact-button border border-red-300 text-red-700 hover:bg-red-50 flex items-center">
                                        <i class="fa-solid fa-trash mr-1"></i> Delete
                                    </button>
                                </div>
                                <button onclick="saveConnection('${conn.id}')" class="compact-button bg-primary hover:bg-primaryHover text-white flex items-center">
                                    <i class="fa-solid fa-save mr-1"></i> Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Populate form with existing configuration
                populateFormWithData(conn);
                
                // Initialize dynamic elements
                initializeEditFormFields();
                
            } catch (error) {
                console.error('Error loading form:', error);
                tabContent.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <i class="fa-solid fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>Unable to load configuration form</p>
                        <p class="text-xs mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        function populateFormWithData(conn) {
            // Populate connection name
            const nameInput = document.getElementById('edit-connection-name');
            if (nameInput) nameInput.value = conn.name;
            
            // Populate all form fields from connection config
            Object.entries(conn.config).forEach(([fieldName, value]) => {
                const fieldId = `field-${fieldName}`;
                const element = document.getElementById(fieldId);
                
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else if (element.type === 'radio') {
                        document.querySelectorAll(`input[name="${element.name}"][value="${value}"]`).forEach(radio => {
                            radio.checked = true;
                        });
                    } else {
                        element.value = value;
                    }
                }
            });
            
            // Special handling for key-value lists (like headers)
            if (conn.config.headers && typeof conn.config.headers === 'object') {
                const keyValueLists = document.querySelectorAll('.key-value-list');
                keyValueLists.forEach(list => {
                    // Clear existing items except the add button
                    const items = list.querySelectorAll('.key-value-item');
                    items.forEach(item => {
                        if (!item.querySelector('button[onclick*="addKeyValueItem"]')) {
                            item.remove();
                        }
                    });
                    
                    // Add items from config
                    Object.entries(conn.config.headers).forEach(([key, value]) => {
                        const addButton = list.querySelector('button[onclick*="addKeyValueItem"]');
                        if (addButton) {
                            const newItem = document.createElement('div');
                            newItem.className = 'key-value-item';
                            newItem.innerHTML = `
                                <input type="text" value="${key}" placeholder="Key" class="compact-input">
                                <input type="text" value="${value}" placeholder="Value" class="compact-input">
                                <button type="button" class="text-red-600 hover:text-red-700" onclick="removeKeyValueItem(this)">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            `;
                            list.insertBefore(newItem, addButton.parentNode);
                        }
                    });
                });
            }
        }

        function initializeEditFormFields() {
            // Setup toggle switches
            document.querySelectorAll('.toggle-switch input').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const label = this.nextElementSibling;
                    label.style.backgroundColor = this.checked ? '#10B981' : '#CBD5E1';
                });
                
                // Set initial color
                const label = toggle.nextElementSibling;
                label.style.backgroundColor = toggle.checked ? '#10B981' : '#CBD5E1';
            });
            
            // Setup key-value item listeners
            document.querySelectorAll('.key-value-list').forEach(list => {
                const addButton = list.querySelector('button[onclick*="addKeyValueItem"]');
                if (addButton) {
                    addButton.onclick = function() {
                        addKeyValueItem(this);
                    };
                }
                
                // Setup delete buttons
                list.querySelectorAll('.key-value-item button').forEach(btn => {
                    if (btn.innerHTML.includes('fa-trash')) {
                        btn.onclick = function() {
                            removeKeyValueItem(this);
                        };
                    }
                });
            });
            
            // Setup file upload handlers
            document.querySelectorAll('.file-upload input[type="file"]').forEach(input => {
                input.onchange = function() {
                    const fieldId = this.id;
                    const fileName = this.files[0]?.name || 'No file selected';
                    const nameSpan = document.getElementById(`${fieldId}-name`);
                    if (nameSpan) {
                        nameSpan.textContent = fileName;
                    }
                };
            });
            
            // Setup generate password buttons
            document.querySelectorAll('button[onclick^="generatePassword"]').forEach(btn => {
                const match = btn.getAttribute('onclick').match(/generatePassword\('([^']+)'\)/);
                if (match) {
                    const fieldId = match[1];
                    btn.onclick = function() {
                        generatePassword(fieldId);
                    };
                }
            });
        }

        function saveConnection(connectionId) {
            const conn = connections[connectionId];
            if (!conn) return;
            
            // Update connection name
            const nameInput = document.getElementById('edit-connection-name');
            if (nameInput) {
                conn.name = nameInput.value;
            }
            
            // Update enabled status
            const enabledCheckbox = document.getElementById('connection-enabled');
            if (enabledCheckbox) {
                conn.enabled = enabledCheckbox.checked;
            }
            
            // Collect form data
            const formData = collectFormDataFromEditForm();
            
            // Update connection config
            conn.config = {...conn.config, ...formData};
            
            // Update UI
            updateConnectionItem(connectionId, conn);
            
            // Show notification
            showNotification(`${conn.name} updated successfully`, 'success');
        }

        function collectFormDataFromEditForm() {
            const formData = {};
            
            // Collect all input fields from the edit form
            const editFormContent = document.getElementById('edit-form-content');
            if (!editFormContent) return formData;
            
            // Text inputs, numbers, passwords
            editFormContent.querySelectorAll('input[type="text"], input[type="number"], input[type="password"]').forEach(input => {
                const id = input.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = input.value;
                }
            });
            
            // Selects
            editFormContent.querySelectorAll('select').forEach(select => {
                const id = select.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = select.value;
                }
            });
            
            // Checkboxes (toggles)
            editFormContent.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(checkbox => {
                const id = checkbox.id;
                if (id.startsWith('field-')) {
                    const fieldName = id.replace('field-', '');
                    formData[fieldName] = checkbox.checked;
                }
            });
            
            // Radio buttons
            editFormContent.querySelectorAll('input[type="radio"]').forEach(radio => {
                const name = radio.name;
                if (name.startsWith('field-')) {
                    const fieldName = name.replace('field-', '');
                    if (radio.checked) {
                        formData[fieldName] = radio.value;
                    }
                }
            });
            
            // Collect key-value pairs
            const keyValueData = {};
            editFormContent.querySelectorAll('.key-value-item').forEach(item => {
                const inputs = item.querySelectorAll('input[type="text"]');
                if (inputs.length >= 2) {
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        keyValueData[key] = value;
                    }
                }
            });
            
            // Add key-value data if exists
            if (Object.keys(keyValueData).length > 0) {
                formData.headers = keyValueData;
            }
            
            return formData;
        }

        function deleteConnection(connectionId) {
            if (!confirm(`Are you sure you want to delete "${connections[connectionId]?.name}"?`)) {
                return;
            }
            
            const connName = connections[connectionId]?.name || 'Connection';
            delete connections[connectionId];
            
            // Remove from UI
            const connectionElement = document.querySelector(`[data-connection-id="${connectionId}"]`);
            if (connectionElement) {
                connectionElement.remove();
            }
            
            // Update count
            updateConnectionCount();
            
            // If this was the selected connection, clear the right panel
            if (selectedConnectionId === connectionId) {
                selectedConnectionId = null;
                document.getElementById('tab-content-connection').innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <i class="fa-solid fa-plug text-3xl mb-3"></i>
                        <p class="text-sm">Select a connection to configure</p>
                        <p class="text-xs mt-1">or click "Add Connection" to create a new one</p>
                    </div>
                `;
            }
            
            showNotification(`${connName} deleted successfully`, 'success');
        }

        function updateConnectionCount() {
            const count = Object.keys(connections).length;
            document.getElementById('connectionCount').textContent = count;
            
            if (count === 0) {
                document.getElementById('connectionsList').innerHTML = `
                    <div class="text-center py-8 text-slate-400">
                        <i class="fa-solid fa-cloud text-3xl mb-3"></i>
                        <p class="text-sm">No connections yet</p>
                        <p class="text-xs mt-1">Click "Add Connection" to get started</p>
                    </div>
                `;
            }
        }

        // Helper functions
        function generateRandomId(length = 6) {
            return Math.random().toString(36).substring(2, 2 + length).toUpperCase();
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 border-green-200 text-green-800',
                error: 'bg-red-100 border-red-200 text-red-800',
                info: 'bg-blue-100 border-blue-200 text-blue-800',
                warning: 'bg-yellow-100 border-yellow-200 text-yellow-800'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg border ${colors[type]} shadow-lg z-50 text-sm`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // Key-Value List Functions
        function addKeyValueItem(button) {
            const list = button.closest('.key-value-list');
            const keyPlaceholder = list.querySelector('input[placeholder*="Key"]')?.placeholder || 'Key';
            const valuePlaceholder = list.querySelector('input[placeholder*="Value"]')?.placeholder || 'Value';
            
            const item = document.createElement('div');
            item.className = 'key-value-item';
            item.innerHTML = `
                <input type="text" placeholder="${keyPlaceholder}" class="compact-input">
                <input type="text" placeholder="${valuePlaceholder}" class="compact-input">
                <button type="button" class="text-red-600 hover:text-red-700" onclick="removeKeyValueItem(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            
            list.insertBefore(item, button.parentNode);
        }

        function removeKeyValueItem(button) {
            const item = button.closest('.key-value-item');
            if (item) {
                item.remove();
            }
        }

        // File Upload Functions
        function handleFileUpload(input, fieldId) {
            const fileName = input.files[0]?.name || 'No file selected';
            document.getElementById(`${fieldId}-name`).textContent = fileName;
        }

        function generatePassword(fieldId) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            for (let i = 0; i < 16; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = password;
            }
        }

        // Enhanced Publishing Rules Functions
        function addPublishingRule() {
            const container = document.getElementById('publishing-rules-container');
            
            // Remove placeholder if exists
            const placeholder = container.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            const ruleId = `rule-${Date.now()}`;
            const ruleHtml = `
                <div id="${ruleId}" class="p-3 bg-white rounded border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-medium text-slate-700">Publishing Rule</span>
                        <button onclick="removePublishingRule('${ruleId}')" class="text-xs text-red-600 hover:text-red-700">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Tag</label>
                            <select class="w-full compact-select">
                                <option value="">Select Tag</option>
                                <option value="Hoist_Load">Hoist_Load</option>
                                <option value="Boom_Angle">Boom_Angle</option>
                                <option value="WindSpeed">WindSpeed</option>
                                <option value="Motor_Temp">Motor_Temp</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Condition</label>
                            <select class="w-full compact-select">
                                <option value="gt">Greater Than</option>
                                <option value="lt">Less Than</option>
                                <option value="eq">Equals</option>
                                <option value="change">On Change</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Value</label>
                            <input type="text" class="w-full compact-input" placeholder="Threshold">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-2">
                            <span class="text-xs text-slate-600">Publish only when condition is met</span>
                        </label>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', ruleHtml);
        }

        function removePublishingRule(ruleId) {
            const rule = document.getElementById(ruleId);
            if (rule) {
                rule.remove();
            }
            
            // Show placeholder if no rules left
            const container = document.getElementById('publishing-rules-container');
            if (container.children.length === 0) {
                container.innerHTML = '<div class="text-xs text-slate-400 text-center py-2">No rules defined yet</div>';
            }
        }

        // Enhanced Tab Switching Function
        function switchTab(tabName) {
            const conn = connections[selectedConnectionId];
            
            if (conn && conn.type === 'mqtt' && tabName !== 'connection') {
                // For MQTT connections, show the specific tabs
                document.querySelectorAll('[id^="tab-content-"]').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                document.getElementById(`tab-content-${tabName}`).style.display = 'block';
                document.getElementById(`tab-${tabName}`).classList.add('active');
            } else {
                // For non-MQTT or no connection selected, show connection tab
                document.querySelectorAll('[id^="tab-content-"]').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                
                document.getElementById('tab-content-connection').style.display = 'block';
                document.getElementById('tab-connection').classList.add('active');
                
                // If we have a non-MQTT connection selected, reload its edit form
                if (conn && conn.type !== 'mqtt' && tabName === 'connection') {
                    loadConnectionEditForm(conn);
                }
            }
        }

        // EXISTING FUNCTIONS FROM ORIGINAL MQTT PAGE
        function showAddTagModal() {
            document.getElementById('addTagModal').classList.add('active');
        }
        
        function addSelectedTags() {
            // In a real app, this would add the selected tags to the table
            const modal = document.getElementById('addTagModal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkboxes.length > 0) {
                showNotification(`${checkboxes.length} tags added successfully!`, 'success');
                closeModal('addTagModal');
                
                // Reset checkboxes
                modal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            } else {
                alert('Please select at least one tag to add.');
            }
        }
        
        function removeSelectedTags() {
            const selected = document.querySelectorAll('.tag-table input[type="checkbox"]:checked');
            
            if (selected.length > 0) {
                if (confirm(`Remove ${selected.length} selected tags?`)) {
                    // In a real app, this would remove the selected rows
                    showNotification(`${selected.length} tags removed successfully!`, 'success');
                    
                    // Uncheck all checkboxes
                    document.querySelectorAll('.tag-table input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                }
            } else {
                alert('Please select tags to remove.');
            }
        }
        
        function saveBrokerSettings() {
            const currentConn = connections[selectedConnectionId];
            if (currentConn && currentConn.type === 'mqtt') {
                // Update connection config with form values
                currentConn.config.host = document.getElementById('server-url')?.value;
                currentConn.config.port = document.getElementById('server-port')?.value;
                
                showNotification('Broker settings saved successfully!', 'success');
                updateConnectionItem(selectedConnectionId, currentConn);
            } else {
                showNotification('Settings saved!', 'success');
            }
        }
        
        function saveTopicSettings() {
            showNotification('Topic settings saved successfully!', 'success');
        }
        
        function savePublishingRules() {
            showNotification('Publishing rules saved successfully!', 'success');
        }
        
        function saveAdvancedSettings() {
            showNotification('Advanced settings saved successfully!', 'success');
        }
        
        function saveConfiguration() {
            showNotification('All configuration saved successfully!', 'success');
        }
        
        function saveAllConnections() {
            showNotification('All connections saved successfully!', 'success');
        }
        
        function testConnection() {
            const currentConn = connections[selectedConnectionId];
            if (!currentConn) {
                showNotification('Please select a connection first', 'warning');
                return;
            }
            
            showNotification(`Testing ${currentConn.name} connection...`, 'info');
            
            setTimeout(() => {
                // Update stats
                currentConn.stats.messages += Math.floor(Math.random() * 100);
                currentConn.stats.lastActive = 'Just now';
                currentConn.stats.latency = Math.floor(Math.random() * 200);
                currentConn.stats.successRate = `${98 + Math.floor(Math.random() * 2)}%`;
                
                updateConnectionItem(selectedConnectionId, currentConn);
                updateConfigurationForConnection(currentConn);
                
                showNotification(`Connection test for ${currentConn.name} successful!`, 'success');
            }, 1500);
        }
        
        function viewLogs() {
            alert('Opening connection logs...');
        }
        
        function resetToDefaults() {
            if (confirm('Reset all settings to default values?')) {
                location.reload();
            }
        }
        
        function cancelChanges() {
            if (confirm('Discard all unsaved changes?')) {
                location.reload();
            }
        }
        
        function showHelp() {
            alert('Cloud Connection Manager Help:\n\n1. Click "Add Connection" to create new cloud connections\n2. Select a connection type (MQTT, HTTP, AWS, Azure, Grafana, WebSocket, FTP, UDP)\n3. Configure the connection settings\n4. Test the connection before saving\n5. Manage multiple connections from the list\n\nMaximum connections: ' + config.app.maxConnections);
        }
        
        function showUploadModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function uploadCertificate() {
            alert('Certificate upload functionality would be implemented here.');
            closeModal('uploadCertModal');
        }
        
        function updatePayloadPreview() {
            const format = document.querySelector('input[name="payload-format"]:checked');
            const preview = document.getElementById('json-preview');
            
            if (!format || !preview) return;
            
            switch(format.value) {
                case 'json':
                    preview.textContent = `{
  "device_id": "CRN001",
  "timestamp": 1736004933,
  "Hoist_Load": 18.5,
  "Boom_Angle": 45,
  "WindSpeed": 12
}`;
                    break;
                case 'key-value':
                    preview.textContent = `device_id=CRN001
timestamp=1736004933
Hoist_Load=18.5
Boom_Angle=45
WindSpeed=12`;
                    break;
                case 'raw':
                    preview.textContent = 'Raw binary data preview not available';
                    break;
            }
        }
    </script>
</body>
</html>