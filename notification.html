<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Channels</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        },
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest'};
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 320px;
            border-left: 4px solid #10b981;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-error { border-left-color: #ef4444; }
        .toast-warning { border-left-color: #f59e0b; }
        .toast-info { border-left-color: #0ea5e9; }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: #0f172a;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #1e293b;
            background: #0f172a;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            color: white;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            padding: 0 20px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid #1e293b;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #cbd5e1;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #1e293b;
            color: white;
        }
        
        .nav-item.active {
            background: #1e293b;
            color: white;
            border-left-color: #0ea5e9;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .nav-item-count {
            margin-left: auto;
            background: #334155;
            color: #cbd5e1;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #1e293b;
            background: #0f172a;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #0ea5e9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 260px;
            top: 20px;
            z-index: 100;
            background: white;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 8px;
            cursor: pointer;
            color: #64748b;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed {
            transform: translateX(-260px);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 260px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-260px);
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 260px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #0ea5e9;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-sent {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .status-delivered {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-failed {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Sidebar will be inserted here by JavaScript -->
    <div id="sidebar-container"></div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Confirmation Dialog Overlay -->
    <div id="confirmation-overlay" class="modal-overlay">
        <div id="confirmation-dialog" class="confirmation-dialog">
            <!-- Confirmation content will be inserted here -->
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <!-- HEADER -->
        <header id="header" class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 shrink-0 z-20">
            <div class="flex items-center gap-4">
                <div class="h-6 w-px bg-slate-300 mx-2"></div>
                <nav class="flex items-center text-sm text-slate-500">
                    <span>Univa Gateway Config</span>
                    <i class="fa-solid fa-chevron-right text-xs mx-2"></i>
                    <span class="text-slate-800 font-medium">Notification Channels</span>
                </nav>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 bg-slate-100 rounded-md px-3 py-1.5 border border-slate-200">
                    <select id="gateway-select" class="bg-transparent text-sm font-medium text-slate-700 focus:outline-none cursor-pointer">
                        <option>Univa-GW-01</option>
                        <option>Univa-GW-02</option>
                        <option>Univa-GW-HQ</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-circle-question mr-2"></i> Help
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 scroll-smooth bg-slate-50/50">
            <div class="max-w-7xl mx-auto space-y-6">
                
                <!-- Page Title Area -->
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Notification Channels</h1>
                        <p class="text-slate-500 text-sm mt-1">Configure delivery channels for alert messages</p>
                    </div>
                    <div class="flex gap-2">
                        <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                            <i class="fa-solid fa-circle text-[8px]"></i> Engine Active
                        </span>
                        <span id="channels-online" class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 border border-blue-200">
                            <i class="fa-solid fa-tower-broadcast text-xs"></i> <span id="online-count">5</span> Channels Online
                        </span>
                    </div>
                </div>

                <!-- SECTION: ACTIVE CHANNELS -->
                <div class="section-header">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-list-check text-brand-500"></i>
                        <div>
                            <h2 class="font-semibold text-slate-800">Active Channels</h2>
                            <p class="text-sm text-slate-500">Manage your notification delivery channels</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-brand-500"></i> Active Channels
                        </h3>
                        <button class="px-4 py-2 text-sm bg-white border border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 hover:text-brand-600 transition-all shadow-sm" onclick="showAddChannelModal()">
                            <i class="fa-solid fa-plus mr-1"></i> Add Channel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Channel Name</th>
                                    <th class="px-6 py-3 font-medium">Type</th>
                                    <th class="px-6 py-3 font-medium">Status</th>
                                    <th class="px-6 py-3 font-medium">Connection Info</th>
                                    <th class="px-6 py-3 font-medium text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="channels-list" class="divide-y divide-slate-100">
                                <!-- Channels will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- SECTION: TESTING -->
                <div class="section-header">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-vial text-green-500"></i>
                        <div>
                            <h2 class="font-semibold text-slate-800">Testing</h2>
                            <p class="text-sm text-slate-500">Test your channels with alert messages</p>
                        </div>
                    </div>
                </div>

                <!-- Channel Status Dashboard -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6">
                    <div class="px-6 py-4 border-b border-slate-100">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-tower-broadcast text-brand-500"></i> Channel Status
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span class="font-medium text-slate-800">MQTT</span>
                                    </div>
                                    <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Online</span>
                                </div>
                                <p class="text-sm text-slate-600">Sends alert messages as-is</p>
                                <div class="mt-3 text-xs text-slate-500">
                                    <i class="fa-solid fa-arrow-up mr-1"></i> Last message: 2 min ago
                                </div>
                            </div>
                            
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span class="font-medium text-slate-800">Email</span>
                                    </div>
                                    <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Ready</span>
                                </div>
                                <p class="text-sm text-slate-600">Sends alert messages as-is</p>
                                <div class="mt-3 text-xs text-slate-500">
                                    <i class="fa-solid fa-envelope mr-1"></i> From: alerts@factory.com
                                </div>
                            </div>
                            
                            <div class="border border-slate-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                                        <span class="font-medium text-slate-800">SMS</span>
                                    </div>
                                    <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded">Testing</span>
                                </div>
                                <p class="text-sm text-slate-600">Sends alert messages as-is</p>
                                <div class="mt-3 text-xs text-slate-500">
                                    <i class="fa-solid fa-mobile-screen mr-1"></i> Needs configuration
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Notification Panel -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-vial text-green-500"></i> Test Notifications
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <p class="text-sm text-slate-600">Select an alert message to send through your channels:</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Alert Message</label>
                                    <select id="test-alert-select" class="w-full border border-slate-300 rounded px-3 py-2 text-sm">
                                        <option value="">-- Select an alert message --</option>
                                        <!-- Will be populated from alerts.html -->
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Test Device</label>
                                    <input type="text" id="test-device" class="w-full border border-slate-300 rounded px-3 py-2 text-sm" value="Test_Device_01" placeholder="Device name">
                                </div>
                            </div>

                            <!-- Variables display will appear here -->
                            <div id="selected-alert-variables"></div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-4">
                                <button class="px-3 py-2 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="testChannel('mqtt')">
                                    <i class="fa-solid fa-satellite-dish mr-1"></i> Test MQTT
                                </button>
                                <button class="px-3 py-2 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="testChannel('email')">
                                    <i class="fa-solid fa-envelope mr-1"></i> Test Email
                                </button>
                                <button class="px-3 py-2 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="testChannel('sms')">
                                    <i class="fa-solid fa-mobile-screen mr-1"></i> Test SMS
                                </button>
                                <button class="px-3 py-2 text-sm border border-slate-300 rounded hover:bg-slate-50" onclick="testAllChannels()">
                                    <i class="fa-solid fa-bolt mr-1"></i> Test All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // ========== GLOBAL STATE ==========
        let channels = [];
        let editingChannelId = null;

        // ========== HELPER FUNCTIONS ==========
        function getAlertMessages() {
            try {
                return JSON.parse(localStorage.getItem('univa_alert_messages')) || [];
            } catch (e) {
                console.error('Error loading alert messages:', e);
                return [];
            }
        }

        function extractVariablesFromAlert(alert) {
            if (!alert || !alert.message) return [];
            
            const variablePattern = /\{(\w+)\}/g;
            const variables = [];
            let match;
            
            while ((match = variablePattern.exec(alert.message)) !== null) {
                if (!variables.includes(match[1])) {
                    variables.push(match[1]);
                }
            }
            
            return variables;
        }

        // ========== SIDEBAR FUNCTIONS ==========
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) throw new Error(`Failed to load sidebar: ${response.status}`);
                document.getElementById('sidebar-container').innerHTML = await response.text();
                updateActivePage();
                initializeSidebar();
            } catch (error) {
                console.error('Error loading sidebar:', error);
                createFallbackSidebar();
            }
        }

        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-network-wired mr-2"></i> Innospace
                        </div>
                    </div>
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Automation & Event Engine</div>
                            <a href="automation-rules.html" class="nav-item">
                                <i class="fa-solid fa-robot"></i> Automation Rules
                            </a>
                            <a href="alerts.html" class="nav-item">
                                <i class="fa-solid fa-bell"></i> Alert Messages
                            </a>
                            <a href="notification.html" class="nav-item active">
                                <i class="fa-solid fa-share-nodes"></i> Notification Channels
                                <span class="nav-item-count">5</span>
                            </a>
                            <a href="event-logging.html" class="nav-item">
                                <i class="fa-solid fa-clipboard-list"></i> Event Logging
                            </a>
                        </div>
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i> General Configuration
                            </a>
                            <a href="device-management.html" class="nav-item">
                                <i class="fa-solid fa-microchip"></i> Device Management
                            </a>
                            <a href="protocol-mapping.html" class="nav-item">
                                <i class="fa-solid fa-exchange-alt"></i> Protocol Mapping
                            </a>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4 class="text-sm font-medium text-white">Admin User</h4>
                                <p class="text-xs text-slate-400">System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }

        function updateActivePage() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            const alertsLink = Array.from(navItems).find(item => 
                item.textContent.includes('Notification Channels') || 
                item.textContent.includes('Notification')
            );
            if (alertsLink) alertsLink.classList.add('active');
        }

        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (!sidebar || !sidebarToggle) return;
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                const icon = this.querySelector('i');
                icon.className = sidebar.classList.contains('active') ? 'fa-solid fa-times' : 'fa-solid fa-bars';
            });
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.add('active');
                sidebarToggle.style.left = '260px';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-times';
            }
            
            window.addEventListener('resize', handleResponsive);
        }

        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '260px';
            }
        }

        function handleSidebarClickOutside(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile && sidebar.classList.contains('active')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                    sidebarToggle.style.left = '0';
                }
            }
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal(title, content, buttons = [], width = '600px') {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.style.maxWidth = width;
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-800">${title}</h3>
                    <button class="text-slate-400 hover:text-slate-600" onclick="closeModal()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                ${buttons.length > 0 ? `
                <div class="modal-footer">
                    ${buttons.map(btn => `
                        <button 
                            onclick="${btn.onclick}"
                            class="${btn.className}"
                            ${btn.disabled ? 'disabled' : ''}
                        >
                            ${btn.text}
                        </button>
                    `).join('')}
                </div>` : ''}
            `;
            
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
            editingChannelId = null;
        }

        function showConfirmation(title, message, onConfirm, onCancel = null) {
            const overlay = document.getElementById('confirmation-overlay');
            const dialog = document.getElementById('confirmation-dialog');
            
            dialog.innerHTML = `
                <div class="mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-3xl text-yellow-500 mb-3"></i>
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">${title}</h3>
                    <p class="text-slate-600">${message}</p>
                </div>
                <div class="flex justify-center gap-3">
                    <button onclick="closeConfirmation()" class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmAction()" class="px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg shadow-sm transition-colors">
                        Confirm
                    </button>
                </div>
            `;
            
            window.confirmAction = function() {
                if (onConfirm) onConfirm();
                closeConfirmation();
            };
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmation() {
            document.getElementById('confirmation-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ========== TOAST FUNCTIONS ==========
        function showToast(message, type = 'success', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const icon = {
                success: 'fa-circle-check',
                error: 'fa-circle-exclamation',
                warning: 'fa-triangle-exclamation',
                info: 'fa-circle-info'
            }[type];
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} text-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-500 text-lg"></i>
                <div class="flex-1">
                    <p class="text-sm font-medium text-slate-800">${message}</p>
                </div>
                <button onclick="closeToast('${toastId}')" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    closeToast(toastId);
                }, duration);
            }
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // ========== CHANNEL MANAGEMENT ==========
        function loadChannels() {
            const savedChannels = localStorage.getItem('univa_notification_channels');
            if (savedChannels) {
                channels = JSON.parse(savedChannels);
            } else {
                channels = [
                    {
                        id: 'mqtt-primary',
                        name: 'MQTT Alert Broker',
                        type: 'mqtt',
                        status: 'active',
                        config: {
                            brokerUrl: 'mqtt.factory.com:1883',
                            topic: 'factory/alerts',
                            username: 'univa_gateway',
                            password: '********'
                        }
                    },
                    {
                        id: 'email-primary',
                        name: 'Corporate SMTP',
                        type: 'email',
                        status: 'active',
                        config: {
                            smtpServer: 'smtp.gmail.com',
                            port: 587,
                            username: 'alerts@factory.com',
                            password: '********',
                            fromEmail: 'alerts@factory.com',
                            toEmails: 'ops-team@factory.com,supervisor@factory.com'
                        }
                    }
                ];
                saveChannels();
            }
            
            renderChannelsList();
            updateChannelsOnline();
        }

        function saveChannels() {
            localStorage.setItem('univa_notification_channels', JSON.stringify(channels));
        }

        function renderChannelsList() {
            const container = document.getElementById('channels-list');
            if (!container) return;
            
            container.innerHTML = channels.map(channel => `
                <tr class="hover:bg-slate-50/50 transition-colors group">
                    <td class="px-6 py-4 font-medium text-slate-900 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${getChannelColorClass(channel.type)} flex items-center justify-center">
                            <i class="fa-solid ${getChannelIcon(channel.type)}"></i>
                        </div>
                        <div>
                            <div>${channel.name}</div>
                            <div class="text-xs text-slate-500">${channel.type.toUpperCase()}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-slate-600">${channel.type.toUpperCase()}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium 
                            ${channel.status === 'active' ? 'bg-green-50 text-green-700 border border-green-100' : 
                              'bg-slate-100 text-slate-600 border border-slate-200'}">
                            ${channel.status === 'active' ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-600 text-sm">
                        ${getConnectionInfo(channel)}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button class="text-slate-400 hover:text-brand-600 px-2" onclick="editChannel('${channel.id}')">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="text-slate-400 hover:text-${channel.status === 'active' ? 'red' : 'green'}-500 px-2" onclick="toggleChannelStatus('${channel.id}')">
                            <i class="fa-solid fa-${channel.status === 'active' ? 'power-off' : 'play'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getConnectionInfo(channel) {
            switch(channel.type) {
                case 'mqtt':
                    return `${channel.config.brokerUrl} • ${channel.config.topic}`;
                case 'email':
                    return `${channel.config.smtpServer}:${channel.config.port} → ${channel.config.toEmails}`;
                case 'sms':
                    return channel.config.phoneNumbers ? channel.config.phoneNumbers : 'Not configured';
                default:
                    return channel.config.server || 'Not configured';
            }
        }

        function getChannelColorClass(type) {
            switch(type) {
                case 'mqtt': return 'bg-brand-100 text-brand-600';
                case 'email': return 'bg-blue-100 text-blue-600';
                case 'sms': return 'bg-green-100 text-green-600';
                case 'webhook': return 'bg-purple-100 text-purple-600';
                case 'push': return 'bg-orange-100 text-orange-600';
                default: return 'bg-slate-100 text-slate-600';
            }
        }

        function getChannelIcon(type) {
            switch(type) {
                case 'mqtt': return 'fa-satellite-dish';
                case 'email': return 'fa-envelope';
                case 'sms': return 'fa-mobile-screen';
                case 'webhook': return 'fa-code-branch';
                case 'push': return 'fa-bell';
                default: return 'fa-plug';
            }
        }

        function updateChannelsOnline() {
            const onlineCount = channels.filter(c => c.status === 'active').length;
            const element = document.getElementById('online-count');
            if (element) {
                element.textContent = onlineCount;
            }
        }

        function showAddChannelModal() {
            editingChannelId = null;
            showChannelModal('Add New Channel');
        }

        function editChannel(channelId) {
            editingChannelId = channelId;
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            showChannelModal('Edit Channel', channel);
        }

        function showChannelModal(title, channel = null) {
            const isEdit = channel !== null;
            const defaultChannelType = channel ? channel.type : 'mqtt';
            
            const content = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Channel Name</label>
                            <input type="text" id="channel-name" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${channel ? channel.name : ''}" placeholder="e.g., Primary MQTT Broker">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Channel Type</label>
                            <select id="channel-type" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" onchange="updateChannelConfigForm(this.value)">
                                <option value="mqtt" ${defaultChannelType === 'mqtt' ? 'selected' : ''}>MQTT</option>
                                <option value="email" ${defaultChannelType === 'email' ? 'selected' : ''}>Email</option>
                                <option value="sms" ${defaultChannelType === 'sms' ? 'selected' : ''}>SMS</option>
                                <option value="webhook" ${defaultChannelType === 'webhook' ? 'selected' : ''}>Webhook</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-slate-700">Enable Channel</h4>
                            <p class="text-xs text-slate-500">Activate this channel for notifications</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="channel-enabled" ${channel && channel.status === 'active' ? 'checked' : true ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div id="channel-config-form" class="space-y-4">
                        ${getConfigHTML(defaultChannelType, channel)}
                    </div>
                    
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded">
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i>
                            <div>
                                <p class="text-xs text-blue-800"><strong>Note:</strong> Alert messages will be sent as-is from the Alerts section. Variables like {device}, {value}, etc. will be replaced with actual values when alerts trigger.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(
                title,
                content,
                [
                    {
                        text: 'Cancel',
                        className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors',
                        onclick: 'closeModal()'
                    },
                    {
                        text: isEdit ? 'Save Changes' : 'Add Channel',
                        className: 'px-4 py-2 text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 rounded-lg shadow-sm transition-colors',
                        onclick: isEdit ? `saveChannelEdit('${channel.id}')` : 'saveNewChannel()'
                    }
                ]
            );
        }

        function getConfigHTML(channelType, channel = null) {
            const config = channel ? channel.config : {};
            
            switch(channelType) {
                case 'mqtt':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Broker URL</label>
                                <input type="text" id="mqtt-broker" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.brokerUrl || 'mqtt.factory.com:1883'}" placeholder="mqtt.server.com:1883">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Topic</label>
                                <input type="text" id="mqtt-topic" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.topic || 'factory/alerts'}" placeholder="alerts/topic">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                                <input type="text" id="mqtt-username" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.username || ''}" placeholder="Username (optional)">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input type="password" id="mqtt-password" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.password || ''}" placeholder="Password (optional)">
                            </div>
                        </div>
                    `;
                    
                case 'email':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">SMTP Server</label>
                                <input type="text" id="email-smtp" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.smtpServer || 'smtp.gmail.com'}" placeholder="smtp.server.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Port</label>
                                <input type="number" id="email-port" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.port || 587}" placeholder="587">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
                                <input type="text" id="email-username" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.username || ''}" placeholder="email@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                                <input type="password" id="email-password" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.password || ''}" placeholder="Password">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">From Email</label>
                                <input type="email" id="email-from" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.fromEmail || 'alerts@factory.com'}" placeholder="alerts@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">To Emails</label>
                                <input type="text" id="email-to" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.toEmails || 'ops-team@factory.com,supervisor@factory.com'}" placeholder="email1@example.com, email2@example.com">
                            </div>
                        </div>
                    `;
                    
                case 'sms':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Provider</label>
                                <select id="sms-provider" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm">
                                    <option ${config.provider === 'Twilio' ? 'selected' : ''}>Twilio</option>
                                    <option ${config.provider === 'MessageBird' ? 'selected' : ''}>MessageBird</option>
                                    <option ${config.provider === 'Vonage' ? 'selected' : ''}>Vonage</option>
                                    <option ${config.provider === 'Custom' ? 'selected' : ''}>Custom Gateway</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">API Key</label>
                                <input type="password" id="sms-apikey" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.apiKey || ''}" placeholder="API Key">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Sender ID</label>
                                <input type="text" id="sms-sender" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.senderId || 'UNIVA-GW'}" placeholder="Sender ID">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Phone Numbers</label>
                                <input type="text" id="sms-numbers" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm" value="${config.phoneNumbers || '+919876543210'}" placeholder="+919876543210, +971501234567">
                            </div>
                        </div>
                    `;
                    
                default:
                    return `
                        <div class="text-center py-8 text-slate-400">
                            <i class="fa-solid fa-sliders text-2xl mb-2"></i>
                            <p>Configuration for ${channelType} will be available soon</p>
                        </div>
                    `;
            }
        }

        function updateChannelConfigForm(channelType) {
            const configForm = document.getElementById('channel-config-form');
            if (!configForm) return;
            
            const channel = editingChannelId ? channels.find(c => c.id === editingChannelId) : null;
            configForm.innerHTML = getConfigHTML(channelType, channel);
        }

        function saveNewChannel() {
            const nameInput = document.getElementById('channel-name');
            const typeSelect = document.getElementById('channel-type');
            const enabledInput = document.getElementById('channel-enabled');
            
            if (!nameInput.value.trim()) {
                showToast('Please enter a channel name', 'error');
                return;
            }
            
            const channelType = typeSelect.value;
            let config = {};
            
            // Get configuration based on channel type
            switch(channelType) {
                case 'mqtt':
                    config = {
                        brokerUrl: document.getElementById('mqtt-broker').value,
                        topic: document.getElementById('mqtt-topic').value,
                        username: document.getElementById('mqtt-username').value,
                        password: document.getElementById('mqtt-password').value
                    };
                    break;
                    
                case 'email':
                    config = {
                        smtpServer: document.getElementById('email-smtp').value,
                        port: parseInt(document.getElementById('email-port').value) || 587,
                        username: document.getElementById('email-username').value,
                        password: document.getElementById('email-password').value,
                        fromEmail: document.getElementById('email-from').value,
                        toEmails: document.getElementById('email-to').value
                    };
                    break;
                    
                case 'sms':
                    config = {
                        provider: document.getElementById('sms-provider').value,
                        apiKey: document.getElementById('sms-apikey').value,
                        senderId: document.getElementById('sms-sender').value,
                        phoneNumbers: document.getElementById('sms-numbers').value
                    };
                    break;
            }
            
            const newChannel = {
                id: `${channelType}-${Date.now()}`,
                name: nameInput.value,
                type: channelType,
                status: enabledInput.checked ? 'active' : 'inactive',
                config: config
            };
            
            channels.push(newChannel);
            saveChannels();
            renderChannelsList();
            updateChannelsOnline();
            closeModal();
            showToast(`Added new ${channelType.toUpperCase()} channel: ${nameInput.value}`, 'success');
        }

        function saveChannelEdit(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            const nameInput = document.getElementById('channel-name');
            const typeSelect = document.getElementById('channel-type');
            const enabledInput = document.getElementById('channel-enabled');
            
            if (!nameInput.value.trim()) {
                showToast('Please enter a channel name', 'error');
                return;
            }
            
            channel.name = nameInput.value;
            channel.type = typeSelect.value;
            channel.status = enabledInput.checked ? 'active' : 'inactive';
            
            // Update configuration based on channel type
            switch(channel.type) {
                case 'mqtt':
                    channel.config = {
                        brokerUrl: document.getElementById('mqtt-broker').value,
                        topic: document.getElementById('mqtt-topic').value,
                        username: document.getElementById('mqtt-username').value,
                        password: document.getElementById('mqtt-password').value
                    };
                    break;
                    
                case 'email':
                    channel.config = {
                        smtpServer: document.getElementById('email-smtp').value,
                        port: parseInt(document.getElementById('email-port').value) || 587,
                        username: document.getElementById('email-username').value,
                        password: document.getElementById('email-password').value,
                        fromEmail: document.getElementById('email-from').value,
                        toEmails: document.getElementById('email-to').value
                    };
                    break;
                    
                case 'sms':
                    channel.config = {
                        provider: document.getElementById('sms-provider').value,
                        apiKey: document.getElementById('sms-apikey').value,
                        senderId: document.getElementById('sms-sender').value,
                        phoneNumbers: document.getElementById('sms-numbers').value
                    };
                    break;
            }
            
            saveChannels();
            renderChannelsList();
            updateChannelsOnline();
            closeModal();
            showToast(`Updated ${channel.type.toUpperCase()} channel: ${channel.name}`, 'success');
        }

        function toggleChannelStatus(channelId) {
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            const action = channel.status === 'active' ? 'deactivate' : 'activate';
            
            showConfirmation(
                `${action === 'activate' ? 'Activate' : 'Deactivate'} Channel`,
                `Are you sure you want to ${action} ${channel.name}?`,
                () => {
                    channel.status = action === 'activate' ? 'active' : 'inactive';
                    saveChannels();
                    renderChannelsList();
                    updateChannelsOnline();
                    showToast(`Channel ${action}d successfully`, 'success');
                }
            );
        }

        // ========== TEST CHANNEL FUNCTIONS ==========
        function testChannel(channelType) {
            const alertSelect = document.getElementById('test-alert-select');
            const deviceInput = document.getElementById('test-device');
            
            if (!alertSelect.value || alertSelect.value === 'go-to-alerts') {
                showToast('Please select an alert message first', 'warning');
                if (alertSelect.value === 'go-to-alerts') {
                    window.location.href = 'alerts.html';
                }
                return;
            }
            
            // Get alert message from localStorage
            const alertMessages = getAlertMessages();
            const alert = alertMessages.find(a => a.id == alertSelect.value);
            
            if (!alert) {
                showToast('Alert message not found', 'error');
                return;
            }
            
            // Get channel configuration
            const channel = channels.find(c => c.type === channelType);
            if (!channel) {
                showToast(`${channelType.toUpperCase()} channel not configured`, 'error');
                return;
            }
            
            if (channel.status !== 'active') {
                showToast(`${channelType.toUpperCase()} channel is not active`, 'warning');
                return;
            }
            
            // Get variables from alert message
            const variables = extractVariablesFromAlert(alert);
            
            // Create sample values for variables
            const sampleValues = {
                device: deviceInput.value || 'Crane_01',
                value: '85.6',
                unit: '°C',
                timestamp: new Date().toLocaleString(),
                location: 'Factory Floor - Zone B',
                severity: 'CRITICAL',
                operator: 'John Doe',
                threshold: '80',
                status: 'EXCEEDED',
                alert_name: alert.name,
                alert_id: 'test-' + Date.now(),
                gateway_id: 'UNIVA-GW-01'
            };
            
            // Replace variables in the alert message
            let formattedMessage = alert.message;
            variables.forEach(variable => {
                const value = sampleValues[variable] || `[${variable}]`;
                formattedMessage = formattedMessage.replace(new RegExp(`\\{${variable}\\}`, 'g'), value);
            });
            
            // Show test result
            showModal(
                `Test ${channelType.toUpperCase()} Channel`,
                `
                <div class="space-y-4">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="font-medium text-green-800 mb-2">Test Notification Sent</h4>
                        <p class="text-sm text-green-700">Using alert: <strong>"${alert.name}"</strong></p>
                        <p class="text-xs text-green-600 mt-1">Channel: ${channel.name}</p>
                    </div>
                    
                    <div>
                        <h5 class="text-sm font-medium text-slate-700 mb-1">Alert Message (with variables replaced):</h5>
                        <div class="bg-slate-50 border border-slate-200 rounded p-3 text-sm">
                            ${formattedMessage}
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="text-sm font-medium text-slate-700 mb-1">Channel Configuration:</h5>
                        <div class="text-xs text-slate-600">
                            ${getConnectionInfo(channel)}
                        </div>
                    </div>
                </div>
                `,
                [
                    { text: 'Close', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' }
                ],
                '600px'
            );
            
            showToast(`${channelType.toUpperCase()} test sent using "${alert.name}"`, 'success');
        }

        function testAllChannels() {
            showToast('Testing all active channels...', 'info');
            
            setTimeout(() => {
                const activeChannels = channels.filter(c => c.status === 'active');
                
                let resultsHTML = '<div class="space-y-3">';
                activeChannels.forEach(channel => {
                    resultsHTML += `
                        <div class="flex items-center justify-between p-2 border-b border-slate-100">
                            <span class="text-sm text-slate-700">${channel.name} (${channel.type.toUpperCase()})</span>
                            <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded">✓ Sent</span>
                        </div>
                    `;
                });
                
                if (activeChannels.length === 0) {
                    resultsHTML += `
                        <div class="text-center py-4 text-slate-400">
                            <i class="fa-solid fa-sliders text-2xl mb-2"></i>
                            <p>No active channels to test</p>
                            <p class="text-xs mt-1">Enable channels by clicking "Add Channel"</p>
                        </div>
                    `;
                }
                
                resultsHTML += '</div>';
                
                showModal(
                    'Channel Test Results',
                    resultsHTML,
                    [
                        { text: 'Close', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' }
                    ]
                );
            }, 1500);
        }

        function loadAlertMessagesForTest() {
            try {
                const alertMessages = getAlertMessages();
                const select = document.getElementById('test-alert-select');
                
                if (select) {
                    if (alertMessages.length > 0) {
                        select.innerHTML = `
                            <option value="">-- Select an alert message to test --</option>
                            ${alertMessages.map(alert => {
                                const variables = extractVariablesFromAlert(alert);
                                const preview = alert.message.substring(0, 60) + (alert.message.length > 60 ? '...' : '');
                                return `
                                    <option value="${alert.id}">
                                        ${alert.name} (${variables.length} variables) - "${preview}"
                                    </option>
                                `;
                            }).join('')}
                        `;
                        
                        // Add event listener to show variables when alert is selected
                        select.addEventListener('change', function() {
                            const selectedAlert = alertMessages.find(a => a.id == this.value);
                            if (selectedAlert) {
                                showSelectedAlertVariables(selectedAlert);
                            }
                        });
                    } else {
                        select.innerHTML = `
                            <option value="">No alert messages found</option>
                            <option value="go-to-alerts">Go to Alerts section to create messages</option>
                        `;
                    }
                }
            } catch (e) {
                console.error('Error loading alert messages:', e);
            }
        }

        function showSelectedAlertVariables(alert) {
            const variables = extractVariablesFromAlert(alert);
            const container = document.getElementById('selected-alert-variables');
            
            if (container) {
                container.innerHTML = `
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-circle-info text-blue-500 mt-0.5"></i>
                        <div>
                            <p class="text-sm font-medium text-blue-800">Selected Alert: "${alert.name}"</p>
                            <p class="text-xs text-blue-700 mt-1">Message: "${alert.message}"</p>
                            <div class="mt-2">
                                <p class="text-xs font-medium text-slate-700">Variables that will be replaced:</p>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${variables.map(v => `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded">${v}</span>`).join('')}
                                </div>
                                <p class="text-xs text-slate-600 mt-2">These variables will be replaced with actual values when sent through channels.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadSidebar();
            loadChannels();
            loadAlertMessagesForTest();
            
            // Initialize gateway select
            const gatewaySelect = document.getElementById('gateway-select');
            if (gatewaySelect) {
                gatewaySelect.addEventListener('change', function() {
                    showConfirmation(
                        'Switch Gateway',
                        'Switch to another gateway? Channel configurations will be lost.',
                        () => {
                            location.reload();
                        }
                    );
                });
            }
            
            // Add click outside handler for sidebar
            document.addEventListener('click', handleSidebarClickOutside);
            
            // Initial responsive setup
            setTimeout(() => {
                if (window.innerWidth <= 1024) {
                    document.getElementById('sidebar')?.classList.add('active');
                }
            }, 100);
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                showToast('Configuration saved!', 'success');
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeModal();
                closeConfirmation();
            }
        });
    </script>
</body>
</html>