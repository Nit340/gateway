<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert Messages - Univa Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        secondary: '#475569',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6',
                        critical: '#DC2626',
                        surface: '#F8FAFC',
                        card: '#FFFFFF',
                        border: '#E2E8F0',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #1E293B; }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #E2E8F0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            color: #2563EB;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748B;
            padding: 0 20px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #F8FAFC;
            color: #2563EB;
        }
        
        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            border-left-color: #2563EB;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #E2E8F0;
            background: white;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 260px;
            top: 20px;
            z-index: 100;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 8px;
            cursor: pointer;
            color: #64748B;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 260px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-260px);
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 260px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Card styles */
        .card {
            @apply bg-white rounded-xl border border-border shadow-sm;
        }
        
        .card-header {
            @apply px-6 py-4 border-b border-border bg-slate-50 flex justify-between items-center;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 300px;
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            border-left: 4px solid #10B981;
        }
        
        .toast-error {
            border-left: 4px solid #EF4444;
        }
        
        .toast-warning {
            border-left: 4px solid #F59E0B;
        }
        
        .toast-info {
            border-left: 4px solid #2563EB;
        }
        
        /* Severity Color Indicators */
        .severity-5 { background-color: #DC2626; color: white; }
        .severity-4 { background-color: #F97316; color: white; }
        .severity-3 { background-color: #F59E0B; color: #1E293B; }
        .severity-2 { background-color: #3B82F6; color: white; }
        .severity-1 { background-color: #10B981; color: white; }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background-color: #F8FAFC;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #E2E8F0;
        }
        
        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid #F1F5F9;
            font-size: 14px;
        }
        
        .table tr:hover {
            background-color: #F8FAFC;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #E2E8F0;
            border-top-color: #2563EB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Color Picker */
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-option.selected {
            border-color: #1E293B;
            transform: scale(1.1);
        }
        
        /* Variable Buttons */
        .variable-btn {
            @apply px-3 py-1.5 bg-blue-50 text-blue-700 text-xs font-medium rounded-lg border border-blue-200 hover:bg-blue-100 transition-colors cursor-pointer;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    
    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <header id="header" class="bg-white border-b border-border sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <!-- Left: Logo & Breadcrumb -->
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center text-sm text-slate-500 h-6">
                        <span><i class="fa-solid fa-plug mr-2"></i>Univa Gateway</span>
                        <i class="fa-solid fa-chevron-right text-xs mx-2"></i>
                        <span class="text-slate-900 font-medium" id="page-title">Alert Messages</span>
                    </div>
                </div>

                <!-- Right: Controls -->
                <div class="flex items-center space-x-4">
                    <div class="relative hidden sm:block">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-server text-slate-400 text-sm"></i>
                        </div>
                        <select id="gateway-select" class="pl-9 pr-8 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-slate-50 text-slate-700 font-medium cursor-pointer hover:bg-white transition-colors">
                            <option>Univa-GW-01</option>
                            <option>Univa-GW-02</option>
                            <option>Univa-GW-03</option>
                        </select>
                    </div>
                    <div class="h-6 w-px bg-slate-200 mx-2 hidden sm:block"></div>
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 transition-colors">
                        <i class="fa-solid fa-circle-question mr-2"></i> Help
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto p-6 space-y-8">
            
            <!-- Page Title & Description -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Alert Messages</h1>
                    <p class="text-slate-500 text-sm mt-1">Define alert severity classes and message templates</p>
                </div>
                <div class="flex gap-2">
                    <button class="inline-flex items-center px-4 py-2 bg-slate-100 text-slate-700 text-sm font-medium rounded-lg hover:bg-slate-200 transition" onclick="exportConfiguration()">
                        <i class="fa-solid fa-download mr-2"></i> Export Config
                    </button>
                    <button class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primaryHover transition shadow-sm" onclick="showLivePreview()">
                        <i class="fa-solid fa-eye mr-2"></i> Live Preview
                    </button>
                </div>
            </div>

            <!-- Section 1: Alert Classes -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Alert Classes</h2>
                        <p class="text-sm text-slate-500">Define severity levels with visual properties</p>
                    </div>
                    <button class="inline-flex items-center px-3 py-1.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primaryHover transition" onclick="showAddAlertClassModal()">
                        <i class="fa-solid fa-plus mr-2"></i> Add Class
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Class Name</th>
                                <th>Severity</th>
                                <th>Color</th>
                                <th>Icon</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alert-classes-table">
                            <!-- Alert classes will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Section 2: Alert Messages -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-800">Alert Messages</h2>
                        <p class="text-sm text-slate-500">Create message templates with delivery channels</p>
                    </div>
                    <button class="inline-flex items-center px-3 py-1.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primaryHover transition" onclick="showAddAlertMessageModal()">
                        <i class="fa-solid fa-plus mr-2"></i> Add Message
                    </button>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Alert Name</th>
                                <th>Message Template</th>
                                <th>Class</th>
                                <th>Channels</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alert-messages-table">
                            <!-- Alert messages will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== GLOBAL STATE ==========
        let alertClasses = [];
        let alertMessages = [];
        
        // Color options for alert classes
        const colorOptions = [
            { name: 'Red', value: '#DC2626' },
            { name: 'Orange', value: '#F97316' },
            { name: 'Amber', value: '#F59E0B' },
            { name: 'Blue', value: '#3B82F6' },
            { name: 'Green', value: '#10B981' },
            { name: 'Purple', value: '#8B5CF6' },
            { name: 'Pink', value: '#EC4899' },
            { name: 'Gray', value: '#6B7280' }
        ];
        
        // Available variables for message templates
        const availableVariables = [
            { name: 'device', description: 'Device name' },
            { name: 'value', description: 'Current value' },
            { name: 'unit', description: 'Measurement unit' },
            { name: 'timestamp', description: 'Time of alert' },
            { name: 'location', description: 'Device location' },
            { name: 'tag', description: 'Tag/parameter name' },
            { name: 'threshold', description: 'Trigger threshold' },
            { name: 'operator', description: 'Operator (>, <, =)' },
            { name: 'limit', description: 'Limit value' },
            { name: 'duration', description: 'Duration of condition' }
        ];
        
        // Default alert classes
        const defaultAlertClasses = [
            {
                id: 1,
                name: 'Critical',
                severity: 5,
                color: '#DC2626',
                icon: 'fa-triangle-exclamation',
                description: 'Immediate action required'
            },
            {
                id: 2,
                name: 'High',
                severity: 4,
                color: '#F97316',
                icon: 'fa-circle-exclamation',
                description: 'Attention required soon'
            },
            {
                id: 3,
                name: 'Warning',
                severity: 3,
                color: '#F59E0B',
                icon: 'fa-exclamation',
                description: 'Monitor situation'
            },
            {
                id: 4,
                name: 'Info',
                severity: 2,
                color: '#3B82F6',
                icon: 'fa-circle-info',
                description: 'Informational message'
            },
            {
                id: 5,
                name: 'Low',
                severity: 1,
                color: '#10B981',
                icon: 'fa-circle-check',
                description: 'Normal operation information'
            }
        ];
        
        // Default alert messages
        const defaultAlertMessages = [
            {
                id: 1,
                name: 'Critical Temperature',
                message: 'üî• CRITICAL: {device} temperature is {value}¬∞C (Threshold: {threshold}¬∞C)',
                classId: 1,
                channels: ['mqtt', 'email', 'sms', 'dashboard']
            },
            {
                id: 2,
                name: 'Device Offline',
                message: 'üì¥ {device} is offline at {timestamp}',
                classId: 2,
                channels: ['email', 'dashboard']
            },
            {
                id: 3,
                name: 'High Vibration',
                message: '‚ö†Ô∏è WARNING: {device} vibration is {value} mm/s',
                classId: 3,
                channels: ['mqtt', 'email', 'dashboard']
            },
            {
                id: 4,
                name: 'Low Battery',
                message: 'üîã {device} battery is at {value}%',
                classId: 4,
                channels: ['dashboard']
            },
            {
                id: 5,
                name: 'System Startup',
                message: '‚úÖ {device} started successfully at {timestamp}',
                classId: 5,
                channels: ['dashboard']
            }
        ];
        
        // ========== SIDEBAR FUNCTIONS ==========
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) throw new Error(`Failed to load sidebar: ${response.status}`);
                document.getElementById('sidebar-container').innerHTML = await response.text();
                updateActivePage();
                initializeSidebar();
            } catch (error) {
                console.error('Error loading sidebar:', error);
                createFallbackSidebar();
            }
        }
        
        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-satellite-dish mr-2"></i> Univa Gateway
                        </div>
                    </div>
                    
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i> General Configuration
                            </a>
                            <a href="device-management.html" class="nav-item">
                                <i class="fa-solid fa-microchip"></i> Device Management
                            </a>
                            <a href="rules-engine.html" class="nav-item">
                                <i class="fa-solid fa-robot"></i> Rules Engine
                            </a>
                            <a href="protocol-mapping.html" class="nav-item">
                                <i class="fa-solid fa-exchange-alt"></i> Protocol Mapping
                            </a>
                        </div>
                        
                        <div class="nav-section">
                            <div class="section-title">Automation & Event Engine</div>
                            <a href="#" class="nav-item active">
                                <i class="fa-solid fa-bell"></i> Alert Messages
                            </a>
                            <a href="notification-channels.html" class="nav-item">
                                <i class="fa-solid fa-broadcast-tower"></i> Notification Channels
                            </a>
                        </div>
                        
                        <div class="nav-section">
                            <div class="section-title">Monitoring</div>
                            <a href="dashboard.html" class="nav-item">
                                <i class="fa-solid fa-gauge-high"></i> Dashboard
                            </a>
                            <a href="reports.html" class="nav-item">
                                <i class="fa-solid fa-chart-line"></i> Reports & Analytics
                            </a>
                        </div>
                    </div>
                    
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4 class="font-medium text-slate-900">Admin User</h4>
                                <p class="text-xs text-slate-500">System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }
        
        function updateActivePage() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            const alertsLink = Array.from(navItems).find(item => 
                item.textContent.includes('Alert Messages') || 
                item.querySelector('i.fa-bell')
            );
            if (alertsLink) alertsLink.classList.add('active');
        }
        
        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (!sidebar || !sidebarToggle) return;
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                const icon = this.querySelector('i');
                icon.className = sidebar.classList.contains('active') ? 'fa-solid fa-times' : 'fa-solid fa-bars';
            });
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            }
            
            window.addEventListener('resize', handleResponsive);
            document.addEventListener('click', handleSidebarClickOutside);
        }
        
        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '260px';
            }
        }
        
        function handleSidebarClickOutside(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile && sidebar.classList.contains('active')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                    sidebarToggle.style.left = '0';
                }
            }
        }
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadSidebar();
            loadData();
            
            // Initialize gateway select
            const gatewaySelect = document.getElementById('gateway-select');
            if (gatewaySelect) {
                gatewaySelect.addEventListener('change', function() {
                    showConfirmation('Switch Gateway', 'Switch to another gateway? Unsaved changes will be lost.', () => {
                        location.reload();
                    });
                });
            }
        });
        
        // ========== DATA LOADING ==========
        function loadData() {
            // Load alert classes
            alertClasses = JSON.parse(localStorage.getItem('univa_alert_classes')) || defaultAlertClasses;
            
            // Load alert messages
            alertMessages = JSON.parse(localStorage.getItem('univa_alert_messages')) || defaultAlertMessages;
            
            renderAlertClassesTable();
            renderAlertMessagesTable();
        }
        
        function saveData() {
            localStorage.setItem('univa_alert_classes', JSON.stringify(alertClasses));
            localStorage.setItem('univa_alert_messages', JSON.stringify(alertMessages));
        }
        
        // ========== ALERT CLASSES FUNCTIONS ==========
        function renderAlertClassesTable() {
            const table = document.getElementById('alert-classes-table');
            if (!table) return;
            
            table.innerHTML = alertClasses.map(alertClass => `
                <tr>
                    <td class="font-medium">
                        ${alertClass.name}
                        <div class="text-xs text-slate-500">${alertClass.description}</div>
                    </td>
                    <td>
                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full severity-${alertClass.severity} font-bold">
                            ${alertClass.severity}
                        </span>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background-color: ${alertClass.color}"></div>
                            <span class="text-xs text-slate-600">${alertClass.color}</span>
                        </div>
                    </td>
                    <td>
                        <i class="fa-solid ${alertClass.icon}" style="color: ${alertClass.color}"></i>
                    </td>
                    <td>
                        <span class="text-xs text-slate-600">${alertClass.description}</span>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button class="text-slate-400 hover:text-primary" onclick="editAlertClass(${alertClass.id})">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="text-slate-400 hover:text-danger" onclick="deleteAlertClass(${alertClass.id})" ${alertClass.id <= 5 ? 'disabled' : ''}>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddAlertClassModal() {
            showModal(
                'Create Alert Class',
                getAlertClassFormHTML(),
                [
                    { text: 'Cancel', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' },
                    { text: 'Create Class', onclick: 'saveAlertClass()', className: 'px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors' }
                ]
            );
            
            // Initialize severity slider
            setTimeout(() => {
                const slider = document.getElementById('class-severity');
                const valueDisplay = document.getElementById('severity-value');
                if (slider && valueDisplay) {
                    const updateSeverity = () => {
                        const value = slider.value;
                        valueDisplay.textContent = value;
                        valueDisplay.className = `w-8 h-8 rounded-full severity-${value} flex items-center justify-center font-bold`;
                    };
                    
                    updateSeverity();
                    slider.addEventListener('input', updateSeverity);
                }
            }, 10);
        }
        
        function getAlertClassFormHTML(alertClass = null) {
            const isEdit = alertClass !== null;
            
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Class Name</label>
                        <input type="text" id="class-name" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border" value="${isEdit ? alertClass.name : ''}" placeholder="e.g., Critical, Warning, Info">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                        <input type="text" id="class-description" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border" value="${isEdit ? alertClass.description : ''}" placeholder="e.g., Immediate action required">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Severity Level (1-5)</label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="class-severity" min="1" max="5" value="${isEdit ? alertClass.severity : 3}" class="flex-1">
                            <span id="severity-value" class="w-8 h-8 rounded-full severity-${isEdit ? alertClass.severity : 3} flex items-center justify-center font-bold">${isEdit ? alertClass.severity : 3}</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>1 - Low</span>
                            <span>2 - Info</span>
                            <span>3 - Warning</span>
                            <span>4 - High</span>
                            <span>5 - Critical</span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Color Code</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${colorOptions.map(color => `
                                <div class="color-option ${isEdit && alertClass.color === color.value ? 'selected' : ''}" 
                                     style="background-color: ${color.value}"
                                     onclick="selectColor('${color.value}')"
                                     title="${color.name}">
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" id="selected-color" value="${isEdit ? alertClass.color : '#3B82F6'}">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Icon</label>
                        <select id="class-icon" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border">
                            <option value="fa-triangle-exclamation" ${isEdit && alertClass.icon === 'fa-triangle-exclamation' ? 'selected' : ''}>‚ö†Ô∏è Critical</option>
                            <option value="fa-circle-exclamation" ${isEdit && alertClass.icon === 'fa-circle-exclamation' ? 'selected' : ''}>‚ùó High</option>
                            <option value="fa-exclamation" ${isEdit && alertClass.icon === 'fa-exclamation' ? 'selected' : ''}>‚ö†Ô∏è Warning</option>
                            <option value="fa-circle-info" ${isEdit && alertClass.icon === 'fa-circle-info' ? 'selected' : ''}>‚ÑπÔ∏è Info</option>
                            <option value="fa-circle-check" ${isEdit && alertClass.icon === 'fa-circle-check' ? 'selected' : ''}>‚úÖ Low</option>
                            <option value="fa-fire" ${isEdit && alertClass.icon === 'fa-fire' ? 'selected' : ''}>üî• Fire/Temperature</option>
                            <option value="fa-plug-circle-xmark" ${isEdit && alertClass.icon === 'fa-plug-circle-xmark' ? 'selected' : ''}>üîå Power/Device</option>
                            <option value="fa-wave-square" ${isEdit && alertClass.icon === 'fa-wave-square' ? 'selected' : ''}>üìà Vibration</option>
                            <option value="fa-battery" ${isEdit && alertClass.icon === 'fa-battery' ? 'selected' : ''}>üîã Battery</option>
                            <option value="fa-network-wired" ${isEdit && alertClass.icon === 'fa-network-wired' ? 'selected' : ''}>üåê Network</option>
                        </select>
                    </div>
                </div>
            `;
        }
        
        function selectColor(color) {
            document.getElementById('selected-color').value = color;
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.style.backgroundColor === color || option.style.backgroundColor === `rgb(${hexToRgb(color).join(', ')})`) {
                    option.classList.add('selected');
                }
            });
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [0, 0, 0];
        }
        
        function saveAlertClass() {
            const name = document.getElementById('class-name').value;
            const description = document.getElementById('class-description').value;
            const severity = parseInt(document.getElementById('class-severity').value);
            const color = document.getElementById('selected-color').value;
            const icon = document.getElementById('class-icon').value;
            
            if (!name) {
                showToast('Please enter a class name', 'error');
                return;
            }
            
            const newAlertClass = {
                id: alertClasses.length > 0 ? Math.max(...alertClasses.map(c => c.id)) + 1 : 1,
                name,
                description,
                severity,
                color,
                icon
            };
            
            alertClasses.push(newAlertClass);
            saveData();
            renderAlertClassesTable();
            closeModal();
            showToast(`Alert class "${name}" created successfully`, 'success');
        }
        
        function editAlertClass(id) {
            const alertClass = alertClasses.find(c => c.id === id);
            if (!alertClass) return;
            
            showModal(
                `Edit Alert Class: ${alertClass.name}`,
                getAlertClassFormHTML(alertClass),
                [
                    { text: 'Cancel', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' },
                    { text: 'Save Changes', onclick: `updateAlertClass(${id})`, className: 'px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors' }
                ]
            );
            
            // Initialize severity slider
            setTimeout(() => {
                const slider = document.getElementById('class-severity');
                const valueDisplay = document.getElementById('severity-value');
                if (slider && valueDisplay) {
                    const updateSeverity = () => {
                        const value = slider.value;
                        valueDisplay.textContent = value;
                        valueDisplay.className = `w-8 h-8 rounded-full severity-${value} flex items-center justify-center font-bold`;
                    };
                    
                    updateSeverity();
                    slider.addEventListener('input', updateSeverity);
                }
            }, 10);
        }
        
        function updateAlertClass(id) {
            const alertClass = alertClasses.find(c => c.id === id);
            if (!alertClass) return;
            
            alertClass.name = document.getElementById('class-name').value;
            alertClass.description = document.getElementById('class-description').value;
            alertClass.severity = parseInt(document.getElementById('class-severity').value);
            alertClass.color = document.getElementById('selected-color').value;
            alertClass.icon = document.getElementById('class-icon').value;
            
            saveData();
            renderAlertClassesTable();
            renderAlertMessagesTable(); // Update messages that use this class
            closeModal();
            showToast(`Alert class "${alertClass.name}" updated successfully`, 'success');
        }
        
        function deleteAlertClass(id) {
            if (id <= 5) {
                showToast('Default alert classes cannot be deleted', 'warning');
                return;
            }
            
            // Check if any messages are using this class
            const messagesUsingClass = alertMessages.filter(m => m.classId === id);
            if (messagesUsingClass.length > 0) {
                showToast(`Cannot delete: ${messagesUsingClass.length} message(s) are using this class`, 'error');
                return;
            }
            
            showConfirmation(
                'Delete Alert Class',
                'Are you sure you want to delete this alert class?',
                () => {
                    const alertClass = alertClasses.find(c => c.id === id);
                    if (alertClass) {
                        alertClasses = alertClasses.filter(c => c.id !== id);
                        saveData();
                        renderAlertClassesTable();
                        showToast(`Alert class "${alertClass.name}" deleted`, 'success');
                    }
                }
            );
        }
        
        // ========== ALERT MESSAGES FUNCTIONS ==========
        function renderAlertMessagesTable() {
            const table = document.getElementById('alert-messages-table');
            if (!table) return;
            
            table.innerHTML = alertMessages.map(alert => {
                const alertClass = alertClasses.find(c => c.id === alert.classId);
                
                return `
                    <tr>
                        <td class="font-medium">${alert.name}</td>
                        <td>
                            <div class="text-sm font-mono bg-slate-50 p-2 rounded">
                                ${alert.message}
                            </div>
                        </td>
                        <td>
                            ${alertClass ? `
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid ${alertClass.icon}" style="color: ${alertClass.color}"></i>
                                    <span class="text-sm">${alertClass.name}</span>
                                </div>
                            ` : '<span class="text-sm text-slate-500">Unknown</span>'}
                        </td>
                        <td>
                            <div class="flex flex-wrap gap-1">
                                ${alert.channels.map(channel => `
                                    <span class="text-xs px-2 py-0.5 rounded ${getChannelColor(channel)}">
                                        ${channel}
                                    </span>
                                `).join('')}
                            </div>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button class="text-slate-400 hover:text-primary" onclick="editAlertMessage(${alert.id})">
                                    <i class="fa-solid fa-edit"></i>
                                </button>
                                <button class="text-slate-400 hover:text-danger" onclick="deleteAlertMessage(${alert.id})" ${alert.id <= 5 ? 'disabled' : ''}>
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getChannelColor(channel) {
            const colors = {
                mqtt: 'bg-purple-100 text-purple-700',
                email: 'bg-blue-100 text-blue-700',
                sms: 'bg-green-100 text-green-700',
                dashboard: 'bg-orange-100 text-orange-700',
                webhook: 'bg-pink-100 text-pink-700'
            };
            return colors[channel] || 'bg-slate-100 text-slate-700';
        }
        
        function showAddAlertMessageModal() {
            showModal(
                'Create Alert Message',
                getAlertMessageFormHTML(),
                [
                    { text: 'Cancel', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' },
                    { text: 'Create Message', onclick: 'saveAlertMessage()', className: 'px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors' }
                ]
            );
        }
        
        function getAlertMessageFormHTML(alert = null) {
            const isEdit = alert !== null;
            
            return `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Alert Name</label>
                        <input type="text" id="alert-name" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border" value="${isEdit ? alert.name : ''}" placeholder="e.g., High Temperature Alert">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Alert Class</label>
                        <select id="alert-class" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border">
                            <option value="">Select a class...</option>
                            ${alertClasses.map(c => `
                                <option value="${c.id}" ${isEdit && alert.classId === c.id ? 'selected' : ''}>
                                    ${c.name} (Severity: ${c.severity})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Message Template</label>
                        <textarea id="alert-message" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border h-32" placeholder="e.g., üî• {device} is at {value}¬∞C">${isEdit ? alert.message : ''}</textarea>
                        
                        <div class="mt-2">
                            <p class="text-xs text-slate-600 mb-2">Click variables to insert:</p>
                            <div class="flex flex-wrap gap-2">
                                ${availableVariables.map(variable => `
                                    <button type="button" class="variable-btn" onclick="insertVariable('${variable.name}')" title="${variable.description}">
                                        {${variable.name}}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Delivery Channels</label>
                        <div class="grid grid-cols-3 gap-2">
                            ${['mqtt', 'email', 'sms', 'dashboard', 'webhook'].map(channel => {
                                const isChecked = isEdit ? alert.channels.includes(channel) : channel === 'mqtt' || channel === 'dashboard';
                                
                                return `
                                    <label class="flex items-center p-2 border border-slate-200 rounded hover:bg-slate-50 cursor-pointer">
                                        <input type="checkbox" value="${channel}" class="rounded border-slate-300 text-primary focus:ring-primary" ${isChecked ? 'checked' : ''}>
                                        <span class="ml-2 text-sm text-slate-700">${channel}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function insertVariable(variableName) {
            const textarea = document.getElementById('alert-message');
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const before = text.substring(0, start);
            const after = text.substring(end);
            
            textarea.value = before + `{${variableName}}` + after;
            textarea.focus();
            textarea.selectionStart = textarea.selectionEnd = start + variableName.length + 2;
            
            // Trigger input event for any listeners
            textarea.dispatchEvent(new Event('input'));
        }
        
        function saveAlertMessage() {
            const name = document.getElementById('alert-name').value;
            const message = document.getElementById('alert-message').value;
            const classId = parseInt(document.getElementById('alert-class').value);
            
            // Get selected channels
            const channelCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const channels = Array.from(channelCheckboxes).map(cb => cb.value);
            
            if (!name || !message) {
                showToast('Please enter alert name and message', 'error');
                return;
            }
            
            if (!classId) {
                showToast('Please select an alert class', 'error');
                return;
            }
            
            if (channels.length === 0) {
                showToast('Please select at least one delivery channel', 'error');
                return;
            }
            
            const newAlert = {
                id: alertMessages.length > 0 ? Math.max(...alertMessages.map(a => a.id)) + 1 : 1,
                name,
                message,
                classId,
                channels
            };
            
            alertMessages.push(newAlert);
            saveData();
            renderAlertMessagesTable();
            closeModal();
            showToast(`Alert message "${name}" created successfully`, 'success');
        }
        
        function editAlertMessage(id) {
            const alert = alertMessages.find(a => a.id === id);
            if (!alert) return;
            
            showModal(
                `Edit Alert Message: ${alert.name}`,
                getAlertMessageFormHTML(alert),
                [
                    { text: 'Cancel', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' },
                    { text: 'Save Changes', onclick: `updateAlertMessage(${id})`, className: 'px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors' }
                ]
            );
        }
        
        function updateAlertMessage(id) {
            const alert = alertMessages.find(a => a.id === id);
            if (!alert) return;
            
            alert.name = document.getElementById('alert-name').value;
            alert.message = document.getElementById('alert-message').value;
            alert.classId = parseInt(document.getElementById('alert-class').value);
            
            // Get selected channels
            const channelCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            alert.channels = Array.from(channelCheckboxes).map(cb => cb.value);
            
            saveData();
            renderAlertMessagesTable();
            closeModal();
            showToast(`Alert message "${alert.name}" updated successfully`, 'success');
        }
        
        function deleteAlertMessage(id) {
            if (id <= 5) {
                showToast('Default alert messages cannot be deleted', 'warning');
                return;
            }
            
            showConfirmation(
                'Delete Alert Message',
                'Are you sure you want to delete this alert message? Rules using this message will need to be updated.',
                () => {
                    const alert = alertMessages.find(a => a.id === id);
                    if (alert) {
                        alertMessages = alertMessages.filter(a => a.id !== id);
                        saveData();
                        renderAlertMessagesTable();
                        showToast(`Alert message "${alert.name}" deleted`, 'success');
                    }
                }
            );
        }
        
        // ========== MODAL FUNCTIONS ==========
        function showModal(title, content, buttons = []) {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-800">${title}</h3>
                    <button class="text-slate-400 hover:text-slate-600" onclick="closeModal()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                ${buttons.length > 0 ? `
                <div class="modal-footer">
                    ${buttons.map(btn => `
                        <button onclick="${btn.onclick}" class="${btn.className}">
                            ${btn.text}
                        </button>
                    `).join('')}
                </div>` : ''}
            `;
            
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        function showConfirmation(title, message, onConfirm) {
            const confirmed = confirm(`${title}\n\n${message}`);
            if (confirmed && onConfirm) {
                onConfirm();
            }
        }
        
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${type === 'success' ? 'fa-check-circle text-green-500' : type === 'error' ? 'fa-exclamation-circle text-red-500' : type === 'warning' ? 'fa-exclamation-triangle text-yellow-500' : 'fa-info-circle text-blue-500'}"></i>
                <span>${message}</span>
                <button class="ml-auto text-slate-400 hover:text-slate-600" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 5000);
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function resetConfiguration() {
            showConfirmation(
                'Reset Configuration',
                'Are you sure you want to reset all alert classes and messages to defaults? This will delete all custom configurations.',
                () => {
                    localStorage.removeItem('univa_alert_classes');
                    localStorage.removeItem('univa_alert_messages');
                    loadData();
                    showToast('Configuration reset to defaults', 'success');
                }
            );
        }
        
        function saveConfiguration() {
            saveData();
            showToast('Configuration saved successfully', 'success');
        }
        
        function exportConfiguration() {
            const config = {
                alertClasses,
                alertMessages,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(config, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = `univa-alert-config-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Configuration exported successfully', 'success');
        }
        
        function showLivePreview() {
            if (alertMessages.length === 0) {
                showToast('No alert messages to preview', 'warning');
                return;
            }
            
            const firstAlert = alertMessages[0];
            const alertClass = alertClasses.find(c => c.id === firstAlert.classId);
            const sampleData = {
                device: 'Crane-01',
                value: '85.5',
                unit: '¬∞C',
                timestamp: new Date().toLocaleString(),
                location: 'Workshop A',
                tag: 'Motor_Temperature',
                threshold: '80',
                operator: '>',
                limit: '80',
                duration: '5 minutes'
            };
            
            let previewMessage = firstAlert.message;
            Object.keys(sampleData).forEach(key => {
                previewMessage = previewMessage.replace(`{${key}}`, sampleData[key]);
            });
            
            showModal(
                'Live Message Preview',
                `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-medium text-blue-800 mb-2">Message Preview</h4>
                        <p class="text-sm text-blue-700">
                            This shows how a message would look with sample data. Rules will provide actual values.
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Alert Message</label>
                        <select id="preview-select" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border">
                            ${alertMessages.map(alert => {
                                const cls = alertClasses.find(c => c.id === alert.classId);
                                return `
                                    <option value="${alert.id}">
                                        ${alert.name}${cls ? ` (${cls.name})` : ''}
                                    </option>
                                `;
                            }).join('')}
                        </select>
                    </div>
                    
                    <div id="preview-content">
                        <div class="border border-border rounded-lg p-4 bg-slate-50">
                            <div class="text-sm font-mono whitespace-pre-wrap" id="preview-message">${previewMessage}</div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-2 gap-4">
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">Class:</h5>
                                ${alertClass ? `
                                    <div class="flex items-center gap-2">
                                        <i class="fa-solid ${alertClass.icon}" style="color: ${alertClass.color}"></i>
                                        <span class="text-sm">${alertClass.name}</span>
                                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full severity-${alertClass.severity} font-bold text-xs">
                                            ${alertClass.severity}
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div>
                                <h5 class="text-sm font-medium text-slate-700 mb-2">Channels:</h5>
                                <div class="flex flex-wrap gap-1">
                                    ${firstAlert.channels.map(channel => `
                                        <span class="text-xs px-2 py-0.5 rounded ${getChannelColor(channel)}">
                                            ${channel}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `,
                [
                    { text: 'Close', onclick: 'closeModal()', className: 'px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors' }
                ]
            );
            
            // Add event listener for alert selection
            setTimeout(() => {
                const select = document.getElementById('preview-select');
                if (select) {
                    select.addEventListener('change', function() {
                        const alertId = parseInt(this.value);
                        const alert = alertMessages.find(a => a.id === alertId);
                        const alertClass = alert ? alertClasses.find(c => c.id === alert.classId) : null;
                        
                        if (alert) {
                            let previewMessage = alert.message;
                            Object.keys(sampleData).forEach(key => {
                                previewMessage = previewMessage.replace(`{${key}}`, sampleData[key]);
                            });
                            
                            document.getElementById('preview-message').textContent = previewMessage;
                            
                            // Update class and channels display
                            const previewContent = document.getElementById('preview-content');
                            if (alertClass) {
                                previewContent.innerHTML = `
                                    <div class="border border-border rounded-lg p-4 bg-slate-50">
                                        <div class="text-sm font-mono whitespace-pre-wrap">${previewMessage}</div>
                                    </div>
                                    
                                    <div class="mt-4 grid grid-cols-2 gap-4">
                                        <div>
                                            <h5 class="text-sm font-medium text-slate-700 mb-2">Class:</h5>
                                            <div class="flex items-center gap-2">
                                                <i class="fa-solid ${alertClass.icon}" style="color: ${alertClass.color}"></i>
                                                <span class="text-sm">${alertClass.name}</span>
                                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full severity-${alertClass.severity} font-bold text-xs">
                                                    ${alertClass.severity}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h5 class="text-sm font-medium text-slate-700 mb-2">Channels:</h5>
                                            <div class="flex flex-wrap gap-1">
                                                ${alert.channels.map(channel => `
                                                    <span class="text-xs px-2 py-0.5 rounded ${getChannelColor(channel)}">
                                                        ${channel}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    });
                }
            }, 100);
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveConfiguration();
            }
            
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>