<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Engine & Alerts - Univa Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        secondary: '#475569',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        surface: '#F8FAFC',
                        card: '#FFFFFF',
                        border: '#E2E8F0',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.plot.ly/plotly-3.1.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #1E293B; }
        .step-active { @apply border-primary text-primary font-semibold; }
        .step-completed { @apply border-success text-success; }
        .step-inactive { @apply border-slate-200 text-slate-400; }
        .tab-active { @apply border-b-2 border-primary text-primary font-medium; }
        .tab-inactive { @apply text-slate-500 hover:text-slate-700; }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #E2E8F0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            color: #2563EB;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748B;
            padding: 0 20px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #F8FAFC;
            color: #2563EB;
        }
        
        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            border-left-color: #2563EB;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .nav-item-count {
            margin-left: auto;
            background: #E2E8F0;
            color: #475569;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #E2E8F0;
            background: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #2563EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 260px;
            top: 20px;
            z-index: 100;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 8px;
            cursor: pointer;
            color: #64748B;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed {
            transform: translateX(-260px);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 260px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-260px);
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 260px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #CBD5E1;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2563EB;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Card styles */
        .card {
            @apply bg-white rounded-xl border border-border shadow-sm;
        }
        
        .card-header {
            @apply px-6 py-4 border-b border-border bg-slate-50;
        }
        
        /* Badge styles */
        .badge-success {
            @apply px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-bold uppercase tracking-wider;
        }
        
        .badge-warning {
            @apply px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold uppercase tracking-wider;
        }
        
        .badge-disabled {
            @apply px-2 py-0.5 rounded-full bg-slate-200 text-slate-500 text-xs font-bold uppercase tracking-wider;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            min-width: 300px;
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-success {
            border-left: 4px solid #10B981;
        }
        
        .toast-error {
            border-left: 4px solid #EF4444;
        }
        
        .toast-warning {
            border-left: 4px solid #F59E0B;
        }
        
        .toast-info {
            border-left: 4px solid #2563EB;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            background: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Rule Card Animation */
        .rule-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .rule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .rule-card.selected {
            border-color: #2563EB;
            background-color: #EFF6FF;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #E2E8F0;
            border-top-color: #2563EB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Wizard Step Animation */
        .wizard-step {
            transition: all 0.3s ease;
        }
        
        .wizard-step.active {
            opacity: 1;
        }
        
        .wizard-step:not(.active) {
            opacity: 0.5;
            pointer-events: none;
        }
        
        /* Create Rule Mode */
        .create-mode .rule-editor-header {
            background: linear-gradient(to right, #EFF6FF, #DBEAFE);
        }
        
        .create-mode #rule-editor-title {
            color: #1D4ED8;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 3rem;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            color: #CBD5E1;
            margin-bottom: 1.5rem;
        }
        
        .quick-template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .quick-template {
            border: 2px dashed #CBD5E1;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-template:hover {
            border-color: #2563EB;
            background: #EFF6FF;
            transform: translateY(-2px);
        }
        
        .quick-template i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: #64748B;
        }
        
        .quick-template:hover i {
            color: #2563EB;
        }
        
        /* Notification Type Selector */
        .notification-type {
            border: 2px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        
        .notification-type:hover {
            border-color: #2563EB;
            background: #EFF6FF;
            transform: translateY(-2px);
        }
        
        .notification-type.selected {
            border-color: #2563EB;
            background: #EFF6FF;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }
        
        .notification-type.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .notification-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #64748B;
        }
        
        .notification-type.selected .notification-icon,
        .notification-type:hover .notification-icon {
            color: #2563EB;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10B981;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    
    <!-- Sidebar will be inserted here by JavaScript -->
    <div id="sidebar-container"></div>

    <!-- Modal Overlay (hidden by default) -->
    <div id="modal-overlay" class="modal-overlay">
        <div id="modal-content" class="modal-content">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Confirmation Dialog Overlay -->
    <div id="confirmation-overlay" class="modal-overlay">
        <div id="confirmation-dialog" class="confirmation-dialog">
            <!-- Confirmation content will be inserted here -->
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <!-- Header -->
        <header id="header" class="bg-white border-b border-border sticky top-0 z-30 shadow-sm">
            <div class="max-w-[1600px] mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-slate-900 font-bold text-xl tracking-tight">
                        <i class="fa-solid fa-network-wired text-primary"></i>
                        <span>Univa Gateway</span>
                    </div>
                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    <nav class="flex items-center gap-2 text-sm text-slate-500">
                        <span class="hover:text-slate-900 cursor-pointer">Configuration</span>
                        <i class="fa-solid fa-chevron-right text-xs"></i>
                        <span class="text-slate-900 font-medium">Rules Engine & Alerts</span>
                    </nav>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- Gateway Select -->
                    <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-md border border-slate-200">
                        <span class="text-xs font-semibold text-slate-500 uppercase">Gateway</span>
                        <select class="bg-transparent text-sm font-medium text-slate-700 outline-none cursor-pointer" id="gateway-select">
                            <option>Univa-GW-01</option>
                            <option>Univa-GW-02</option>
                            <option>Univa-GW-03</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="px-4 py-1.5 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-md transition-colors" onclick="resetForm()">
                            <i class="fa-solid fa-rotate-left mr-1"></i> Reset
                        </button>
                        <button class="px-4 py-1.5 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-md shadow-sm transition-colors" onclick="saveChanges()">
                            <i class="fa-solid fa-floppy-disk mr-1"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto p-6 space-y-6">
            
            <!-- Page Title & Actions -->
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Rules Engine & Alerts</h1>
                    <p class="text-slate-500 text-sm mt-1">Configure automated logic and select notification templates for alerts.</p>
                </div>
                <div class="flex gap-2">
                    <button class="inline-flex items-center px-4 py-2 text-primary border border-primary text-sm font-medium rounded-lg hover:bg-blue-50 transition" onclick="redirectToNotifications()">
                        <i class="fa-solid fa-bell mr-2"></i> Manage Notifications
                    </button>
                    <button class="inline-flex items-center px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primaryHover transition shadow-sm" onclick="startCreatingNewRule()">
                        <i class="fa-solid fa-plus mr-2"></i> Create New Rule
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- Left Column: Rules List -->
                <div id="rules-list-section" class="lg:col-span-4 space-y-4">
                    <div class="card h-[800px] flex flex-col">
                        <div class="card-header flex justify-between items-center">
                            <h3 class="font-semibold text-slate-800">Active Rules</h3>
                            <div class="flex space-x-2">
                                <button class="text-slate-400 hover:text-primary transition p-1.5 rounded hover:bg-slate-100" onclick="showFilterModal()">
                                    <i class="fa-solid fa-filter"></i>
                                </button>
                                <button class="text-slate-400 hover:text-primary transition p-1.5 rounded hover:bg-slate-100" onclick="toggleSortOrder()">
                                    <i class="fa-solid fa-sort" id="sort-icon"></i>
                                </button>
                                <button class="text-slate-400 hover:text-primary transition p-1.5 rounded hover:bg-slate-100" onclick="refreshRules()">
                                    <i class="fa-solid fa-sync-alt" id="refresh-icon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto flex-1 p-2 space-y-2" id="rules-list">
                            <!-- Rule cards will be dynamically loaded -->
                        </div>
                        
                        <div class="p-4 border-t border-border bg-white">
                            <button class="w-full py-2 border border-dashed border-slate-300 rounded-lg text-slate-500 text-sm hover:border-primary hover:text-primary hover:bg-blue-50 transition flex items-center justify-center gap-2" onclick="showImportModal()">
                                <i class="fa-solid fa-download"></i> Import Rules
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Rule Editor Wizard -->
                <div id="rule-editor-section" class="lg:col-span-8">
                    <div class="card h-full flex flex-col" id="rule-editor-card">
                        
                        <!-- Wizard Header -->
                        <div class="p-6 border-b border-border rule-editor-header" id="rule-editor-header">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-slate-900" id="rule-editor-title">Create New Rule</h2>
                                <div class="flex items-center gap-3">
                                    <span class="text-xs font-semibold uppercase text-slate-400 tracking-wider">Rule Status</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="rule-status-toggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Progress Steps -->
                            <div class="flex items-center justify-between relative">
                                <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-slate-100 -z-10"></div>
                                
                                <button class="flex items-center gap-2 bg-white pr-4 z-10" onclick="goToStep(1)">
                                    <div id="step-1-indicator" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-bold shadow-sm ring-4 ring-white">1</div>
                                    <span class="text-sm font-semibold text-slate-900">Trigger</span>
                                </button>
                                
                                <button class="flex items-center gap-2 bg-white px-4 z-10" onclick="goToStep(2)">
                                    <div id="step-2-indicator" class="w-8 h-8 rounded-full bg-white border-2 border-border text-slate-500 flex items-center justify-center text-sm font-semibold shadow-sm ring-4 ring-white">2</div>
                                    <span class="text-sm font-medium text-slate-500">Conditions</span>
                                </button>
                                
                                <button class="flex items-center gap-2 bg-white pl-4 z-10" onclick="goToStep(3)">
                                    <div id="step-3-indicator" class="w-8 h-8 rounded-full bg-white border-2 border-border text-slate-500 flex items-center justify-center text-sm font-semibold shadow-sm ring-4 ring-white">3</div>
                                    <span class="text-sm font-medium text-slate-500">Actions</span>
                                </button>
                            </div>
                        </div>

                        <!-- Wizard Content -->
                        <div class="flex-1 overflow-y-auto" id="wizard-content-container">
                            <!-- Content will be loaded dynamically -->
                            <div id="wizard-content" class="p-6 space-y-8">
                                <!-- Default content for create mode -->
                            </div>
                        </div>

                        <!-- Wizard Footer -->
                        <div class="p-6 border-t border-border bg-slate-50" id="wizard-footer">
                            <div class="flex justify-between items-center">
                                <div class="text-sm text-slate-500">
                                    <span class="font-medium text-slate-700">Rule ID:</span> <span id="rule-id-display">RULE-NEW</span>
                                </div>
                                <div class="flex gap-3">
                                    <button class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors" onclick="testRule()">
                                        Test Rule
                                    </button>
                                    <button class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors" onclick="saveRule()">
                                        Save Rule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ========== GLOBAL STATE ==========
        let currentStep = 1;
        let selectedRule = null;
        let rules = [];
        let sortOrder = 'asc';
        let isCreatingNewRule = false;
        
        // Available notification TYPES (not individual notifications)
        const availableNotificationTypes = [
            { 
                id: 'type-alert', 
                name: 'Alert Notification', 
                icon: 'fa-triangle-exclamation',
                description: 'Standard alert notifications for threshold breaches',
                channels: ['dashboard', 'email', 'sms'],
                severity: 'alert',
                defaultTemplate: '[ALERT] {device}: {tag} is {value}{unit} at {timestamp}'
            },
            { 
                id: 'type-warning', 
                name: 'Warning Notification', 
                icon: 'fa-exclamation-circle',
                description: 'Warning notifications for approaching limits',
                channels: ['dashboard', 'email'],
                severity: 'warning',
                defaultTemplate: '[WARNING] {device}: {tag} is approaching limit ({value}{unit}) at {timestamp}'
            },
            { 
                id: 'type-critical', 
                name: 'Critical Alert', 
                icon: 'fa-skull-crossbones',
                description: 'Critical alerts for emergency situations',
                channels: ['dashboard', 'email', 'sms', 'phone'],
                severity: 'critical',
                defaultTemplate: '[CRITICAL] {device}: {tag} CRITICAL level reached ({value}{unit}) at {timestamp}'
            },
            { 
                id: 'type-info', 
                name: 'Info Notification', 
                icon: 'fa-circle-info',
                description: 'Informational notifications and status updates',
                channels: ['dashboard', 'email'],
                severity: 'info',
                defaultTemplate: '[INFO] {device}: {tag} is {value}{unit} at {timestamp}'
            },
            { 
                id: 'type-device-status', 
                name: 'Device Status', 
                icon: 'fa-plug-circle-exclamation',
                description: 'Notifications for device connectivity changes',
                channels: ['dashboard', 'email'],
                severity: 'alert',
                defaultTemplate: '[DEVICE] {device} is {value} at {timestamp}'
            },
            { 
                id: 'type-maintenance', 
                name: 'Maintenance Alert', 
                icon: 'fa-screwdriver-wrench',
                description: 'Maintenance schedule and reminders',
                channels: ['dashboard', 'email'],
                severity: 'info',
                defaultTemplate: '[MAINTENANCE] {device} requires attention at {timestamp}'
            }
        ];
        
        // Quick start templates
        const quickTemplates = [
            { id: 'temp-template', name: 'Temperature Monitor', icon: 'fa-thermometer-half', description: 'Monitor temperature thresholds', device: 'Motor_Drive_01', tag: 'temperature_celsius', condition: '>', value: 80, duration: 30 },
            { id: 'device-template', name: 'Device Status', icon: 'fa-plug', description: 'Monitor device online/offline', device: 'All Devices', tag: 'status', condition: '==', value: 'offline', duration: 60 },
            { id: 'vibration-template', name: 'Vibration Alert', icon: 'fa-wave-square', description: 'Monitor vibration levels', device: 'Pump_Station_A', tag: 'vibration_level', condition: '>', value: 5.0, duration: 10 },
            { id: 'pressure-template', name: 'Pressure Monitor', icon: 'fa-gauge-high', description: 'Monitor pressure values', device: 'Compressor_Unit_03', tag: 'pressure_bar', condition: '>', value: 10.0, duration: 20 },
            { id: 'current-template', name: 'Current Monitor', icon: 'fa-bolt', description: 'Monitor electrical current', device: 'Generator_Set_02', tag: 'current_amperes', condition: '>', value: 100, duration: 15 },
            { id: 'schedule-template', name: 'Scheduled Alert', icon: 'fa-calendar-days', description: 'Time-based alerts', device: 'System', tag: 'time', condition: 'schedule', value: 'daily', duration: 0 }
        ];

        let currentRuleData = {
            id: 'RULE-NEW',
            name: '',
            enabled: true,
            triggerType: 'tag',
            device: 'Motor_Drive_01',
            tag: 'temperature_celsius',
            condition: '>',
            value: 80,
            unit: '°C',
            duration: 30,
            selectedNotificationTypes: ['type-alert'], // SELECT notification types, not create them
            messageTemplate: '{device} {tag} is {value}{unit} at {timestamp}',
            createdDate: new Date().toISOString().split('T')[0],
            lastModified: new Date().toISOString().split('T')[0],
            triggerCount: 0
        };

        // ========== SIDEBAR FUNCTIONS ==========
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) throw new Error(`Failed to load sidebar: ${response.status}`);
                document.getElementById('sidebar-container').innerHTML = await response.text();
                updateActivePage();
                initializeSidebar();
            } catch (error) {
                console.error('Error loading sidebar:', error);
                createFallbackSidebar();
            }
        }

        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-satellite-dish mr-2"></i> Innospace
                        </div>
                    </div>
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i> General Configuration
                            </a>
                            <a href="device-management.html" class="nav-item">
                                <i class="fa-solid fa-microchip"></i> Device management
                            </a>
                            <a href="rules-engine.html" class="nav-item active">
                                <i class="fa-solid fa-robot"></i> Rules Engine & Alerts
                                <span class="nav-item-count" id="rules-count">4</span>
                            </a>
                            <a href="protocol-mapping.html" class="nav-item">
                                <i class="fa-solid fa-exchange-alt"></i> Protocol Mapping
                            </a>
                            <a href="notifications.html" class="nav-item">
                                <i class="fa-solid fa-bell"></i> Notifications
                                <span class="nav-item-count">${availableNotificationTypes.length}</span>
                            </a>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4>Admin User</h4>
                                <p>System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }

        function updateActivePage() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            const rulesLink = Array.from(navItems).find(item => 
                item.textContent.includes('Rules Engine') || 
                item.textContent.includes('Automation Rules')
            );
            if (rulesLink) rulesLink.classList.add('active');
        }

        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (!sidebar || !sidebarToggle) return;
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                const icon = this.querySelector('i');
                icon.className = sidebar.classList.contains('active') ? 'fa-solid fa-times' : 'fa-solid fa-bars';
            });
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.add('active');
                sidebarToggle.style.left = '260px';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-times';
            }
            
            window.addEventListener('resize', handleResponsive);
        }

        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '260px';
            }
        }

        function handleSidebarClickOutside(event) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const isMobile = window.innerWidth <= 1024;
            
            if (isMobile && sidebar.classList.contains('active')) {
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = sidebarToggle.contains(event.target);
                
                if (!isClickInsideSidebar && !isClickOnToggle) {
                    sidebar.classList.remove('active');
                    sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                    sidebarToggle.style.left = '0';
                }
            }
        }

        // ========== MODAL FUNCTIONS ==========
        function showModal(title, content, buttons = []) {
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <h3 class="text-lg font-semibold text-slate-800">${title}</h3>
                    <button class="text-slate-400 hover:text-slate-600" onclick="closeModal()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    ${content}
                </div>
                ${buttons.length > 0 ? `
                <div class="modal-footer">
                    ${buttons.map(btn => `
                        <button 
                            onclick="${btn.onclick}"
                            class="${btn.className}"
                            ${btn.disabled ? 'disabled' : ''}
                        >
                            ${btn.text}
                        </button>
                    `).join('')}
                </div>` : ''}
            `;
            
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function showConfirmation(title, message, onConfirm, onCancel = null) {
            const overlay = document.getElementById('confirmation-overlay');
            const dialog = document.getElementById('confirmation-dialog');
            
            dialog.innerHTML = `
                <div class="mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-3xl text-yellow-500 mb-3"></i>
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">${title}</h3>
                    <p class="text-slate-600">${message}</p>
                </div>
                <div class="flex justify-center gap-3">
                    <button onclick="closeConfirmation()" class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="confirmAction()" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors">
                        Confirm
                    </button>
                </div>
            `;
            
            window.confirmAction = function() {
                if (onConfirm) onConfirm();
                closeConfirmation();
            };
            
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeConfirmation() {
            document.getElementById('confirmation-overlay').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ========== TOAST FUNCTIONS ==========
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            const icon = {
                success: 'fa-circle-check',
                error: 'fa-circle-exclamation',
                warning: 'fa-triangle-exclamation',
                info: 'fa-circle-info'
            }[type];
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="fa-solid ${icon} text-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-500 text-lg"></i>
                <div class="flex-1">
                    <p class="text-sm font-medium text-slate-800">${message}</p>
                </div>
                <button onclick="closeToast('${toastId}')" class="text-slate-400 hover:text-slate-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            if (duration > 0) {
                setTimeout(() => {
                    closeToast(toastId);
                }, duration);
            }
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // ========== RULES FUNCTIONS ==========
        function loadRules() {
            // Simulate loading rules from API
            rules = [
                {
                    id: 'RULE-2025-001',
                    name: 'Overtemp-Motor',
                    enabled: true,
                    type: 'tag',
                    lastTriggered: '12m ago',
                    description: 'Temperature > 80°C for 30s',
                    triggerCount: 12,
                    device: 'Motor_Drive_01',
                    tag: 'temperature_celsius',
                    notificationTypes: ['type-alert', 'type-critical']
                },
                {
                    id: 'RULE-2025-002',
                    name: 'Device Offline',
                    enabled: true,
                    type: 'device',
                    lastTriggered: '1h ago',
                    description: 'Device status == offline for 60s',
                    triggerCount: 3,
                    device: 'All Devices',
                    tag: 'status',
                    notificationTypes: ['type-device-status']
                },
                {
                    id: 'RULE-2025-003',
                    name: 'Shift-Start Alert',
                    enabled: false,
                    type: 'schedule',
                    lastTriggered: 'Never',
                    description: 'Daily at 8:00 AM',
                    triggerCount: 0,
                    device: 'System',
                    tag: 'time',
                    notificationTypes: ['type-info']
                },
                {
                    id: 'RULE-2025-004',
                    name: 'Pump Vibration High',
                    enabled: true,
                    type: 'tag',
                    lastTriggered: '2d ago',
                    description: 'Vibration > 5.0 mm/s for 10s',
                    triggerCount: 5,
                    device: 'Pump_Station_A',
                    tag: 'vibration_level',
                    notificationTypes: ['type-warning']
                }
            ];
            
            renderRulesList();
        }

        function renderRulesList() {
            const container = document.getElementById('rules-list');
            if (!container) return;
            
            const sortedRules = [...rules].sort((a, b) => {
                if (sortOrder === 'asc') {
                    return a.name.localeCompare(b.name);
                } else {
                    return b.name.localeCompare(a.name);
                }
            });
            
            container.innerHTML = sortedRules.map(rule => `
                <div class="rule-card p-3 rounded-lg border ${rule.id === selectedRule?.id ? 'border-primary bg-blue-50' : 'border-border bg-white'} cursor-pointer transition-all hover:shadow-md group" onclick="selectRule('${rule.id}')">
                    <div class="flex justify-between items-start mb-1">
                        <div>
                            <span class="font-semibold text-slate-800 text-sm">${rule.name}</span>
                            <span class="text-xs text-slate-400 ml-2">${rule.id}</span>
                        </div>
                        <span class="${rule.enabled ? 'badge-success' : 'badge-disabled'}">
                            ${rule.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </div>
                    <div class="text-xs text-slate-500 mb-2">
                        <i class="fa-solid ${rule.type === 'tag' ? 'fa-tag text-primary' : rule.type === 'device' ? 'fa-plug text-warning' : 'fa-calendar text-secondary'} mr-1"></i> 
                        ${rule.description}
                    </div>
                    <div class="text-xs text-slate-500 mb-2">
                        <i class="fa-solid fa-microchip mr-1"></i> ${rule.device} • ${rule.tag}
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="text-xs text-slate-400">
                                <i class="fa-regular fa-clock mr-1"></i> ${rule.lastTriggered}
                            </span>
                            <span class="text-xs text-slate-400">
                                <i class="fa-solid fa-bell mr-1"></i> ${rule.notificationTypes ? rule.notificationTypes.length : 0} notification types
                            </span>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="text-slate-400 hover:text-primary" onclick="event.stopPropagation(); toggleRuleStatus('${rule.id}')">
                                <i class="fa-solid fa-power-off text-xs"></i>
                            </button>
                            <button class="text-slate-400 hover:text-danger" onclick="event.stopPropagation(); deleteRule('${rule.id}')">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update rules count in sidebar
            const rulesCount = document.getElementById('rules-count');
            if (rulesCount) {
                rulesCount.textContent = rules.filter(r => r.enabled).length;
            }
        }

        function selectRule(ruleId) {
            isCreatingNewRule = false;
            selectedRule = rules.find(r => r.id === ruleId);
            if (selectedRule) {
                loadRuleData(selectedRule.id);
                highlightSelectedRule(ruleId);
                updateCreateModeUI(false);
            }
        }

        function highlightSelectedRule(ruleId) {
            document.querySelectorAll('.rule-card').forEach(card => {
                card.classList.remove('border-primary', 'bg-blue-50');
                card.classList.add('border-border', 'bg-white');
            });
            
            const selectedCard = document.querySelector(`[onclick*="${ruleId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('border-primary', 'bg-blue-50');
                selectedCard.classList.remove('border-border', 'bg-white');
            }
        }

        function loadRuleData(ruleId) {
            // Simulate loading rule data from API
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;
            
            // Build currentRuleData from rule object
            currentRuleData = {
                id: rule.id,
                name: rule.name,
                enabled: rule.enabled,
                triggerType: rule.type,
                device: rule.device,
                tag: rule.tag,
                condition: extractConditionFromDescription(rule.description),
                value: extractValueFromDescription(rule.description),
                unit: extractUnitFromTag(rule.tag),
                duration: extractDurationFromDescription(rule.description),
                selectedNotificationTypes: rule.notificationTypes || ['type-alert'],
                messageTemplate: getDefaultMessageTemplate(rule),
                createdDate: '2025-01-15',
                lastModified: new Date().toISOString().split('T')[0],
                triggerCount: rule.triggerCount || 0
            };
            
            updateRuleEditorUI();
        }

        function extractConditionFromDescription(desc) {
            if (desc.includes('>')) return '>';
            if (desc.includes('<')) return '<';
            if (desc.includes('==')) return '==';
            return '>';
        }

        function extractValueFromDescription(desc) {
            // Extract numeric value from description
            const match = desc.match(/(\d+(\.\d+)?)/);
            return match ? parseFloat(match[1]) : 80;
        }

        function extractDurationFromDescription(desc) {
            // Extract duration from description
            const match = desc.match(/for (\d+)s/);
            return match ? parseInt(match[1]) : 30;
        }

        function extractUnitFromTag(tag) {
            const units = {
                'temperature_celsius': '°C',
                'rpm_speed': 'RPM',
                'vibration_level': 'mm/s',
                'current_amperes': 'A',
                'pressure_bar': 'bar',
                'status': '',
                'time': ''
            };
            return units[tag] || '';
        }

        function getDefaultMessageTemplate(rule) {
            // Get template based on notification type
            const notificationType = rule.notificationTypes && rule.notificationTypes[0];
            const type = availableNotificationTypes.find(t => t.id === notificationType);
            return type ? type.defaultTemplate : '{device} {tag} is {value}{unit} at {timestamp}';
        }

        function toggleRuleStatus(ruleId) {
            const rule = rules.find(r => r.id === ruleId);
            if (rule) {
                rule.enabled = !rule.enabled;
                renderRulesList();
                showToast(`Rule ${rule.name} ${rule.enabled ? 'enabled' : 'disabled'}`, 'success');
                
                if (selectedRule && selectedRule.id === ruleId) {
                    currentRuleData.enabled = rule.enabled;
                    document.getElementById('rule-status-toggle').checked = rule.enabled;
                }
            }
        }

        function deleteRule(ruleId) {
            showConfirmation(
                'Delete Rule',
                'Are you sure you want to delete this rule? This action cannot be undone.',
                () => {
                    const ruleIndex = rules.findIndex(r => r.id === ruleId);
                    if (ruleIndex > -1) {
                        const ruleName = rules[ruleIndex].name;
                        rules.splice(ruleIndex, 1);
                        renderRulesList();
                        showToast(`Rule "${ruleName}" deleted successfully`, 'success');
                        
                        if (selectedRule && selectedRule.id === ruleId) {
                            selectedRule = null;
                            startCreatingNewRule(); // Switch to create mode after deletion
                        }
                    }
                }
            );
        }

        function refreshRules() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('fa-spin');
            
            setTimeout(() => {
                loadRules();
                icon.classList.remove('fa-spin');
                showToast('Rules list refreshed', 'success');
            }, 1000);
        }

        function toggleSortOrder() {
            const icon = document.getElementById('sort-icon');
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            icon.className = sortOrder === 'asc' ? 'fa-solid fa-sort-alpha-down' : 'fa-solid fa-sort-alpha-up';
            renderRulesList();
            showToast(`Sorted ${sortOrder === 'asc' ? 'ascending' : 'descending'}`, 'info');
        }

        // ========== CREATE RULE FUNCTIONS ==========
        function startCreatingNewRule() {
            isCreatingNewRule = true;
            selectedRule = null;
            
            // Reset current rule data
            currentRuleData = {
                id: 'RULE-NEW',
                name: '',
                enabled: true,
                triggerType: 'tag',
                device: 'Motor_Drive_01',
                tag: 'temperature_celsius',
                condition: '>',
                value: 80,
                unit: '°C',
                duration: 30,
                selectedNotificationTypes: ['type-alert'],
                messageTemplate: '{device} {tag} is {value}{unit} at {timestamp}',
                createdDate: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0],
                triggerCount: 0
            };
            
            // Clear any selected rule highlights
            document.querySelectorAll('.rule-card').forEach(card => {
                card.classList.remove('border-primary', 'bg-blue-50');
                card.classList.add('border-border', 'bg-white');
            });
            
            // Update UI for create mode
            updateCreateModeUI(true);
            
            // Show create mode wizard
            showCreateModeStep1();
        }

        function updateCreateModeUI(isCreateMode) {
            const editorCard = document.getElementById('rule-editor-card');
            const editorHeader = document.getElementById('rule-editor-header');
            const editorTitle = document.getElementById('rule-editor-title');
            const wizardFooter = document.getElementById('wizard-footer');
            
            if (isCreateMode) {
                editorCard.classList.add('create-mode');
                editorTitle.textContent = 'Create New Rule';
                document.getElementById('rule-id-display').textContent = 'RULE-NEW';
                document.getElementById('rule-status-toggle').checked = true;
                wizardFooter.classList.remove('hidden');
            } else {
                editorCard.classList.remove('create-mode');
                editorTitle.textContent = selectedRule ? `Edit Rule: ${selectedRule.name}` : 'Create New Rule';
                wizardFooter.classList.remove('hidden');
            }
        }

        function showCreateModeStep1() {
            currentStep = 1;
            updateStepIndicators();
            
            const content = document.getElementById('wizard-content');
            content.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-800 mb-2">Create New Rule</h3>
                    <p class="text-slate-500 mb-6 max-w-md">Start with a quick template or build from scratch. Rules monitor conditions and trigger notifications.</p>
                    
                    <div class="w-full max-w-2xl">
                        <!-- Quick Start Section -->
                        <div class="mb-8">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wide">Quick Start Templates</h4>
                            <div class="quick-template-grid">
                                ${quickTemplates.map(template => `
                                    <div class="quick-template" onclick="startFromTemplate('${template.id}')">
                                        <i class="fa-solid ${template.icon}"></i>
                                        <h5 class="font-medium text-slate-800 mb-1">${template.name}</h5>
                                        <p class="text-xs text-slate-500">${template.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- From Scratch Section -->
                        <div class="mb-8">
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wide">Start from Scratch</h4>
                            <div class="bg-slate-50 rounded-lg border border-border p-4">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-slate-700 mb-2">Rule Name</label>
                                    <input type="text" id="new-rule-name-input" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border" placeholder="Enter a descriptive rule name">
                                    <p class="text-xs text-slate-500 mt-1">E.g., "High-Temperature-Alert-Motor-01"</p>
                                </div>
                                <button class="w-full py-2.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primaryHover transition shadow-sm" onclick="startFromScratch()">
                                    Start Building Rule
                                </button>
                            </div>
                        </div>
                        
                        <!-- Copy Existing Section -->
                        <div>
                            <h4 class="text-sm font-semibold text-slate-700 mb-3 uppercase tracking-wide">Copy Existing Rule</h4>
                            <div class="bg-slate-50 rounded-lg border border-border p-4">
                                <label class="block text-sm font-medium text-slate-700 mb-2">Select Rule to Copy</label>
                                <select id="copy-rule-select" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border mb-3">
                                    <option value="">-- Select a rule --</option>
                                    ${rules.map(rule => `
                                        <option value="${rule.id}">${rule.name} (${rule.description})</option>
                                    `).join('')}
                                </select>
                                <button class="w-full py-2.5 border border-primary text-primary text-sm font-medium rounded-lg hover:bg-blue-50 transition" onclick="startFromExisting()">
                                    Copy and Customize
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function startFromTemplate(templateId) {
            const template = quickTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            // Generate rule name based on template
            const ruleName = `${template.name} - ${new Date().getFullYear()}`;
            
            // Set up current rule data from template
            currentRuleData = {
                id: 'RULE-NEW',
                name: ruleName,
                enabled: true,
                triggerType: template.condition === 'schedule' ? 'schedule' : 'tag',
                device: template.device,
                tag: template.tag,
                condition: template.condition,
                value: template.value,
                unit: extractUnitFromTag(template.tag),
                duration: template.duration,
                selectedNotificationTypes: getDefaultNotificationTypesForTemplate(templateId),
                messageTemplate: getMessageTemplateForTemplate(templateId),
                createdDate: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0],
                triggerCount: 0
            };
            
            // Update UI
            document.getElementById('new-rule-name-input').value = ruleName;
            
            // Move to step 2 (trigger configuration)
            goToStep(2);
        }

        function getDefaultNotificationTypesForTemplate(templateId) {
            const mapping = {
                'temp-template': ['type-alert'],
                'device-template': ['type-device-status'],
                'vibration-template': ['type-warning'],
                'pressure-template': ['type-alert'],
                'current-template': ['type-alert'],
                'schedule-template': ['type-info']
            };
            return mapping[templateId] || ['type-alert'];
        }

        function getMessageTemplateForTemplate(templateId) {
            const templates = {
                'temp-template': '[ALERT] {device} temperature is {value}°C at {timestamp}. Threshold exceeded.',
                'device-template': '[DEVICE] {device} is {value} since {timestamp}.',
                'vibration-template': '[WARNING] {device} vibration level is {value} mm/s at {timestamp}.',
                'pressure-template': '[ALERT] {device} pressure is {value} bar at {timestamp}.',
                'current-template': '[ALERT] {device} current is {value} A at {timestamp}.',
                'schedule-template': '[INFO] Scheduled alert for {device} at {timestamp}.'
            };
            return templates[templateId] || '{device} {tag} is {value}{unit} at {timestamp}';
        }

        function startFromScratch() {
            const ruleName = document.getElementById('new-rule-name-input').value.trim();
            if (!ruleName) {
                showToast('Please enter a rule name', 'error');
                return;
            }
            
            currentRuleData.name = ruleName;
            goToStep(2);
        }

        function startFromExisting() {
            const ruleId = document.getElementById('copy-rule-select').value;
            if (!ruleId) {
                showToast('Please select a rule to copy', 'error');
                return;
            }
            
            const rule = rules.find(r => r.id === ruleId);
            if (!rule) return;
            
            // Copy the rule data
            currentRuleData = {
                id: 'RULE-NEW',
                name: `${rule.name} (Copy)`,
                enabled: true,
                triggerType: rule.type,
                device: rule.device,
                tag: rule.tag,
                condition: extractConditionFromDescription(rule.description),
                value: extractValueFromDescription(rule.description),
                unit: extractUnitFromTag(rule.tag),
                duration: extractDurationFromDescription(rule.description),
                selectedNotificationTypes: [...(rule.notificationTypes || ['type-alert'])],
                messageTemplate: getDefaultMessageTemplate(rule),
                createdDate: new Date().toISOString().split('T')[0],
                lastModified: new Date().toISOString().split('T')[0],
                triggerCount: 0
            };
            
            goToStep(2);
        }

        // ========== WIZARD FUNCTIONS ==========
        function goToStep(step) {
            if (step < 1 || step > 3) return;
            
            currentStep = step;
            updateStepIndicators();
            updateWizardStep(step);
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                if (i < currentStep) {
                    indicator.className = 'w-8 h-8 rounded-full bg-success text-white flex items-center justify-center text-sm font-bold shadow-sm ring-4 ring-white';
                    indicator.innerHTML = '<i class="fa-solid fa-check text-xs"></i>';
                } else if (i === currentStep) {
                    indicator.className = 'w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center text-sm font-bold shadow-sm ring-4 ring-white';
                    indicator.textContent = i;
                } else {
                    indicator.className = 'w-8 h-8 rounded-full bg-white border-2 border-border text-slate-500 flex items-center justify-center text-sm font-semibold shadow-sm ring-4 ring-white';
                    indicator.textContent = i;
                }
            }
        }

        function updateWizardStep(step) {
            const content = document.getElementById('wizard-content');
            
            switch(step) {
                case 1:
                    if (isCreatingNewRule && !selectedRule) {
                        showCreateModeStep1();
                    } else {
                        content.innerHTML = getTriggerStepHTML();
                        setTimeout(() => updateFormValues(), 10);
                    }
                    break;
                case 2:
                    content.innerHTML = getTriggerStepHTML();
                    setTimeout(() => updateFormValues(), 10);
                    break;
                case 3:
                    content.innerHTML = getActionsStepHTML();
                    setTimeout(() => updateFormValues(), 10);
                    break;
            }
        }

        function getTriggerStepHTML() {
            return `
                <section id="trigger-config" class="wizard-step active">
                    ${isCreatingNewRule && !currentRuleData.name ? `
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Rule Name</label>
                        <input type="text" id="rule-name-input" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border" value="${currentRuleData.name}" placeholder="Enter rule name">
                    </div>
                    ` : ''}
                    
                    <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-bolt text-warning"></i> Trigger Configuration
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="triggerType" value="tag" class="peer sr-only" ${currentRuleData.triggerType === 'tag' ? 'checked' : ''}>
                            <div class="p-4 rounded-lg border-2 border-blue-100 bg-blue-50 peer-checked:border-primary peer-checked:bg-blue-50/50 hover:bg-slate-50 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                                <i class="fa-solid fa-tags text-2xl text-primary"></i>
                                <span class="font-medium text-slate-900">Tag Value</span>
                                <span class="text-xs text-slate-500">Thresholds & Limits</span>
                            </div>
                        </label>
                        
                        <label class="cursor-pointer relative">
                            <input type="radio" name="triggerType" value="device" class="peer sr-only" ${currentRuleData.triggerType === 'device' ? 'checked' : ''}>
                            <div class="p-4 rounded-lg border-2 border-border bg-white peer-checked:border-primary peer-checked:bg-blue-50 hover:bg-slate-50 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                                <i class="fa-solid fa-plug text-2xl text-slate-400 peer-checked:text-primary"></i>
                                <span class="font-medium text-slate-900">Device Event</span>
                                <span class="text-xs text-slate-500">Status Changes</span>
                            </div>
                        </label>

                        <label class="cursor-pointer relative">
                            <input type="radio" name="triggerType" value="schedule" class="peer sr-only" ${currentRuleData.triggerType === 'schedule' ? 'checked' : ''}>
                            <div class="p-4 rounded-lg border-2 border-border bg-white peer-checked:border-primary peer-checked:bg-blue-50 hover:bg-slate-50 transition-all text-center h-full flex flex-col items-center justify-center gap-2">
                                <i class="fa-regular fa-calendar-days text-2xl text-slate-400 peer-checked:text-primary"></i>
                                <span class="font-medium text-slate-900">Schedule</span>
                                <span class="text-xs text-slate-500">Time Based</span>
                            </div>
                        </label>
                    </div>

                    <div class="bg-slate-50 rounded-lg border border-border p-5 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Device</label>
                                <select id="device-select" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 bg-white border">
                                    <option value="Motor_Drive_01">Motor_Drive_01</option>
                                    <option value="Pump_Station_A">Pump_Station_A</option>
                                    <option value="Compressor_Unit_03">Compressor_Unit_03</option>
                                    <option value="Generator_Set_02">Generator_Set_02</option>
                                    <option value="All Devices">All Devices</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Tag</label>
                                <select id="tag-select" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 bg-white border" onchange="updateTagDisplay()">
                                    <option value="temperature_celsius">temperature_celsius</option>
                                    <option value="rpm_speed">rpm_speed</option>
                                    <option value="vibration_level">vibration_level</option>
                                    <option value="current_amperes">current_amperes</option>
                                    <option value="pressure_bar">pressure_bar</option>
                                    <option value="status">status</option>
                                    <option value="runtime">runtime</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-end gap-3 p-3 bg-white rounded border border-border">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Condition</label>
                                <div class="flex items-center gap-2">
                                    <div id="tag-display" class="px-3 py-2 bg-slate-100 rounded text-sm text-slate-600 font-mono">temperature_celsius</div>
                                    <select id="condition-select" class="rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-2 bg-white border">
                                        <option value=">">&gt;</option>
                                        <option value="<">&lt;</option>
                                        <option value=">=">&gt;=</option>
                                        <option value="<=">&lt;=</option>
                                        <option value="==">==</option>
                                        <option value="!=">!=</option>
                                    </select>
                                </div>
                            </div>
                            <div class="w-32">
                                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Value</label>
                                <div class="relative">
                                    <input type="text" id="value-input" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border pr-8">
                                    <span id="unit-display" class="absolute right-3 top-2 text-slate-400 text-sm">°C</span>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Duration / Hysteresis</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-slate-600">Hold for</span>
                                    <input type="number" id="duration-input" class="w-20 rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-1.5 px-2 border">
                                    <span class="text-sm text-slate-600">seconds</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 justify-center">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="scaled-value-checkbox" class="rounded border-slate-300 text-primary focus:ring-primary">
                                    <span class="ml-2 text-sm text-slate-600">Use scaled value</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" id="rising-edge-checkbox" checked class="rounded border-slate-300 text-primary focus:ring-primary">
                                    <span class="ml-2 text-sm text-slate-600">Trigger only on rising edge</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-3">
                        <i class="fa-regular fa-lightbulb text-yellow-600 mt-0.5"></i>
                        <div>
                            <p class="text-sm text-yellow-800 font-medium">Logic Preview</p>
                            <p id="logic-preview" class="text-sm text-yellow-700 mt-1">
                                Loading...
                            </p>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex ${isCreatingNewRule && currentStep === 2 ? 'justify-between' : 'justify-end'}">
                        ${isCreatingNewRule && currentStep === 2 ? `
                        <button class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors" onclick="goToStep(1)">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back to Start
                        </button>
                        ` : ''}
                        <button class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors" onclick="goToStep(3)">
                            Next: Actions <i class="fa-solid fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </section>
            `;
        }

        function getActionsStepHTML() {
            return `
                <section id="actions-config" class="wizard-step active">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-paper-plane text-success"></i> Actions & Notifications
                        </h3>
                        <button class="text-sm text-primary hover:underline" onclick="redirectToNotifications()">
                            <i class="fa-solid fa-external-link mr-1"></i> Manage Notification Types
                        </button>
                    </div>

                    <div class="bg-slate-50 rounded-lg border border-border p-5 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Select Notification Types</label>
                            <p class="text-sm text-slate-500 mb-3">Choose which types of notifications to send when this rule triggers. Manage notification types in the Notifications section.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="notification-types-container">
                                ${getNotificationTypesHTML()}
                            </div>
                            
                            <div class="mt-3 flex items-center gap-2 text-sm text-slate-500">
                                <i class="fa-solid fa-circle-info"></i>
                                <span>Selected notification types determine the format, channels, and recipients of alerts.</span>
                            </div>
                        </div>

                        <div class="border-t border-border pt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Message Customization</label>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Message Template</label>
                                    <textarea id="message-textarea" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 border h-24" placeholder="Custom message template..."></textarea>
                                    <div class="text-xs text-slate-500 mt-1 flex gap-3 flex-wrap">
                                        <span class="flex items-center gap-1"><code class="bg-slate-100 px-1 py-0.5 rounded cursor-pointer hover:bg-slate-200" onclick="insertTemplate('value')">{value}</code> Current value</span>
                                        <span class="flex items-center gap-1"><code class="bg-slate-100 px-1 py-0.5 rounded cursor-pointer hover:bg-slate-200" onclick="insertTemplate('timestamp')">{timestamp}</code> Time</span>
                                        <span class="flex items-center gap-1"><code class="bg-slate-100 px-1 py-0.5 rounded cursor-pointer hover:bg-slate-200" onclick="insertTemplate('device')">{device}</code> Device name</span>
                                        <span class="flex items-center gap-1"><code class="bg-slate-100 px-1 py-0.5 rounded cursor-pointer hover:bg-slate-200" onclick="insertTemplate('tag')">{tag}</code> Tag name</span>
                                        <span class="flex items-center gap-1"><code class="bg-slate-100 px-1 py-0.5 rounded cursor-pointer hover:bg-slate-200" onclick="insertTemplate('unit')">{unit}</code> Unit</span>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Priority</label>
                                    <select id="priority-select" class="w-full rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-2 px-3 bg-white border">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                    <p class="text-xs text-slate-500 mt-1">Priority is automatically set based on selected notification types.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Escalation Settings -->
                        <div class="border-t border-border pt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Escalation Policy</label>
                            <div class="space-y-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-slate-600">If not acknowledged within</span>
                                    <input type="number" id="escalation-input" class="w-20 rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-1.5 px-2 border" value="5" min="1" max="60">
                                    <span class="text-sm text-slate-600">minutes</span>
                                    <select id="escalation-action" class="rounded-lg border-slate-300 focus:border-primary focus:ring-1 focus:ring-primary text-sm py-1.5 px-2 border">
                                        <option value="repeat">Repeat Notification</option>
                                        <option value="escalate">Escalate to Supervisor</option>
                                        <option value="additional">Send Additional Notifications</option>
                                    </select>
                                </div>
                                <div class="text-xs text-slate-500">
                                    <i class="fa-solid fa-circle-info mr-1"></i>
                                    Escalation policies are configured per notification type.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors" onclick="goToStep(2)">
                            <i class="fa-solid fa-arrow-left mr-2"></i> Back
                        </button>
                        <div class="flex gap-3">
                            <button class="px-4 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 rounded-lg border border-slate-300 transition-colors" onclick="testRule()">
                                Test Rule
                            </button>
                            <button class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primaryHover rounded-lg shadow-sm transition-colors" onclick="saveRule()">
                                Save Rule
                            </button>
                        </div>
                    </div>
                </section>
            `;
        }

        function getNotificationTypesHTML() {
            return availableNotificationTypes.map(type => {
                const isSelected = currentRuleData.selectedNotificationTypes && 
                                   currentRuleData.selectedNotificationTypes.includes(type.id);
                
                const severityColors = {
                    alert: 'bg-red-100 text-red-800 border-red-200',
                    warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    critical: 'bg-purple-100 text-purple-800 border-purple-200',
                    info: 'bg-blue-100 text-blue-800 border-blue-200'
                };
                
                const severityText = {
                    alert: 'Alert',
                    warning: 'Warning',
                    critical: 'Critical',
                    info: 'Info'
                };
                
                return `
                    <div class="notification-type relative ${isSelected ? 'selected' : ''}" onclick="toggleNotificationType('${type.id}')">
                        <div class="text-center">
                            <div class="notification-icon">
                                <i class="fa-solid ${type.icon}"></i>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">${type.name}</h4>
                            <p class="text-xs text-slate-500 mb-3">${type.description}</p>
                            <div class="text-xs ${severityColors[type.severity]} px-2 py-1 rounded-full inline-block border">
                                ${severityText[type.severity]}
                            </div>
                        </div>
                        ${isSelected ? '<div class="notification-badge"><i class="fa-solid fa-check"></i></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleNotificationType(typeId) {
            if (!currentRuleData.selectedNotificationTypes) {
                currentRuleData.selectedNotificationTypes = [];
            }
            
            const index = currentRuleData.selectedNotificationTypes.indexOf(typeId);
            if (index > -1) {
                currentRuleData.selectedNotificationTypes.splice(index, 1);
            } else {
                currentRuleData.selectedNotificationTypes.push(typeId);
            }
            
            // Update the UI
            updateNotificationTypesSelection();
            
            // Auto-update priority based on selected types
            updatePriorityBasedOnNotificationTypes();
            
            // Auto-update message template if first type selected
            if (currentRuleData.selectedNotificationTypes.length === 1) {
                const selectedType = availableNotificationTypes.find(t => t.id === currentRuleData.selectedNotificationTypes[0]);
                if (selectedType) {
                    currentRuleData.messageTemplate = selectedType.defaultTemplate;
                    const textarea = document.getElementById('message-textarea');
                    if (textarea) {
                        textarea.value = selectedType.defaultTemplate;
                    }
                }
            }
        }

        function updateNotificationTypesSelection() {
            const container = document.getElementById('notification-types-container');
            if (!container) return;
            
            container.innerHTML = getNotificationTypesHTML();
        }

        function updatePriorityBasedOnNotificationTypes() {
            const prioritySelect = document.getElementById('priority-select');
            if (!prioritySelect) return;
            
            const selectedTypes = currentRuleData.selectedNotificationTypes || [];
            
            // Determine highest severity from selected types
            let highestSeverity = 'low';
            
            selectedTypes.forEach(typeId => {
                const type = availableNotificationTypes.find(t => t.id === typeId);
                if (type) {
                    const severityOrder = { 'critical': 4, 'alert': 3, 'warning': 2, 'info': 1 };
                    if (severityOrder[type.severity] > severityOrder[highestSeverity] || highestSeverity === 'low') {
                        highestSeverity = type.severity;
                    }
                }
            });
            
            // Map severity to priority
            const severityToPriority = {
                'critical': 'critical',
                'alert': 'high',
                'warning': 'medium',
                'info': 'low'
            };
            
            prioritySelect.value = severityToPriority[highestSeverity] || 'medium';
        }

        function updateRuleEditorUI() {
            updateRuleEditorTitle(selectedRule ? selectedRule.name : 'Create New Rule');
            document.getElementById('rule-id-display').textContent = currentRuleData.id;
            document.getElementById('rule-status-toggle').checked = currentRuleData.enabled;
            
            if (selectedRule) {
                updateWizardStep(currentStep);
                setTimeout(() => updateFormValues(), 10);
            }
        }

        function updateRuleEditorTitle(name) {
            const title = document.getElementById('rule-editor-title');
            if (title) {
                title.textContent = name ? `Edit Rule: ${name}` : 'Create New Rule';
            }
        }

        function updateFormValues() {
            // Update rule name if in create mode
            if (isCreatingNewRule && currentRuleData.name) {
                const nameInput = document.getElementById('rule-name-input');
                if (nameInput) nameInput.value = currentRuleData.name;
            }
            
            // Update form fields with current rule data
            const triggerTypeRadio = document.querySelector(`input[name="triggerType"][value="${currentRuleData.triggerType}"]`);
            if (triggerTypeRadio) triggerTypeRadio.checked = true;
            
            const deviceSelect = document.getElementById('device-select');
            if (deviceSelect) deviceSelect.value = currentRuleData.device;
            
            const tagSelect = document.getElementById('tag-select');
            if (tagSelect) {
                tagSelect.value = currentRuleData.tag;
                updateTagDisplay();
            }
            
            const conditionSelect = document.getElementById('condition-select');
            if (conditionSelect) conditionSelect.value = currentRuleData.condition;
            
            const valueInput = document.getElementById('value-input');
            if (valueInput) valueInput.value = currentRuleData.value;
            
            const durationInput = document.getElementById('duration-input');
            if (durationInput) durationInput.value = currentRuleData.duration;
            
            const prioritySelect = document.getElementById('priority-select');
            if (prioritySelect) {
                // Set priority based on selected notification types
                updatePriorityBasedOnNotificationTypes();
            }
            
            const messageTextarea = document.getElementById('message-textarea');
            if (messageTextarea) messageTextarea.value = currentRuleData.messageTemplate || '';
            
            const escalationInput = document.getElementById('escalation-input');
            if (escalationInput) escalationInput.value = currentRuleData.escalation || 5;
            
            // Update logic preview
            updateLogicPreview();
        }

        function updateTagDisplay() {
            const tagSelect = document.getElementById('tag-select');
            const tagDisplay = document.getElementById('tag-display');
            const unitDisplay = document.getElementById('unit-display');
            const valueInput = document.getElementById('value-input');
            
            if (tagSelect && tagDisplay && unitDisplay && valueInput) {
                const selectedTag = tagSelect.value;
                tagDisplay.textContent = selectedTag;
                
                // Set unit based on tag
                const units = {
                    'temperature_celsius': '°C',
                    'rpm_speed': 'RPM',
                    'vibration_level': 'mm/s',
                    'current_amperes': 'A',
                    'pressure_bar': 'bar',
                    'status': '',
                    'runtime': 'hours',
                    'time': ''
                };
                
                const unit = units[selectedTag] || '';
                unitDisplay.textContent = unit;
                currentRuleData.unit = unit;
                
                // Update value input placeholder based on tag
                if (selectedTag === 'status') {
                    valueInput.type = 'text';
                    valueInput.placeholder = 'e.g., offline, error, maintenance';
                    valueInput.value = currentRuleData.value || 'offline';
                } else {
                    valueInput.type = 'number';
                    valueInput.placeholder = 'Enter value';
                }
            }
        }

        function updateLogicPreview() {
            const preview = document.getElementById('logic-preview');
            if (preview) {
                const device = currentRuleData.device;
                const tag = currentRuleData.tag;
                const condition = currentRuleData.condition;
                const value = currentRuleData.value;
                const unit = currentRuleData.unit || '';
                const duration = currentRuleData.duration;
                const notificationCount = currentRuleData.selectedNotificationTypes ? currentRuleData.selectedNotificationTypes.length : 0;
                
                // Get notification type names
                const notificationNames = currentRuleData.selectedNotificationTypes
                    .map(id => availableNotificationTypes.find(t => t.id === id)?.name)
                    .filter(name => name)
                    .join(', ');
                
                preview.innerHTML = `
                    <strong>When:</strong> <code class="bg-slate-100 px-1">${device}.${tag}</code> ${condition} <strong>${value}${unit}</strong> for <strong>${duration} seconds</strong><br>
                    <strong>Then:</strong> Send <strong>${notificationCount} notification type${notificationCount !== 1 ? 's' : ''}</strong>
                    ${notificationNames ? `<br><span class="text-xs">(${notificationNames})</span>` : ''}
                `;
            }
        }

        function insertTemplate(template) {
            const textarea = document.getElementById('message-textarea');
            if (textarea) {
                const cursorPos = textarea.selectionStart;
                const text = textarea.value;
                const templateText = `{${template}}`;
                
                textarea.value = text.substring(0, cursorPos) + templateText + text.substring(cursorPos);
                textarea.focus();
                textarea.setSelectionRange(cursorPos + templateText.length, cursorPos + templateText.length);
            }
        }

        // ========== BUTTON ACTION FUNCTIONS ==========
        function redirectToNotifications() {
            // Redirect to notifications management page
            window.location.href = 'notifications.html';
        }

        function resetForm() {
            showConfirmation(
                'Reset Form',
                'Are you sure you want to reset all changes? Unsaved changes will be lost.',
                () => {
                    if (selectedRule) {
                        loadRuleData(selectedRule.id);
                    } else {
                        startCreatingNewRule();
                    }
                    showToast('Form reset successfully', 'success');
                }
            );
        }

        function saveChanges() {
            // If in create mode, get rule name from input
            if (isCreatingNewRule) {
                const nameInput = document.getElementById('rule-name-input');
                if (nameInput) {
                    const ruleName = nameInput.value.trim();
                    if (!ruleName) {
                        showToast('Please enter a rule name', 'error');
                        return;
                    }
                    currentRuleData.name = ruleName;
                }
            }
            
            // Collect form data
            const ruleStatus = document.getElementById('rule-status-toggle').checked;
            const triggerType = document.querySelector('input[name="triggerType"]:checked')?.value;
            const device = document.getElementById('device-select')?.value;
            const tag = document.getElementById('tag-select')?.value;
            const condition = document.getElementById('condition-select')?.value;
            const value = document.getElementById('value-input')?.value;
            const duration = document.getElementById('duration-input')?.value;
            const messageTemplate = document.getElementById('message-textarea')?.value;
            const priority = document.getElementById('priority-select')?.value;
            
            // Update current rule data
            currentRuleData.enabled = ruleStatus;
            currentRuleData.triggerType = triggerType || 'tag';
            currentRuleData.device = device || 'Motor_Drive_01';
            currentRuleData.tag = tag || 'temperature_celsius';
            currentRuleData.condition = condition || '>';
            currentRuleData.value = value || 80;
            currentRuleData.duration = parseInt(duration) || 30;
            currentRuleData.messageTemplate = messageTemplate || '';
            currentRuleData.lastModified = new Date().toISOString().split('T')[0];
            
            // Update selected rule in list or create new
            if (selectedRule) {
                const rule = rules.find(r => r.id === selectedRule.id);
                if (rule) {
                    rule.name = currentRuleData.name;
                    rule.enabled = currentRuleData.enabled;
                    rule.type = currentRuleData.triggerType;
                    rule.device = currentRuleData.device;
                    rule.tag = currentRuleData.tag;
                    rule.notificationTypes = currentRuleData.selectedNotificationTypes;
                    rule.lastModified = currentRuleData.lastModified;
                    rule.description = `${currentRuleData.device}.${currentRuleData.tag} ${currentRuleData.condition} ${currentRuleData.value}${currentRuleData.unit} for ${currentRuleData.duration}s`;
                    renderRulesList();
                }
            }
            
            showToast('Changes saved successfully', 'success');
        }

        function saveRule() {
            saveChanges();
            
            // If this is a new rule, add it to the list
            if (isCreatingNewRule) {
                const newId = 'RULE-' + Date.now().toString().slice(-6);
                const newRule = {
                    id: newId,
                    name: currentRuleData.name,
                    enabled: currentRuleData.enabled,
                    type: currentRuleData.triggerType,
                    lastTriggered: 'Never',
                    description: `${currentRuleData.device}.${currentRuleData.tag} ${currentRuleData.condition} ${currentRuleData.value}${currentRuleData.unit} for ${currentRuleData.duration}s`,
                    triggerCount: 0,
                    device: currentRuleData.device,
                    tag: currentRuleData.tag,
                    notificationTypes: currentRuleData.selectedNotificationTypes,
                    createdDate: currentRuleData.createdDate,
                    lastModified: currentRuleData.lastModified
                };
                
                rules.push(newRule);
                renderRulesList();
                
                // Switch to edit mode for the newly created rule
                isCreatingNewRule = false;
                selectedRule = newRule;
                currentRuleData.id = newId;
                selectRule(newId);
                
                showToast(`Rule "${currentRuleData.name}" created successfully`, 'success');
            } else {
                showToast('Rule saved successfully', 'success');
            }
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadSidebar();
            loadRules();
            
            // Start in create mode by default
            setTimeout(() => {
                startCreatingNewRule();
            }, 100);
            
            // Initialize gateway select
            const gatewaySelect = document.getElementById('gateway-select');
            if (gatewaySelect) {
                gatewaySelect.addEventListener('change', function() {
                    showConfirmation(
                        'Switch Gateway',
                        'Switch to another gateway? Unsaved changes will be lost.',
                        () => {
                            location.reload();
                        }
                    );
                });
            }
            
            // Initialize rule status toggle
            const ruleStatusToggle = document.getElementById('rule-status-toggle');
            if (ruleStatusToggle) {
                ruleStatusToggle.addEventListener('change', function() {
                    currentRuleData.enabled = this.checked;
                    showToast(`Rule ${this.checked ? 'enabled' : 'disabled'}`, 'info');
                });
            }
            
            // Add click outside handler for sidebar
            document.addEventListener('click', handleSidebarClickOutside);
            
            // Initial responsive setup
            setTimeout(handleResponsive, 100);
        });

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }
            
            // Ctrl+N for new rule
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                startCreatingNewRule();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                closeModal();
                closeConfirmation();
            }
            
            // Arrow keys for wizard navigation
            if (!e.ctrlKey && !e.altKey) {
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    if (currentStep < 3) goToStep(currentStep + 1);
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (currentStep > 1) goToStep(currentStep - 1);
                }
            }
        });
    </script>
</body>
</html>