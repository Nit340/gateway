<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler & Automation - Univa Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        secondary: '#475569',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        surface: '#F8FAFC',
                        card: '#FFFFFF',
                        border: '#E2E8F0',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; color: #1E293B; }
        .toggle-checkbox:checked { right: 0; border-color: #2563EB; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563EB; }
        .radio-checkbox:checked { background-color: #2563EB; border-color: #2563EB; }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #E2E8F0;
            height: 100vh;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 40;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        .sidebar-logo {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #E2E8F0;
            background: white;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
            color: #2563EB;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748B;
            padding: 0 20px 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid #F1F5F9;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 8px 20px;
            color: #475569;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: #F8FAFC;
            color: #2563EB;
        }
        
        .nav-item.active {
            background: #EFF6FF;
            color: #2563EB;
            border-left-color: #2563EB;
            font-weight: 600;
        }
        
        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 14px;
            text-align: center;
        }
        
        .nav-item-count {
            margin-left: auto;
            background: #E2E8F0;
            color: #475569;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid #E2E8F0;
            background: white;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #2563EB;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 260px;
            top: 20px;
            z-index: 100;
            background: white;
            border: 1px solid #E2E8F0;
            border-left: none;
            border-radius: 0 6px 6px 0;
            padding: 10px 8px;
            cursor: pointer;
            color: #64748B;
            transition: all 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .sidebar.collapsed {
            transform: translateX(-260px);
        }
        
        .sidebar.collapsed ~ .main-content-with-sidebar {
            margin-left: 0;
        }
        
        .sidebar.collapsed + .sidebar-toggle {
            left: 0;
        }
        
        .main-content-with-sidebar {
            margin-left: 260px;
            transition: margin-left 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-260px);
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-toggle {
                display: block;
                left: 0;
            }
            
            .sidebar.active + .sidebar-toggle {
                left: 260px;
            }
            
            .main-content-with-sidebar {
                margin-left: 0;
            }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background: #10B981; }
        .toast.error { background: #EF4444; }
        .toast.warning { background: #F59E0B; }
        .toast.info { background: #2563EB; }
        
        /* Job Type Indicators */
        .job-type-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .job-type.interval { background-color: #3B82F6; }
        .job-type.daily { background-color: #10B981; }
        .job-type.weekly { background-color: #8B5CF6; }
        .job-type.monthly { background-color: #F59E0B; }
        .job-type.cron { background-color: #EF4444; }
        .job-type.sunrise { background-color: #EC4899; }
        
        /* Cron Expression Helper */
        .cron-helper {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }
        
        /* Action Config Sections */
        .action-config-section {
            display: none;
        }
        
        .action-config-section.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-50">
    
    <!-- Sidebar will be inserted here by JavaScript -->
    <div id="sidebar-container"></div>

    <!-- Create/Edit Job Modal -->
    <div id="createJobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="font-semibold text-lg text-slate-800" id="modalTitle">Create Scheduled Job</h3>
                <button class="text-slate-400 hover:text-slate-600" onclick="closeModal('createJobModal')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-6">
                    <!-- (1) Job Details -->
                    <div>
                        <h4 class="text-sm font-semibold text-slate-900 mb-3 border-b pb-2">(1) Job Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Job Name *</label>
                                <input type="text" id="jobName" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="e.g., Modbus Poll">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                <input type="text" id="jobDescription" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="Optional description">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Job Type</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="interval" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Interval</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="daily" class="h-4 w-4 text-primary focus:ring-primary border-slate-300" checked>
                                    <span class="ml-2 text-sm text-slate-700">Daily</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="weekly" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Weekly</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="monthly" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Monthly</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="cron" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Cron</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="jobType" value="sunrise" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Sunrise/Sunset</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- (2) Trigger Configuration -->
                    <div>
                        <h4 class="text-sm font-semibold text-slate-900 mb-3 border-b pb-2">(2) Trigger Configuration</h4>
                        
                        <!-- Interval Trigger -->
                        <div id="intervalConfig" class="trigger-config hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Interval (seconds)</label>
                            <input type="number" id="intervalSeconds" value="10" min="1" max="86400" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                        </div>
                        
                        <!-- Daily Trigger -->
                        <div id="dailyConfig" class="trigger-config">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                            <input type="time" id="dailyTime" value="06:00" class="rounded-lg border-slate-300 border px-3 py-2 text-sm">
                        </div>
                        
                        <!-- Weekly Trigger -->
                        <div id="weeklyConfig" class="trigger-config hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Days</label>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="mon" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary" checked>
                                    <span class="ml-1 text-sm text-slate-700">Mon</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="tue" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary" checked>
                                    <span class="ml-1 text-sm text-slate-700">Tue</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="wed" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary">
                                    <span class="ml-1 text-sm text-slate-700">Wed</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="thu" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary" checked>
                                    <span class="ml-1 text-sm text-slate-700">Thu</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="fri" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary">
                                    <span class="ml-1 text-sm text-slate-700">Fri</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="sat" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary">
                                    <span class="ml-1 text-sm text-slate-700">Sat</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="weekDays" value="sun" class="h-4 w-4 text-primary rounded border-slate-300 focus:ring-primary">
                                    <span class="ml-1 text-sm text-slate-700">Sun</span>
                                </label>
                            </div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                            <input type="time" id="weeklyTime" value="12:30" class="rounded-lg border-slate-300 border px-3 py-2 text-sm">
                        </div>
                        
                        <!-- Monthly Trigger -->
                        <div id="monthlyConfig" class="trigger-config hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Day of Month</label>
                            <input type="number" id="monthlyDay" value="1" min="1" max="31" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                            <label class="block text-sm font-medium text-slate-700 mt-3 mb-1">Time</label>
                            <input type="time" id="monthlyTime" value="00:00" class="rounded-lg border-slate-300 border px-3 py-2 text-sm">
                        </div>
                        
                        <!-- Cron Trigger -->
                        <div id="cronConfig" class="trigger-config hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Cron Expression</label>
                            <div class="flex items-center">
                                <input type="text" id="cronExpression" value="* * * * *" class="flex-1 rounded-lg border-slate-300 border px-3 py-2 text-sm font-mono" placeholder="* * * * *">
                                <button class="ml-2 text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded transition" onclick="generateCronExpression()">
                                    Generate Cron
                                </button>
                            </div>
                            <div class="cron-helper">
                                <p class="text-xs text-slate-600 mb-2">Format: minute hour day month day-of-week</p>
                                <p class="text-xs text-slate-500">Example: 0 6 * * * = Daily at 6:00 AM</p>
                                <p class="text-xs text-slate-500">Example: */10 * * * * = Every 10 minutes</p>
                            </div>
                        </div>
                        
                        <!-- Sunrise/Sunset Trigger -->
                        <div id="sunriseConfig" class="trigger-config hidden">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Mode</label>
                            <div class="flex space-x-4 mb-3">
                                <label class="flex items-center">
                                    <input type="radio" name="sunMode" value="sunrise" class="h-4 w-4 text-primary focus:ring-primary border-slate-300" checked>
                                    <span class="ml-2 text-sm text-slate-700">Sunrise</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="sunMode" value="sunset" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                    <span class="ml-2 text-sm text-slate-700">Sunset</span>
                                </label>
                            </div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Offset (minutes)</label>
                            <input type="number" id="sunOffset" value="-30" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                            <p class="text-xs text-slate-500 mt-1">Negative values = before, positive = after</p>
                        </div>
                    </div>

                    <!-- (3) Action Configuration -->
                    <div>
                        <h4 class="text-sm font-semibold text-slate-900 mb-3 border-b pb-2">(3) Action Configuration</h4>
                        
                        <label class="block text-sm font-medium text-slate-700 mb-2">Select Action Type</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="publish" class="h-4 w-4 text-primary focus:ring-primary border-slate-300" checked>
                                <span class="ml-2 text-sm text-slate-700">Publish Data</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="log" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                <span class="ml-2 text-sm text-slate-700">Log Message</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="output" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                <span class="ml-2 text-sm text-slate-700">Set Output/Relay</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="rule" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                <span class="ml-2 text-sm text-slate-700">Run Rule Engine</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="file" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                <span class="ml-2 text-sm text-slate-700">File Operation</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="actionType" value="system" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                <span class="ml-2 text-sm text-slate-700">System Action</span>
                            </label>
                        </div>
                        
                        <!-- Publish Data Action -->
                        <div id="publishAction" class="action-config-section active">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Topic</label>
                                    <input type="text" id="publishTopic" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="device/data/publish">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Payload (JSON Template)</label>
                                    <textarea id="publishPayload" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm font-mono" rows="3" placeholder='{"timestamp": "${NOW}", "value": 123}'>
{
  "timestamp": "${NOW}",
  "device_id": "${DEVICE_ID}",
  "job_name": "${JOB_NAME}"
}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">QoS</label>
                                    <select id="publishQos" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="0">0 - At most once</option>
                                        <option value="1" selected>1 - At least once</option>
                                        <option value="2">2 - Exactly once</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Log Message Action -->
                        <div id="logAction" class="action-config-section">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Log Message</label>
                                    <input type="text" id="logMessage" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="Job executed successfully">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Log Level</label>
                                    <select id="logLevel" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="info">Info</option>
                                        <option value="warning">Warning</option>
                                        <option value="error">Error</option>
                                        <option value="debug">Debug</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Set Output Action -->
                        <div id="outputAction" class="action-config-section">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">GPIO / Relay</label>
                                    <select id="outputRelay" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="relay_1">Relay 1</option>
                                        <option value="relay_2">Relay 2</option>
                                        <option value="relay_3">Relay 3</option>
                                        <option value="relay_4">Relay 4</option>
                                        <option value="gpio_5">GPIO 5</option>
                                        <option value="gpio_6">GPIO 6</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Value</label>
                                    <div class="flex space-x-4">
                                        <label class="flex items-center">
                                            <input type="radio" name="outputValue" value="on" class="h-4 w-4 text-primary focus:ring-primary border-slate-300" checked>
                                            <span class="ml-2 text-sm text-slate-700">ON</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="outputValue" value="off" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                            <span class="ml-2 text-sm text-slate-700">OFF</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="outputValue" value="toggle" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                            <span class="ml-2 text-sm text-slate-700">Toggle</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Duration (optional)</label>
                                    <div class="flex items-center">
                                        <input type="number" id="outputDuration" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="e.g., 5000">
                                        <span class="ml-2 text-sm text-slate-700">milliseconds</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Run Rule Engine Action -->
                        <div id="ruleAction" class="action-config-section">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Rule Node</label>
                                    <select id="ruleNode" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="">Select Rule Node</option>
                                        <option value="safety_check">Safety Check</option>
                                        <option value="alert_generator">Alert Generator</option>
                                        <option value="data_processor">Data Processor</option>
                                        <option value="notification">Notification</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- File Operation Action -->
                        <div id="fileAction" class="action-config-section">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Operation</label>
                                    <select id="fileOperation" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="rotate">Rotate Logs</option>
                                        <option value="delete">Delete Old Files</option>
                                        <option value="archive">Archive Files</option>
                                        <option value="cleanup">Cleanup Temp Files</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">File Pattern</label>
                                    <input type="text" id="filePattern" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="*.log">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Retain Days</label>
                                    <input type="number" id="retainDays" value="7" min="1" max="365" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Action -->
                        <div id="systemAction" class="action-config-section">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">System Action</label>
                                    <select id="systemOperation" class="w-full rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                        <option value="reboot">Reboot System</option>
                                        <option value="restart_services">Restart Services</option>
                                        <option value="refresh_config">Refresh Configuration</option>
                                        <option value="sync_time">Sync Time</option>
                                        <option value="health_check">Health Check</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- (4) Advanced Options -->
                    <div>
                        <h4 class="text-sm font-semibold text-slate-900 mb-3 border-b pb-2">(4) Advanced Options</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Retry Count</label>
                                <input type="number" id="retryCount" value="3" min="0" max="10" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Retry Interval</label>
                                <div class="flex items-center">
                                    <input type="number" id="retryInterval" value="2" min="1" max="60" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                                    <span class="ml-2 text-sm text-slate-700">seconds</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Stop After Error</label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="stopOnError" value="yes" class="h-4 w-4 text-primary focus:ring-primary border-slate-300">
                                        <span class="ml-2 text-sm text-slate-700">Yes</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="stopOnError" value="no" class="h-4 w-4 text-primary focus:ring-primary border-slate-300" checked>
                                        <span class="ml-2 text-sm text-slate-700">No</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Job Priority (1-10)</label>
                                <input type="number" id="jobPriority" value="5" min="1" max="10" class="w-32 rounded-lg border-slate-300 border px-3 py-2 text-sm">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Tags</label>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <span id="selectedTags"></span>
                                </div>
                                <div class="flex items-center">
                                    <input type="text" id="newTag" class="flex-1 rounded-lg border-slate-300 border px-3 py-2 text-sm" placeholder="Add tag...">
                                    <button class="ml-2 text-xs text-primary hover:text-primaryHover px-3 py-2" onclick="addTag()">
                                        <i class="fa-solid fa-plus mr-1"></i> Add
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Common tags: safety, modbus, mqtt, export, cleanup</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="text-red-600 hover:text-red-700 hover:bg-red-50 font-medium text-sm px-4 py-2 rounded-lg transition-colors" onclick="deleteJob()" id="deleteJobBtn">
                    Delete Job
                </button>
                <button type="button" class="text-slate-500 hover:text-slate-700 font-medium text-sm px-4 py-2 rounded-lg hover:bg-slate-100 transition-colors" onclick="closeModal('createJobModal')">
                    Cancel
                </button>
                <button type="button" class="text-primary hover:text-primaryHover font-medium text-sm px-4 py-2 rounded-lg hover:bg-blue-50 transition-colors" onclick="runJobNow()" id="runNowBtn">
                    Run Now
                </button>
                <button type="button" class="bg-primary hover:bg-primaryHover text-white font-medium text-sm px-4 py-2 rounded-lg transition-colors" onclick="saveJob()">
                    Save Job
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Main Content Container -->
    <div class="main-content-with-sidebar">
        <!-- Header -->
        <header id="header" class="bg-white border-b border-border sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <!-- Left: Logo & Breadcrumb -->
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center text-sm text-slate-500 h-6">
                        <span><i class="fa-solid fa-sliders mr-2"></i>Settings</span>
                        <i class="fa-solid fa-chevron-right text-xs mx-2"></i>
                        <span class="text-slate-900 font-medium" id="page-title">Scheduler & Automation Jobs</span>
                    </div>
                </div>

                <!-- Right: Controls -->
                <div class="flex items-center space-x-4">
                    <div class="relative hidden sm:block">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-server text-slate-400 text-sm"></i>
                        </div>
                        <select id="gateway-select" class="pl-9 pr-8 py-1.5 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-slate-50 text-slate-700 font-medium cursor-pointer hover:bg-white transition-colors">
                            <option>Univa-GW-01</option>
                            <option>Univa-GW-02</option>
                            <option>Univa-GW-03</option>
                        </select>
                    </div>
                    <div class="h-6 w-px bg-slate-200 mx-2 hidden sm:block"></div>
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 transition-colors" onclick="exportJobs()">
                        <i class="fa-solid fa-file-export mr-2"></i> Export
                    </button>
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 transition-colors" onclick="importJobs()">
                        <i class="fa-solid fa-file-import mr-2"></i> Import
                    </button>
                    <button class="text-slate-500 hover:text-slate-700 font-medium text-sm px-3 py-1.5 rounded-lg hover:bg-slate-100 transition-colors" onclick="showHelp()">
                        <i class="fa-solid fa-circle-question mr-2"></i> Help
                    </button>
                    <button class="bg-primary hover:bg-primaryHover text-white font-medium text-sm px-4 py-1.5 rounded-lg shadow-sm transition-colors flex items-center" id="header-save-btn" onclick="saveAllSettings()">
                        <i class="fa-solid fa-floppy-disk mr-2"></i> Save
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-slate-900">Scheduler & Automation Jobs</h1>
                    <p class="text-slate-500 text-sm mt-1">Automatically trigger actions at specific times, intervals, or based on events. Essential for autonomous gateway behavior.</p>
                    <div class="mt-4 flex gap-2">
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fa-solid fa-check-circle"></i> 4 Jobs Active
                        </span>
                        <span class="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fa-solid fa-clock"></i> Next run in 50min
                        </span>
                    </div>
                </div>

                <div class="mb-6 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <button onclick="createNewJob()" class="px-4 py-2 bg-primary hover:bg-primaryHover text-white rounded-lg text-sm font-medium shadow-sm transition-colors flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> Add New Job
                        </button>
                        <button onclick="checkConflicts()" class="px-4 py-2 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-lg text-sm font-medium transition-colors flex items-center">
                            <i class="fa-solid fa-triangle-exclamation mr-2"></i> Check Conflicts
                        </button>
                    </div>
                    <div class="text-sm text-slate-600">
                        Total: <span class="font-medium">4</span> jobs • 
                        Enabled: <span class="font-medium text-green-600">3</span> • 
                        Disabled: <span class="font-medium text-slate-400">1</span>
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- SECTION A: Job List -->
                    <section id="section-jobs" class="bg-white rounded-xl shadow-sm border border-border">
                        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <h2 class="font-semibold text-slate-800">Active Automation Jobs</h2>
                            <div class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                Time-based, Interval-based, and Event-based triggers
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3">Job Name</th>
                                        <th class="px-6 py-3">Type</th>
                                        <th class="px-6 py-3">Schedule</th>
                                        <th class="px-6 py-3">Next Run</th>
                                        <th class="px-6 py-3">Action</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobTableBody" class="divide-y divide-slate-100">
                                    <!-- Jobs will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- SECTION B: Execution History -->
                    <section id="section-history" class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-slate-800 flex items-center">
                                <i class="fa-solid fa-clock-rotate-left mr-2 text-blue-500"></i> 
                                <span class="mr-2">Execution History</span>
                                <span class="text-xs font-normal text-slate-500">SECTION B</span>
                            </h2>
                            <div class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                Job performance & diagnostics
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3">Timestamp</th>
                                        <th class="px-6 py-3">Job</th>
                                        <th class="px-6 py-3">Trigger</th>
                                        <th class="px-6 py-3">Duration</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Message</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody" class="divide-y divide-slate-100">
                                    <!-- History will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- SECTION C: Conflict Detection -->
                    <section id="section-conflicts" class="bg-white rounded-xl shadow-sm border border-border p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-slate-800 flex items-center">
                                <i class="fa-solid fa-triangle-exclamation mr-2 text-amber-500"></i> 
                                <span class="mr-2">Conflict Detection</span>
                                <span class="text-xs font-normal text-slate-500">SECTION C</span>
                            </h2>
                            <div class="text-xs text-slate-500 bg-slate-100 px-3 py-1 rounded-full">
                                Overlapping job detection
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-slate-900 mb-3">Potential Conflicts</h3>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-2 bg-white border border-slate-200 rounded">
                                        <div>
                                            <p class="text-sm font-medium text-slate-900">Modbus Poll & Health Check</p>
                                            <p class="text-xs text-slate-500">Both scheduled for 01:00</p>
                                        </div>
                                        <span class="text-xs text-amber-600 font-medium">Warning</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-slate-900 mb-3">System Resources</h3>
                                <div class="space-y-3">
                                    <div>
                                        <div class="flex justify-between text-xs text-slate-600 mb-1">
                                            <span>Max Concurrent Jobs</span>
                                            <span>3 / 5</span>
                                        </div>
                                        <div class="w-full bg-slate-200 rounded-full h-2">
                                            <div class="bg-green-600 h-2 rounded-full" style="width: 60%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-xs text-slate-600 mb-1">
                                            <span>CPU Usage Peak</span>
                                            <span>45%</span>
                                        </div>
                                        <div class="w-full bg-slate-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: 45%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <!-- Footer Actions -->
        <footer id="footer" class="bg-white border-t border-border mt-12 sticky bottom-0 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 font-medium text-sm px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center" onclick="runAllJobs()">
                        <i class="fa-solid fa-play mr-2 text-slate-400"></i> Run All Jobs Now
                    </button>
                </div>
                <div class="flex items-center space-x-3">
                    <button class="text-slate-500 hover:text-red-600 font-medium text-sm px-4 py-2 rounded-lg hover:bg-red-50 transition-colors flex items-center" onclick="resetAllJobs()">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Reset All Jobs
                    </button>
                    <div class="h-6 w-px bg-slate-200 mx-1"></div>
                    <button class="text-red-600 hover:text-red-700 hover:bg-red-50 font-medium text-sm px-4 py-2 rounded-lg transition-colors flex items-center" onclick="disableAllJobs()">
                        <i class="fa-solid fa-stop mr-2"></i> Disable All Jobs
                    </button>
                    <div class="h-6 w-px bg-slate-200 mx-1"></div>
                    <button class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 font-medium text-sm px-5 py-2 rounded-lg shadow-sm transition-colors" onclick="cancelChanges()">
                        Cancel
                    </button>
                    <button class="bg-primary hover:bg-primaryHover text-white font-medium text-sm px-6 py-2 rounded-lg shadow-sm transition-colors flex items-center shadow-lg shadow-blue-500/30" onclick="saveAllSettings()">
                        <i class="fa-solid fa-floppy-disk mr-2"></i> Save Scheduler Settings
                    </button>
                </div>
            </div>
        </footer>
    </div> <!-- End of main content container -->

    <script>
        // ==================== APPLICATION STATE ====================
        let appState = {
            jobs: [],
            executionHistory: [],
            tags: [],
            editingJobId: null,
            unsavedChanges: false
        };

        // ==================== SIDEBAR FUNCTIONS ====================
        async function loadSidebar() {
            try {
                const response = await fetch('sidebar.html');
                if (!response.ok) {
                    throw new Error(`Failed to load sidebar: ${response.status}`);
                }
                
                const html = await response.text();
                document.getElementById('sidebar-container').innerHTML = html;
                updateActivePage();
                initializeSidebar();
                
            } catch (error) {
                console.error('Error loading sidebar:', error);
                createFallbackSidebar();
            }
        }

        function createFallbackSidebar() {
            const fallbackHTML = `
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-logo">
                        <div class="logo-text">
                            <i class="fa-solid fa-satellite-dish mr-2"></i> Innospace
                        </div>
                    </div>
                    <div class="sidebar-nav">
                        <div class="nav-section">
                            <div class="section-title">Configuration</div>
                            <a href="general-configuration.html" class="nav-item">
                                <i class="fa-solid fa-sliders"></i> General Configuration
                            </a>
                            <a href="security-access.html" class="nav-item">
                                <i class="fa-solid fa-shield-halved"></i> Security & Access
                            </a>
                            <a href="scheduler-automation.html" class="nav-item active">
                                <i class="fa-solid fa-clock"></i> Scheduler & Automation
                            </a>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="user-profile">
                            <div class="user-avatar">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h4>Admin User</h4>
                                <p>System Administrator</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-bars"></i>
                </div>
            `;
            
            document.getElementById('sidebar-container').innerHTML = fallbackHTML;
            initializeSidebar();
        }

        function updateActivePage() {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const schedulerLink = Array.from(navItems).find(item => 
                item.textContent.includes('Scheduler') || 
                item.textContent.includes('Automation')
            );
            
            if (schedulerLink) {
                schedulerLink.classList.add('active');
            }
        }

        function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (!sidebar || !sidebarToggle) return;
            
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                const icon = this.querySelector('i');
                icon.className = sidebar.classList.contains('active') ? 'fa-solid fa-times' : 'fa-solid fa-bars';
            });
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.add('active');
                sidebarToggle.style.left = '260px';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-times';
            }
            
            window.addEventListener('resize', handleResponsive);
        }

        function handleResponsive() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'block';
                sidebarToggle.style.left = '0';
                sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
            } else {
                sidebar.classList.remove('collapsed', 'active');
                sidebarToggle.style.display = 'none';
                sidebarToggle.style.left = '260px';
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadSidebar();
            initializeApp();
            setupEventListeners();
            loadInitialData();
        });

        // ==================== MODAL FUNCTIONS ====================
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ==================== TOAST NOTIFICATIONS ====================
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // ==================== JOB MANAGEMENT ====================
        function loadInitialData() {
            // Mock data
            appState.jobs = [
                {
                    id: 1,
                    name: 'Modbus Poll',
                    type: 'interval',
                    schedule: '10 seconds',
                    nextRun: '10 sec',
                    action: 'Publish Modbus Data',
                    status: 'enabled',
                    enabled: true,
                    tags: ['modbus', 'polling']
                },
                {
                    id: 2,
                    name: 'Daily Reset',
                    type: 'daily',
                    schedule: '00:00',
                    nextRun: 'Tomorrow 00:00',
                    action: 'Reset Counters',
                    status: 'enabled',
                    enabled: true,
                    tags: ['reset', 'daily']
                },
                {
                    id: 3,
                    name: 'Publish MQTT',
                    type: 'cron',
                    schedule: '15:30',
                    nextRun: 'Today 15:30',
                    action: 'Publish MQTT',
                    status: 'disabled',
                    enabled: false,
                    tags: ['mqtt', 'publish']
                },
                {
                    id: 4,
                    name: 'Health Check',
                    type: 'hourly',
                    schedule: '01:00',
                    nextRun: 'Next hour',
                    action: 'System Diagnostics',
                    status: 'enabled',
                    enabled: true,
                    tags: ['health', 'diagnostics']
                }
            ];
            
            appState.executionHistory = [
                {
                    timestamp: '2025-06-12 02:00:01',
                    job: 'Daily Export',
                    trigger: 'Scheduled',
                    duration: '14 sec',
                    status: 'success',
                    message: 'Export completed successfully'
                },
                {
                    timestamp: '2025-06-12 01:00:00',
                    job: 'Health Check',
                    trigger: 'Scheduled',
                    duration: '5 sec',
                    status: 'success',
                    message: 'All systems normal'
                },
                {
                    timestamp: '2025-06-12 00:30:00',
                    job: 'Modbus Poll',
                    trigger: 'Interval',
                    duration: '2 sec',
                    status: 'success',
                    message: 'Data collected successfully'
                },
                {
                    timestamp: '2025-06-11 23:45:00',
                    job: 'OTA Stage 1',
                    trigger: 'Scheduled',
                    duration: '57 sec',
                    status: 'failed',
                    message: 'Network timeout'
                }
            ];
            
            appState.tags = ['modbus', 'mqtt', 'export', 'cleanup', 'safety', 'diagnostics', 'polling', 'reset', 'daily', 'health'];
            
            renderJobsTable();
            renderHistoryTable();
            updateTagsDisplay();
        }

        function renderJobsTable() {
            const tbody = document.getElementById('jobTableBody');
            tbody.innerHTML = '';
            
            appState.jobs.forEach(job => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition';
                
                const typeClass = {
                    'interval': 'interval',
                    'daily': 'daily',
                    'weekly': 'weekly',
                    'monthly': 'monthly',
                    'cron': 'cron',
                    'sunrise': 'sunrise',
                    'hourly': 'interval'
                }[job.type] || 'interval';
                
                const statusBadge = job.enabled ? 
                    'bg-green-100 text-green-800' : 
                    'bg-slate-100 text-slate-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-slate-900">
                        ${job.name}
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${job.tags.map(tag => `
                                <span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded">${tag}</span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="job-type-indicator job-type-${typeClass}"></span>
                        ${job.type.charAt(0).toUpperCase() + job.type.slice(1)}
                    </td>
                    <td class="px-6 py-4 text-slate-600">${job.schedule}</td>
                    <td class="px-6 py-4 font-medium">${job.nextRun}</td>
                    <td class="px-6 py-4 text-slate-600">${job.action}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusBadge}">
                            ${job.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end space-x-2">
                            <button class="text-slate-400 hover:text-primary transition-colors" onclick="toggleJob(${job.id})" title="${job.enabled ? 'Disable' : 'Enable'}">
                                <i class="fa-solid fa-power-off ${!job.enabled ? 'text-slate-300' : ''}"></i>
                            </button>
                            <button class="text-slate-400 hover:text-primary transition-colors" onclick="editJob(${job.id})" title="Edit">
                                <i class="fa-solid fa-pen-to-square"></i>
                            </button>
                            <button class="text-slate-400 hover:text-primary transition-colors" onclick="runJobNow(${job.id})" title="Run Now">
                                <i class="fa-solid fa-play"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            appState.executionHistory.forEach(history => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50 transition';
                
                const statusColor = history.status === 'success' ? 
                    'bg-green-100 text-green-800' : 
                    'bg-red-100 text-red-800';
                
                row.innerHTML = `
                    <td class="px-6 py-4 font-mono text-sm">${history.timestamp}</td>
                    <td class="px-6 py-4 font-medium">${history.job}</td>
                    <td class="px-6 py-4 text-slate-600">${history.trigger}</td>
                    <td class="px-6 py-4">${history.duration}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${history.status.charAt(0).toUpperCase() + history.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-600">${history.message}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateTagsDisplay() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';
            
            appState.tags.forEach(tag => {
                const span = document.createElement('span');
                span.className = 'inline-flex items-center bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1';
                span.innerHTML = `
                    ${tag}
                    <button class="ml-1 text-blue-600 hover:text-blue-800" onclick="removeTag('${tag}')">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                `;
                container.appendChild(span);
            });
        }

        // ==================== JOB ACTIONS ====================
        function createNewJob() {
            appState.editingJobId = null;
            document.getElementById('modalTitle').textContent = 'Create Scheduled Job';
            document.getElementById('deleteJobBtn').style.display = 'none';
            document.getElementById('runNowBtn').style.display = 'inline-block';
            resetJobForm();
            showModal('createJobModal');
        }

        function editJob(jobId) {
            const job = appState.jobs.find(j => j.id === jobId);
            if (!job) return;
            
            appState.editingJobId = jobId;
            document.getElementById('modalTitle').textContent = 'Edit Scheduled Job';
            document.getElementById('deleteJobBtn').style.display = 'inline-block';
            document.getElementById('runNowBtn').style.display = 'inline-block';
            
            // Populate form with job data
            document.getElementById('jobName').value = job.name;
            document.getElementById('jobDescription').value = job.description || '';
            
            // Set job type
            document.querySelector(`input[name="jobType"][value="${job.type}"]`).checked = true;
            showTriggerConfig(job.type);
            
            // Set action type (default to publish)
            document.querySelector('input[name="actionType"][value="publish"]').checked = true;
            showActionConfig('publish');
            
            showModal('createJobModal');
        }

        function saveJob() {
            const jobName = document.getElementById('jobName').value.trim();
            if (!jobName) {
                showToast('Please enter a job name', 'error');
                return;
            }
            
            const jobType = document.querySelector('input[name="jobType"]:checked').value;
            const actionType = document.querySelector('input[name="actionType"]:checked').value;
            
            const jobData = {
                name: jobName,
                type: jobType,
                description: document.getElementById('jobDescription').value,
                actionType: actionType,
                enabled: true,
                tags: [...appState.tags]
            };
            
            if (appState.editingJobId) {
                // Update existing job
                const index = appState.jobs.findIndex(j => j.id === appState.editingJobId);
                if (index !== -1) {
                    appState.jobs[index] = { ...appState.jobs[index], ...jobData };
                    showToast('Job updated successfully', 'success');
                }
            } else {
                // Create new job
                const newJob = {
                    id: appState.jobs.length > 0 ? Math.max(...appState.jobs.map(j => j.id)) + 1 : 1,
                    ...jobData,
                    schedule: getScheduleDisplay(jobType),
                    nextRun: getNextRunDisplay(jobType),
                    action: getActionDisplay(actionType),
                    status: 'enabled'
                };
                appState.jobs.push(newJob);
                showToast('Job created successfully', 'success');
            }
            
            renderJobsTable();
            closeModal('createJobModal');
            markUnsavedChanges();
        }

        function deleteJob() {
            if (!appState.editingJobId) return;
            
            if (confirm('Are you sure you want to delete this job?')) {
                appState.jobs = appState.jobs.filter(j => j.id !== appState.editingJobId);
                renderJobsTable();
                closeModal('createJobModal');
                showToast('Job deleted successfully', 'success');
                markUnsavedChanges();
            }
        }

        function toggleJob(jobId) {
            const job = appState.jobs.find(j => j.id === jobId);
            if (!job) return;
            
            job.enabled = !job.enabled;
            job.status = job.enabled ? 'enabled' : 'disabled';
            renderJobsTable();
            showToast(`Job ${job.enabled ? 'enabled' : 'disabled'}`, 'success');
            markUnsavedChanges();
        }

        function runJobNow(jobId = null) {
            if (jobId) {
                const job = appState.jobs.find(j => j.id === jobId);
                if (job) {
                    showToast(`Running job: ${job.name}`, 'info');
                    // Add to execution history
                    const historyEntry = {
                        timestamp: new Date().toISOString().replace('T', ' ').substring(0, 19),
                        job: job.name,
                        trigger: 'Manual',
                        duration: '0 sec',
                        status: 'running',
                        message: 'Job started manually'
                    };
                    appState.executionHistory.unshift(historyEntry);
                    if (appState.executionHistory.length > 50) {
                        appState.executionHistory.pop();
                    }
                    renderHistoryTable();
                }
            } else {
                showToast('Running job now...', 'info');
            }
        }

        // ==================== FORM HANDLING ====================
        function resetJobForm() {
            document.getElementById('jobName').value = '';
            document.getElementById('jobDescription').value = '';
            document.querySelector('input[name="jobType"][value="daily"]').checked = true;
            document.querySelector('input[name="actionType"][value="publish"]').checked = true;
            showTriggerConfig('daily');
            showActionConfig('publish');
            appState.tags = [];
            updateTagsDisplay();
        }

        function showTriggerConfig(type) {
            // Hide all trigger configs
            document.querySelectorAll('.trigger-config').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show selected trigger config
            const configId = type + 'Config';
            const configElement = document.getElementById(configId);
            if (configElement) {
                configElement.classList.remove('hidden');
            }
        }

        function showActionConfig(type) {
            // Hide all action configs
            document.querySelectorAll('.action-config-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected action config
            const configId = type + 'Action';
            const configElement = document.getElementById(configId);
            if (configElement) {
                configElement.classList.add('active');
            }
        }

        function generateCronExpression() {
            // Simple cron generator for common patterns
            const cronExamples = [
                '0 * * * *',    // Every hour
                '0 0 * * *',    // Daily at midnight
                '0 6 * * *',    // Daily at 6 AM
                '0 9,17 * * *', // 9 AM and 5 PM daily
                '*/5 * * * *',  // Every 5 minutes
                '0 0 * * 0',    // Weekly on Sunday
            ];
            
            const randomCron = cronExamples[Math.floor(Math.random() * cronExamples.length)];
            document.getElementById('cronExpression').value = randomCron;
        }

        function addTag() {
            const tagInput = document.getElementById('newTag');
            const tag = tagInput.value.trim().toLowerCase();
            
            if (!tag) {
                showToast('Please enter a tag', 'error');
                return;
            }
            
            if (appState.tags.includes(tag)) {
                showToast('Tag already exists', 'warning');
                return;
            }
            
            appState.tags.push(tag);
            updateTagsDisplay();
            tagInput.value = '';
        }

        function removeTag(tag) {
            appState.tags = appState.tags.filter(t => t !== tag);
            updateTagsDisplay();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function getScheduleDisplay(type) {
            switch(type) {
                case 'interval': return 'Every 10 seconds';
                case 'daily': return 'Daily at 06:00';
                case 'weekly': return 'Weekly Mon,Tue,Thu at 12:30';
                case 'monthly': return 'Monthly on day 1 at 00:00';
                case 'cron': return 'Cron: 0 15 * * *';
                case 'sunrise': return 'Sunrise -30min';
                default: return 'Custom';
            }
        }

        function getNextRunDisplay(type) {
            switch(type) {
                case 'interval': return '10 seconds';
                case 'daily': return 'Tomorrow 06:00';
                case 'weekly': return 'Next Mon 12:30';
                case 'monthly': return 'Next month 1st';
                case 'cron': return 'Today 15:30';
                case 'sunrise': return 'Tomorrow sunrise';
                default: return 'Pending';
            }
        }

        function getActionDisplay(type) {
            switch(type) {
                case 'publish': return 'Publish Data';
                case 'log': return 'Log Message';
                case 'output': return 'Set Output';
                case 'rule': return 'Run Rule Engine';
                case 'file': return 'File Operation';
                case 'system': return 'System Action';
                default: return 'Custom Action';
            }
        }

        function checkConflicts() {
            // Simple conflict detection
            const conflicts = [];
            const scheduledTimes = {};
            
            appState.jobs.forEach(job => {
                if (job.enabled && job.schedule) {
                    if (scheduledTimes[job.schedule]) {
                        conflicts.push(`${job.name} conflicts with ${scheduledTimes[job.schedule]}`);
                    } else {
                        scheduledTimes[job.schedule] = job.name;
                    }
                }
            });
            
            if (conflicts.length > 0) {
                showToast(`Found ${conflicts.length} potential conflicts`, 'warning');
                // You could show these in a modal or alert
                alert('Potential conflicts detected:\n' + conflicts.join('\n'));
            } else {
                showToast('No conflicts detected', 'success');
            }
        }

        function exportJobs() {
            const exportData = {
                jobs: appState.jobs,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `scheduler-jobs-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('Jobs exported successfully', 'success');
        }

        function importJobs() {
            // In a real app, this would handle file upload
            showToast('Import feature requires file selection', 'info');
        }

        function runAllJobs() {
            if (confirm('Run all enabled jobs now?')) {
                showToast('Running all jobs...', 'info');
                appState.jobs.filter(j => j.enabled).forEach(job => {
                    runJobNow(job.id);
                });
            }
        }

        function resetAllJobs() {
            if (confirm('Reset all jobs to default settings?')) {
                showToast('All jobs reset', 'info');
                // In real app, this would reset to defaults
            }
        }

        function disableAllJobs() {
            if (confirm('Disable all scheduled jobs?')) {
                appState.jobs.forEach(job => {
                    job.enabled = false;
                    job.status = 'disabled';
                });
                renderJobsTable();
                showToast('All jobs disabled', 'success');
                markUnsavedChanges();
            }
        }

        function saveAllSettings() {
            // Show saving indicator
            const saveBtn = document.getElementById('header-save-btn');
            const footerSaveBtn = document.querySelector('#footer button:last-child');
            const originalText = saveBtn.innerHTML;
            const originalFooterText = footerSaveBtn.innerHTML;
            
            saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...';
            footerSaveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...';
            saveBtn.disabled = true;
            footerSaveBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                footerSaveBtn.innerHTML = originalFooterText;
                saveBtn.disabled = false;
                footerSaveBtn.disabled = false;
                
                appState.unsavedChanges = false;
                showToast('All scheduler settings saved successfully', 'success');
                
                // Update save buttons
                saveBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                footerSaveBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            }, 1500);
        }

        function cancelChanges() {
            if (appState.unsavedChanges) {
                if (confirm('Discard all unsaved scheduler changes?')) {
                    window.location.reload();
                }
            } else {
                window.location.reload();
            }
        }

        function showHelp() {
            showToast('Opening scheduler documentation...', 'info');
        }

        function markUnsavedChanges() {
            appState.unsavedChanges = true;
            
            // Update save buttons
            const saveBtn = document.getElementById('header-save-btn');
            const footerSaveBtn = document.querySelector('#footer button:last-child');
            
            if (saveBtn && !saveBtn.disabled) {
                saveBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
                footerSaveBtn.classList.add('bg-orange-500', 'hover:bg-orange-600');
            }
        }

        // ==================== EVENT LISTENERS ====================
        function initializeApp() {
            // Job type change listener
            document.querySelectorAll('input[name="jobType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    showTriggerConfig(this.value);
                });
            });
            
            // Action type change listener
            document.querySelectorAll('input[name="actionType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    showActionConfig(this.value);
                });
            });
            
            // Form change listeners
            document.querySelectorAll('#createJobModal input, #createJobModal select, #createJobModal textarea').forEach(element => {
                element.addEventListener('change', markUnsavedChanges);
            });
        }

        function setupEventListeners() {
            // Gateway select
            const gatewaySelect = document.getElementById('gateway-select');
            if (gatewaySelect) {
                gatewaySelect.addEventListener('change', function() {
                    if (appState.unsavedChanges) {
                        if (confirm('Switch to another gateway? Unsaved scheduler changes will be lost.')) {
                            window.location.reload();
                        } else {
                            this.value = 'Univa-GW-01';
                        }
                    } else {
                        window.location.reload();
                    }
                });
            }
            
            // Add click outside handler for sidebar
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const sidebarToggle = document.getElementById('sidebarToggle');
                const isMobile = window.innerWidth <= 1024;
                
                if (isMobile && sidebar.classList.contains('active')) {
                    const isClickInsideSidebar = sidebar.contains(event.target);
                    const isClickOnToggle = sidebarToggle.contains(event.target);
                    
                    if (!isClickInsideSidebar && !isClickOnToggle) {
                        sidebar.classList.remove('active');
                        sidebarToggle.querySelector('i').className = 'fa-solid fa-bars';
                        sidebarToggle.style.left = '0';
                    }
                }
            });
            
            // Initial responsive setup
            setTimeout(() => {
                handleResponsive();
            }, 100);
        }
    </script>
</body>
</html>